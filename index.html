<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Pazuzu's Wards</title>
<meta name="theme-color" content="#0A0A0F">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icons/icon-192.svg">
<link rel="apple-touch-icon" href="icons/icon-192.svg">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --pri:#D4A853;--pri-glow:rgba(212,168,83,0.20);--pri-dim:#8B7035;
  --acc:#4ECDC4;--acc-glow:rgba(78,205,196,0.15);
  --ok:#7BC67E;--warn:#E8B84B;--bad:#C75B5B;
  --bg:#0A0A0F;--card:#12121E;--card2:#1A1A2A;--input:#161625;
  --txt:#E8E4D9;--txt2:#9B9685;--txt3:#5A564A;
  --brd:#2A2A3A;--glow-gold:0 0 20px rgba(212,168,83,0.15);
  --r:8px;--r2:12px;--r3:16px;
  --font-d:'Cinzel',serif;--font-b:'DM Sans',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:var(--font-b);
  font-size:15px;line-height:1.5;-webkit-tap-highlight-color:transparent;overscroll-behavior:none}
body{display:flex;flex-direction:column;max-width:430px;margin:0 auto;position:relative}
h1,h2,h3{font-family:var(--font-d);font-weight:600;color:var(--pri);letter-spacing:0.02em}
h1{font-size:1.4rem}h2{font-size:1.15rem}h3{font-size:1rem}
.label{font-size:0.75rem;color:var(--txt2);text-transform:uppercase;letter-spacing:0.08em;font-weight:600}
.tab-panel{display:none;flex:1;overflow-y:auto;padding:16px 16px 100px;-webkit-overflow-scrolling:touch}
.tab-panel.active{display:block}
.bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;
  display:flex;background:var(--card);border-top:1px solid var(--brd);padding:6px 0 env(safe-area-inset-bottom,8px);z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px;
  background:none;border:none;color:var(--txt3);font-family:var(--font-b);font-size:0.65rem;
  cursor:pointer;min-height:44px}.nav-btn svg{width:22px;height:22px;fill:currentColor}
.nav-btn.active{color:var(--pri)}.nav-btn:active{opacity:0.7}
.card{background:var(--card);border:1px solid var(--brd);border-radius:var(--r2);padding:16px;margin-bottom:12px}
.card h3{margin-bottom:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;
  border-radius:var(--r);border:none;font-family:var(--font-b);font-weight:600;font-size:0.9rem;
  cursor:pointer;min-height:44px;min-width:44px;transition:transform 0.1s}
.btn:active{transform:scale(0.96)}
.btn-pri{background:var(--pri);color:var(--bg)}.btn-sec{background:var(--card2);color:var(--txt);border:1px solid var(--brd)}
.btn-ok{background:var(--ok);color:var(--bg)}.btn-bad{background:var(--bad);color:#fff}
.btn-ghost{background:transparent;color:var(--pri);border:1px solid var(--pri-dim)}
.btn-block{width:100%}.btn-lg{padding:16px 32px;font-size:1.05rem;border-radius:var(--r2)}
.btn-sm{padding:8px 16px;font-size:0.8rem;min-height:36px}
select,input,textarea{background:var(--input);color:var(--txt);border:1px solid var(--brd);
  border-radius:var(--r);padding:10px 12px;font-family:var(--font-b);font-size:0.9rem;width:100%}
select:focus,input:focus,textarea:focus{outline:none;border-color:var(--pri-dim)}
textarea{resize:vertical;min-height:60px}
.form-group{margin-bottom:14px}.form-group label{display:block;margin-bottom:4px;font-size:0.8rem;color:var(--txt2);font-weight:500}
.chip-group{display:flex;flex-wrap:wrap;gap:8px}
.chip{padding:8px 14px;border-radius:20px;background:var(--card2);border:1px solid var(--brd);
  color:var(--txt2);font-size:0.8rem;cursor:pointer;min-height:36px;display:flex;align-items:center}
.chip.active{background:var(--pri);color:var(--bg);border-color:var(--pri)}.chip:active{opacity:0.8}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;
  align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal-sheet{background:var(--card);border-radius:var(--r3) var(--r3) 0 0;width:100%;max-width:430px;
  max-height:85vh;overflow-y:auto;padding:20px;animation:slideUp 0.3s ease}
.modal-sheet .modal-handle{width:40px;height:4px;background:var(--txt3);border-radius:2px;margin:0 auto 16px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-close{background:none;border:none;color:var(--txt3);font-size:1.5rem;cursor:pointer;
  padding:8px;min-height:44px;min-width:44px;display:flex;align-items:center;justify-content:center}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.toast-container{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:300;
  width:90%;max-width:400px;pointer-events:none}
.toast{background:var(--card2);border:1px solid var(--pri-dim);color:var(--pri);padding:12px 16px;
  border-radius:var(--r);text-align:center;font-size:0.85rem;font-family:var(--font-d);
  animation:toastIn 0.3s ease,toastOut 0.3s ease 2.7s forwards;margin-bottom:8px}
@keyframes toastIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0}}
.alone-pill{position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:150;
  background:var(--card);border:1px solid var(--bad);border-radius:24px;padding:8px 18px;
  display:none;align-items:center;gap:10px;cursor:pointer;font-size:0.85rem;color:var(--txt);
  box-shadow:0 4px 20px rgba(0,0,0,0.5)}
.alone-pill.active{display:flex}
.alone-pill .dot{width:8px;height:8px;border-radius:50%;background:var(--bad);animation:pulse 1.5s infinite}
.alone-pill .timer-display{font-variant-numeric:tabular-nums;font-weight:600}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.tree-container{width:100%;overflow-y:auto;padding:8px 0}
.tree-svg{display:block;margin:0 auto}
.tree-line{stroke:var(--brd);stroke-width:2;stroke-dasharray:4,4}
.tree-line.active{stroke:var(--pri-dim);stroke-dasharray:none}
.tree-line.sealed{stroke:var(--pri);stroke-dasharray:none}
.tree-node{cursor:pointer}
.tree-node circle.node-bg{stroke-width:2;transition:all 0.3s}
.tree-node text{font-family:var(--font-d);font-size:10px;fill:var(--txt);font-weight:700;pointer-events:none;text-anchor:middle;dominant-baseline:central}
.tree-node.locked circle.node-bg{fill:var(--card);stroke:var(--txt3)}
.tree-node.locked text{fill:var(--txt3)}
.tree-node.available circle.node-bg{fill:var(--card2);stroke:var(--pri)}
.tree-node.in-progress circle.node-bg{fill:var(--pri-dim);stroke:var(--pri)}
.tree-node.sealed circle.node-bg{fill:var(--pri);stroke:var(--pri)}
.tree-node.sealed text{fill:var(--bg)}
.pulse-ring{fill:none;stroke:var(--pri);opacity:0.4;animation:nodePulse 2s infinite}
@keyframes nodePulse{0%,100%{opacity:0.2;stroke-width:2}50%{opacity:0.5;stroke-width:4}}
.progress-arc{fill:none;stroke:var(--acc);stroke-width:3;stroke-linecap:round}
.countdown-overlay{position:fixed;inset:0;background:var(--bg);z-index:250;display:none;
  align-items:center;justify-content:center;font-family:var(--font-d);font-size:5rem;color:var(--pri)}
.countdown-overlay.active{display:flex}
.countdown-overlay span{animation:countPop 0.7s ease}
@keyframes countPop{0%{transform:scale(2);opacity:0}30%{transform:scale(1);opacity:1}100%{opacity:1}}
.session-timer{font-family:var(--font-d);font-size:2.5rem;color:var(--pri);text-align:center;
  font-variant-numeric:tabular-nums;padding:16px 0}
.session-timer.flash{animation:timerFlash 0.5s ease 3}
@keyframes timerFlash{0%,100%{color:var(--pri)}50%{color:var(--acc)}}
.capture-area{display:flex;gap:16px;justify-content:center;padding:20px 0;flex-wrap:wrap}
.capture-btn{width:100px;height:100px;border-radius:50%;border:3px solid;font-family:var(--font-d);
  font-size:0.7rem;font-weight:700;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:4px;cursor:pointer;transition:transform 0.1s}
.capture-btn:active{transform:scale(0.92)}
.capture-btn.success{background:rgba(123,198,126,0.15);border-color:var(--ok);color:var(--ok)}
.capture-btn.miss{background:rgba(199,91,91,0.15);border-color:var(--bad);color:var(--bad)}
.capture-btn.observe{background:rgba(78,205,196,0.15);border-color:var(--acc);color:var(--acc);width:120px;height:120px;font-size:0.8rem}
.capture-btn .count{font-size:1.5rem;font-family:var(--font-b)}
.session-stats{display:flex;justify-content:center;gap:24px;padding:8px 0;color:var(--txt2);font-size:0.85rem}
.session-stats span{display:flex;flex-direction:column;align-items:center}
.session-stats .val{font-size:1.1rem;font-weight:600;color:var(--txt)}
.guidance-box{background:var(--card2);border:1px solid var(--brd);border-radius:var(--r);padding:12px;
  margin:12px 0;font-size:0.8rem;color:var(--txt2);display:flex;flex-direction:column;gap:6px}
.guidance-box .g-item{display:flex;gap:8px;align-items:start}
.guidance-box .g-label{color:var(--acc);font-weight:600;min-width:40px;font-size:0.7rem;text-transform:uppercase}
.hold-btn{width:140px;height:140px;border-radius:50%;border:3px solid var(--acc);
  background:rgba(78,205,196,0.1);color:var(--acc);font-family:var(--font-d);font-size:1rem;
  font-weight:700;cursor:pointer;display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:4px;transition:all 0.2s;margin:0 auto}
.hold-btn.holding{border-color:var(--pri);background:rgba(212,168,83,0.15);color:var(--pri);
  animation:holdPulse 1s infinite}
@keyframes holdPulse{0%,100%{box-shadow:0 0 0 0 rgba(212,168,83,0.3)}50%{box-shadow:0 0 0 15px rgba(212,168,83,0)}}
.heatmap{display:flex;gap:3px;overflow-x:auto;padding:8px 0}
.heatmap-week{display:flex;flex-direction:column;gap:3px}
.heatmap-cell{width:14px;height:14px;border-radius:2px;background:var(--card2)}
.heatmap-cell.l1{background:rgba(212,168,83,0.2)}.heatmap-cell.l2{background:rgba(212,168,83,0.4)}
.heatmap-cell.l3{background:rgba(212,168,83,0.6)}.heatmap-cell.l4{background:rgba(212,168,83,0.9)}
.ward-progress{display:flex;align-items:center;gap:10px;padding:8px 0}
.ward-progress .abbr{width:28px;height:28px;border-radius:50%;background:var(--card2);
  border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;
  font-family:var(--font-d);font-size:0.6rem;font-weight:700;color:var(--txt2);flex-shrink:0}
.ward-progress .abbr.sealed{background:var(--pri);color:var(--bg);border-color:var(--pri)}
.ward-progress .bar-track{flex:1;height:6px;background:var(--card2);border-radius:3px;overflow:hidden}
.ward-progress .bar-fill{height:100%;background:var(--pri);border-radius:3px;transition:width 0.3s}
.ward-progress .step-text{font-size:0.75rem;color:var(--txt2);min-width:40px;text-align:right}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
.action-card{background:var(--card);border:1px solid var(--brd);border-radius:var(--r2);
  padding:14px;cursor:pointer;text-align:center;min-height:44px;display:flex;flex-direction:column;
  align-items:center;gap:6px}.action-card:active{background:var(--card2)}
.action-card .ac-icon{font-size:0.8rem;color:var(--acc);font-weight:600}
.action-card .ac-label{font-size:0.8rem;color:var(--txt)}
.action-card .ac-sub{font-size:0.7rem;color:var(--txt3)}
.vigil-display{text-align:center;padding:16px 0}
.vigil-number{font-family:var(--font-d);font-size:2.5rem;color:var(--pri);font-weight:700}
.vigil-label{font-size:0.8rem;color:var(--txt2)}
.step-list{list-style:none}
.step-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--brd)}
.step-item:last-child{border-bottom:none}
.step-num{width:28px;height:28px;border-radius:50%;border:2px solid var(--brd);display:flex;
  align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;flex-shrink:0;
  color:var(--txt3);font-family:var(--font-d)}
.step-item.done .step-num{background:var(--pri);border-color:var(--pri);color:var(--bg)}
.step-item.current .step-num{border-color:var(--pri);color:var(--pri)}
.step-info{flex:1}.step-info .step-title{font-weight:600;font-size:0.85rem}
.step-info .step-desc{font-size:0.78rem;color:var(--txt2);margin-top:2px}
.step-item.future{opacity:0.5}
.step-item:active{background:var(--card2);border-radius:var(--r)}
.inscription{display:flex;gap:12px;align-items:center;padding:10px 0;border-bottom:1px solid var(--brd)}
.inscription .ins-icon{width:32px;height:32px;border-radius:50%;background:var(--pri-glow);
  border:1px solid var(--pri-dim);display:flex;align-items:center;justify-content:center;
  font-family:var(--font-d);font-size:0.65rem;color:var(--pri);font-weight:700}
.inscription .ins-text{font-family:var(--font-d);font-size:0.85rem;color:var(--pri)}
.inscription .ins-date{font-size:0.7rem;color:var(--txt3)}
.dur-chips{display:flex;gap:8px;justify-content:center;margin:12px 0}
.dur-chip{padding:10px 18px;border-radius:var(--r);background:var(--card2);border:1px solid var(--brd);
  color:var(--txt2);font-size:0.85rem;cursor:pointer;min-height:44px;display:flex;align-items:center}
.dur-chip.active{background:var(--pri);color:var(--bg);border-color:var(--pri)}.dur-chip:active{opacity:0.8}
.profile-frame{width:80px;height:80px;border-radius:50%;border:2px solid var(--pri);
  display:flex;align-items:center;justify-content:center;margin:0 auto 8px;
  background:var(--card);box-shadow:var(--glow-gold)}
.profile-frame svg{width:48px;height:48px;fill:var(--pri)}
.profile-stats{display:flex;justify-content:center;gap:24px;margin:12px 0}
.profile-stats .stat{text-align:center}
.profile-stats .stat-val{font-size:1.2rem;font-weight:700;color:var(--pri);font-family:var(--font-d)}
.profile-stats .stat-lbl{font-size:0.7rem;color:var(--txt2)}
.rite-list{display:flex;flex-direction:column;gap:6px}
.rite-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--card2);
  border-radius:var(--r);cursor:pointer;min-height:44px}
.rite-item:active{background:var(--input)}
.rite-item .rite-abbr{width:32px;height:32px;border-radius:50%;background:var(--card);
  border:1px solid var(--pri-dim);display:flex;align-items:center;justify-content:center;
  font-family:var(--font-d);font-size:0.65rem;font-weight:700;color:var(--pri)}
.rite-item .rite-name{font-size:0.85rem;flex:1}.rite-item .rite-step{font-size:0.7rem;color:var(--txt2)}
.history-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd)}
.history-item .h-abbr{width:32px;height:32px;border-radius:50%;background:var(--card2);
  border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;
  font-family:var(--font-d);font-size:0.6rem;font-weight:700;color:var(--txt2);flex-shrink:0}
.history-item .h-info{flex:1}.history-item .h-title{font-size:0.85rem;font-weight:500}
.history-item .h-detail{font-size:0.75rem;color:var(--txt2)}
.history-item .h-date{font-size:0.7rem;color:var(--txt3)}
.divider{height:1px;background:var(--brd);margin:16px 0}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.empty-state{text-align:center;padding:40px 20px;color:var(--txt3);font-size:0.9rem}
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600}
.badge-ok{background:rgba(123,198,126,0.15);color:var(--ok)}
.badge-warn{background:rgba(232,184,75,0.15);color:var(--warn)}
.text-pri{color:var(--pri)}.text-acc{color:var(--acc)}.text-ok{color:var(--ok)}.text-dim{color:var(--txt2)}
.text-center{text-align:center}.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mb-8{margin-bottom:8px}
.sep-chart svg{width:100%;height:100%}
.body-chip-grid{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
.body-chip{padding:6px 10px;border-radius:16px;background:var(--card2);border:1px solid var(--brd);
  color:var(--txt2);font-size:0.75rem;cursor:pointer;min-height:32px;display:flex;align-items:center}
.body-chip.active{background:var(--bad);color:#fff;border-color:var(--bad)}
.shrine-profile{display:flex;align-items:center;gap:14px;padding:8px 0}
.shrine-portrait{width:56px;height:56px;border-radius:50%;border:2px solid var(--pri);
  display:flex;align-items:center;justify-content:center;background:var(--card);
  box-shadow:var(--glow-gold);flex-shrink:0}
.shrine-portrait svg{width:36px;height:36px}
.shrine-info{flex:1}
.shrine-info h1{font-size:1.2rem;margin:0}
.shrine-info .shrine-sub{font-size:0.75rem;color:var(--txt2);margin-top:2px}
.shrine-stats{display:flex;gap:16px;justify-content:center;margin:8px 0}
.shrine-stats .ss{text-align:center}
.shrine-stats .sv{font-size:1.1rem;font-weight:700;color:var(--pri);font-family:var(--font-d);display:block}
.shrine-stats .sl{font-size:0.65rem;color:var(--txt2)}
.gear-btn{background:none;border:none;color:var(--txt3);cursor:pointer;padding:8px;min-height:44px;min-width:44px;display:flex;align-items:center;justify-content:center;position:absolute;top:12px;right:8px}
.gear-btn:active{color:var(--pri)}
.quick-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:8px 0}
.quick-btn{display:flex;align-items:center;justify-content:center;padding:10px 4px;border-radius:var(--r);
  border:1px solid var(--brd);background:var(--card);color:var(--txt2);font-family:var(--font-b);
  font-size:0.75rem;font-weight:600;cursor:pointer;min-height:40px;transition:transform 0.1s}
.quick-btn:active{background:var(--card2);transform:scale(0.95)}
.quick-btn.cat-routine{border-color:var(--pri-dim);color:var(--pri)}
.quick-btn.cat-care{border-color:rgba(78,205,196,0.3);color:var(--acc)}
.quick-btn.cat-alert{border-color:rgba(199,91,91,0.3);color:var(--bad)}
.quick-btn.cat-note{border-color:rgba(232,184,75,0.3);color:var(--warn)}
.alone-shrine{background:rgba(199,91,91,0.1);border:1px solid var(--bad);border-radius:var(--r2);
  padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:12px}
.alone-shrine .as-time{font-family:var(--font-d);font-size:1.8rem;color:var(--bad);font-weight:700;
  font-variant-numeric:tabular-nums;flex:1}
.alone-shrine .as-dot{width:10px;height:10px;border-radius:50%;background:var(--bad);animation:pulse 1.5s infinite;flex-shrink:0}
.cap-row{display:flex;gap:10px;margin:8px 0;width:100%}
.cap-wide{flex:1;padding:16px;border-radius:var(--r2);border:2px solid;font-family:var(--font-d);
  font-weight:700;font-size:0.85rem;cursor:pointer;display:flex;flex-direction:column;align-items:center;
  gap:4px;min-height:70px;justify-content:center;background:none;transition:transform 0.1s}
.cap-wide:active{transform:scale(0.96)}
.cap-wide.success{background:rgba(123,198,126,0.1);border-color:var(--ok);color:var(--ok)}
.cap-wide.miss{background:rgba(199,91,91,0.1);border-color:var(--bad);color:var(--bad)}
.cap-wide.observe{background:rgba(78,205,196,0.1);border-color:var(--acc);color:var(--acc)}
.cap-wide .count{font-size:1.5rem;font-family:var(--font-b)}
.undo-btn{background:none;border:1px solid var(--brd);color:var(--txt3);padding:6px 16px;border-radius:var(--r);
  font-size:0.75rem;cursor:pointer;min-height:36px;font-family:var(--font-b)}
.undo-btn:active{background:var(--card2)}
.timeline-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;padding:4px 0}
.timeline-toggle svg{width:16px;height:16px;fill:var(--txt3);transition:transform 0.2s;flex-shrink:0}
.timeline-toggle.open svg{transform:rotate(90deg)}
</style>
</head>
<body>

<div class="alone-pill" id="alonePill" onclick="openAloneForm()">
  <span class="dot"></span><span>Alone</span>
  <span class="timer-display" id="alonePillTime">0:00</span>
</div>

<div class="tab-panel active" id="tab-shrine"></div>
<div class="tab-panel" id="tab-wardtree"></div>
<div class="tab-panel" id="tab-ritual"></div>
<div class="tab-panel" id="tab-chronicle"></div>
<div class="tab-panel" id="tab-chronicles"></div>

<nav class="bottom-nav">
  <button class="nav-btn active" data-tab="shrine" onclick="switchTab('shrine')">
    <svg viewBox="0 0 24 24"><path d="M3 21h18v-2H3v2zm2-4h14v-2H5v2zm2-4h10v-2H7v2zm3-4h4V7h-4v2z"/></svg>
    <span>Shrine</span></button>
  <button class="nav-btn" data-tab="wardtree" onclick="switchTab('wardtree')">
    <svg viewBox="0 0 24 24"><path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3z"/></svg>
    <span>Wards</span></button>
  <button class="nav-btn" data-tab="ritual" onclick="switchTab('ritual')">
    <svg viewBox="0 0 24 24"><path d="M12 2c-1 6-7 8-7 13a7 7 0 0014 0c0-5-6-7-7-13z"/></svg>
    <span>Ritual</span></button>
  <button class="nav-btn" data-tab="chronicle" onclick="switchTab('chronicle')">
    <svg viewBox="0 0 24 24"><path d="M6 2a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H6zm2 4h8v2H8V6zm0 4h8v2H8v-2zm0 4h5v2H8v-2z"/></svg>
    <span>Chronicle</span></button>
  <button class="nav-btn" data-tab="chronicles" onclick="switchTab('chronicles')">
    <svg viewBox="0 0 24 24"><path d="M3 20h2v-8H3v8zm4 0h2V10H7v10zm4 0h2V4h-2v16zm4 0h2v-12h-2v12zm4 0h2v-6h-2v6z"/></svg>
    <span>Chronicles</span></button>
</nav>

<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal-sheet" id="modalContent"></div>
</div>
<div class="toast-container" id="toasts"></div>
<div class="countdown-overlay" id="countdown"></div>

<script>
// === WARD DATABASE ===
const WARDS=[
{id:'attention',name:'Attention Ward',abbr:'AT',phase:1,prereqs:[],
desc:'Teaching Zuzu to offer eye contact voluntarily — the foundation of all communication.',
steps:[
{t:'Capture Eye Contact',d:'Wait for Zuzu to glance at your eyes. Mark and treat instantly. No cue yet.',
guidance:{vocal:'Mark with "yes" the instant eyes meet yours',hand:'Hands still — no luring',position:'Facing Zuzu, relaxed posture'},
capture:{type:'observe',successLabel:'Looked',missLabel:null,notes_prompt:'How quickly did she offer eye contact?'}},
{t:'Build Duration',d:'Gradually wait for longer eye contact before marking. Start 1s, build to 3s.',
guidance:{vocal:'Delay "yes" marker slightly each session',hand:'No hand motion',position:'Facing, 2-3 feet away'},
capture:{type:'duration',successLabel:'Held gaze',missLabel:'Broke early',notes_prompt:'Longest duration held?'}},
{t:'Mild Distractions',d:'Practice with a toy on floor or person nearby. Mark eye contact despite distractions.',
guidance:{vocal:'"Yes" when she chooses you over distraction',hand:'None — let her choose',position:'Near distraction source'},
capture:{type:'reps',successLabel:'Chose me',missLabel:'Distracted',notes_prompt:'What distractions present?'}},
{t:'Add Verbal Cue',d:'Say "watch me" just BEFORE she looks. Pair the word with the behavior.',
guidance:{vocal:'"Watch me" then she looks then "yes" then treat',hand:'Brief point to eyes if needed, then fade',position:'Facing, various distances'},
capture:{type:'reps',successLabel:'Responded to cue',missLabel:'No response',notes_prompt:'Response latency?'}},
{t:'Proof Everywhere',d:'Practice in different rooms, outdoors on leash, near other dogs. Accept shorter duration in new places.',
guidance:{vocal:'"Watch me" cue',hand:'None needed',position:'Various new environments'},
capture:{type:'reps',successLabel:'Responded',missLabel:'Too distracted',notes_prompt:'Environment? Distance from distractions?'}}]},
{id:'interrupter',name:'Positive Interrupter',abbr:'PI',phase:1,prereqs:[],
desc:'A special sound that means "stop what you\'re doing and come get something amazing."',
steps:[
{t:'Charge the Sound',d:'Make your chosen sound then immediately give HIGH-VALUE treat. Repeat 15-20 times.',
guidance:{vocal:'Kissy noise then immediate treat',hand:'Deliver treat directly after sound',position:'Any — Zuzu can be doing anything'},
capture:{type:'observe',successLabel:'Pair completed',missLabel:null,notes_prompt:'What sound? How many pairings?'}},
{t:'Test Response',d:'When mildly distracted, make the sound. She should whip her head toward you.',
guidance:{vocal:'Interrupter sound when mildly distracted',hand:'Treat ready in hand',position:'Within a few feet'},
capture:{type:'reps',successLabel:'Head whip',missLabel:'No response',notes_prompt:'Response speed?'}},
{t:'Use with Distractions',d:'Practice when sniffing, looking away. Never use when over threshold.',
guidance:{vocal:'Interrupter then "yes" then jackpot treat',hand:'None',position:'Various distances'},
capture:{type:'reps',successLabel:'Interrupted',missLabel:'Over threshold',notes_prompt:'Distraction level?'}},
{t:'Increase Difficulty',d:'Use around more interesting distractions. Always reward generously. Never overuse.',
guidance:{vocal:'Same sound — must ALWAYS predict amazing reward',hand:'Jackpot treats',position:'Real-world scenarios'},
capture:{type:'reps',successLabel:'Jackpot response',missLabel:'Weak/no response',notes_prompt:'Hardest distraction?'}}]},
{id:'nomugging',name:'Impulse Control',abbr:'IC',phase:1,prereqs:[],
desc:'Teaching Zuzu that self-control earns rewards — It\'s Yer Choice.',
steps:[
{t:'Closed Fist',d:'Hold treat in closed fist. Wait. Mark and treat from OTHER hand when she backs off.',
guidance:{vocal:'"Yes" when she backs off',hand:'Closed fist — reward from OTHER hand',position:'Sitting in front'},
capture:{type:'reps',successLabel:'Backed off',missLabel:'Still mugging',notes_prompt:'Time before first back-off?'}},
{t:'Open Hand',d:'Open hand with treat near floor. Cover if she lunges. Reward disengage from other hand.',
guidance:{vocal:'"Yes" on disengage',hand:'Open palm — cover if she goes for it',position:'Hand low, kneeling'},
capture:{type:'reps',successLabel:'Showed restraint',missLabel:'Went for it',notes_prompt:'Duration before covering?'}},
{t:'Treat on Floor',d:'Place treat on floor, cover if she goes for it. Reward restraint from other hand.',
guidance:{vocal:'"Yes" when she chooses not to take it',hand:'Ready to cover — reward from other hand',position:'Kneeling beside treat'},
capture:{type:'reps',successLabel:'Left it',missLabel:'Grabbed it',notes_prompt:'Covered or uncovered?'}},
{t:'Around Food',d:'Build restraint around visible food. Practice near plate, tables, food prep.',
guidance:{vocal:'"Yes" for ignoring food',hand:'Treat ready as reward',position:'Near real food situations'},
capture:{type:'reps',successLabel:'Ignored food',missLabel:'Went for it',notes_prompt:'What food? How close?'}}]},
{id:'calmness',name:'Capturing Calmness',abbr:'CC',phase:1,prereqs:[],
desc:'Rewarding calm states throughout the day — Zuzu learns relaxation pays.',
steps:[
{t:'Reward Calm Moments',d:'When Zuzu naturally settles, gently mark and toss treat. No cue, no prompting.',
guidance:{vocal:'Quiet, calm "yes"',hand:'Gently toss or place treat',position:'Wherever she settles'},
capture:{type:'observe',successLabel:'Calm captured',missLabel:null,notes_prompt:'Where did she settle?'}},
{t:'On a Mat',d:'When she settles on bed or mat, reward. Build to multiple treats while settled.',
guidance:{vocal:'Very quiet marker or none',hand:'Slow, calm treat delivery',position:'Near her mat'},
capture:{type:'duration',successLabel:'Settled on mat',missLabel:'Got up',notes_prompt:'Duration on mat?'}},
{t:'Build Duration',d:'Space out rewards while relaxed on mat. No correction if she gets up.',
guidance:{vocal:'Minimal — quiet presence',hand:'Increasingly spaced treats',position:'Gradually increase distance'},
capture:{type:'duration',successLabel:'Stayed settled',missLabel:'Got up',notes_prompt:'Longest duration between treats?'}},
{t:'Exciting Contexts',d:'Mat settling during visitors, new rooms, activity. Lower criteria in harder contexts.',
guidance:{vocal:'Calm marker when she chooses mat',hand:'Higher value treats in harder contexts',position:'Mat in exciting environments'},
capture:{type:'reps',successLabel:'Settled despite activity',missLabel:'Too excited',notes_prompt:'What was happening?'}}]},
{id:'crate',name:'Crate Training',abbr:'CR',phase:1,prereqs:[],
desc:'Making the crate a safe den — never punishment. Zuzu should walk in voluntarily.',
steps:[
{t:'Crate Discovery',d:'Toss treats near and into crate. Door stays OPEN. No luring or pushing.',
guidance:{vocal:'None — let curiosity drive',hand:'Toss treats near, then inside',position:'Sitting near crate'},
capture:{type:'observe',successLabel:'Approached/entered',missLabel:null,notes_prompt:'How close? Body language?'}},
{t:'Meals Inside',d:'Feed meals inside crate with door open. Place bowl progressively further inside.',
guidance:{vocal:'None',hand:'Place food bowl further inside',position:'Near crate, not blocking exit'},
capture:{type:'observe',successLabel:'Ate inside crate',missLabel:null,notes_prompt:'How far inside?'}},
{t:'Brief Door Closure',d:'While eating, gently close door. Open BEFORE she finishes. Stay nearby.',
guidance:{vocal:'None — calm presence',hand:'Close gently, treat through bars',position:'Right next to crate'},
capture:{type:'duration',successLabel:'Calm with door closed',missLabel:'Stressed',notes_prompt:'Duration closed?'}},
{t:'Short Separations',d:'Close door, step away 10s, return calmly, treat, open. Build slowly.',
guidance:{vocal:'Calm "good girl" through bars',hand:'Treat through bars on return',position:'Step away, then out of sight'},
capture:{type:'duration',successLabel:'Calm while away',missLabel:'Distressed',notes_prompt:'Duration away?'}},
{t:'Extended Duration',d:'Build to 30+ min in another room. Leave enrichment. Keep arrivals boring.',
guidance:{vocal:'Low-key goodbye and hello',hand:'Provide enrichment item',position:'Out of sight'},
capture:{type:'duration',successLabel:'Settled full duration',missLabel:'Stressed',notes_prompt:'Minutes? Enrichment used?'}}]},
{id:'house',name:'House Training',abbr:'HT',phase:1,prereqs:[],
desc:'Building a reliable potty routine with reward-based outdoor elimination.',
steps:[
{t:'Frequent Outings',d:'Take out every 1-2h, after meals/naps/play. Same spot. Mark and treat party.',
guidance:{vocal:'"Yes! Good girl!" — big celebration',hand:'Treat party — multiple treats',position:'Same potty spot'},
capture:{type:'observe',successLabel:'Went outside',missLabel:null,notes_prompt:'Time since last outing?'}},
{t:'Learn Her Signals',d:'Watch for sniffing, circling, going to door. Take out immediately.',
guidance:{vocal:'Praise outdoor success',hand:'Treat every success',position:'Observing from nearby'},
capture:{type:'reps',successLabel:'Signalled + success',missLabel:'Accident',notes_prompt:'What signal?'}},
{t:'Extend Intervals',d:'Gradually increase time between outings. No punishment for accidents.',
guidance:{vocal:'Continue praising',hand:'Continue treating',position:'Normal routine'},
capture:{type:'reps',successLabel:'Held it',missLabel:'Accident',notes_prompt:'Hours between outings?'}},
{t:'Full Freedom',d:'Gradually give access to more rooms. Occasional treats for going outside.',
guidance:{vocal:'Intermittent praise',hand:'Occasional treat',position:'Full house access'},
capture:{type:'observe',successLabel:'Reliable day',missLabel:null,notes_prompt:'Days since accident?'}}]},
{id:'mouthing',name:'Gentle Mouth',abbr:'GM',phase:1,prereqs:[],
desc:'Teaching Zuzu that teeth on skin = all fun stops. Redirect to toys, reward gentle interaction.',
steps:[
{t:'Redirect to Toy',d:'When mouthing starts, calmly offer a toy instead. Mark and praise when she takes the toy.',
guidance:{vocal:'Calm "here" while offering toy',hand:'Present toy near mouth',position:'Beside her, relaxed'},
capture:{type:'reps',successLabel:'Took toy',missLabel:'Kept mouthing',notes_prompt:'What triggered mouthing?'}},
{t:'Reverse Timeout',d:'If teeth touch skin, immediately stand up and withdraw all attention for 5-10s. Resume calmly.',
guidance:{vocal:'No sound — just withdraw',hand:'Hands away, stand up',position:'Turn away or step behind gate'},
capture:{type:'reps',successLabel:'Stopped on withdraw',missLabel:'Followed/continued',notes_prompt:'How long to calm?'}},
{t:'Reward Gentle Contact',d:'When she interacts with hands gently (licking, sniffing), mark and treat. Build association: gentle = attention continues.',
guidance:{vocal:'Soft "yes" for gentle contact',hand:'Offer back of hand, treat gentle touch',position:'Sitting on floor together'},
capture:{type:'reps',successLabel:'Gentle',missLabel:'Used teeth',notes_prompt:'Duration of gentle contact?'}},
{t:'Excitement Proofing',d:'Practice during play, after walks, when excited. Lower criteria — more redirects needed.',
guidance:{vocal:'Calm redirect, "yes" for toy choice',hand:'Toy always accessible',position:'During exciting activities'},
capture:{type:'reps',successLabel:'Chose toy',missLabel:'Mouthed skin',notes_prompt:'Context? Excitement level?'}},
{t:'Sustained Gentle Play',d:'Extended play sessions with zero mouthing. She consistently chooses toys over skin.',
guidance:{vocal:'Praise throughout gentle play',hand:'Interactive play with toys',position:'Various'},
capture:{type:'duration',successLabel:'Gentle play',missLabel:'Mouthed',notes_prompt:'Play duration without mouthing?'}}]},
{id:'touch',name:'Hand Target',abbr:'TH',phase:1,prereqs:[],
desc:'Nose to palm — a gateway skill for positioning, recall, greeting, cooperative care. Kikopup foundation.',
steps:[
{t:'Present Palm',d:'Hold flat palm a few inches from nose. Mark ANY nose contact with palm. Treat from other hand.',
guidance:{vocal:'"Yes" instant nose touches palm',hand:'Flat palm, fingers down, close to nose',position:'In front of Zuzu'},
capture:{type:'reps',successLabel:'Touched palm',missLabel:'Ignored',notes_prompt:'Speed of touch?'}},
{t:'Add Movement',d:'Present palm slightly to the side so she has to move to touch it. Build to turning her head.',
guidance:{vocal:'"Yes" on touch',hand:'Palm 6-12 inches away, various sides',position:'Facing, vary palm position'},
capture:{type:'reps',successLabel:'Moved to touch',missLabel:'Didn\'t reach',notes_prompt:'Distance moved?'}},
{t:'Add Cue',d:'Say "touch" BEFORE presenting palm. She should start moving toward your hand on the word.',
guidance:{vocal:'"Touch" then present palm then "yes"',hand:'Present palm after verbal',position:'Various positions'},
capture:{type:'reps',successLabel:'Responded to cue',missLabel:'Needed visual first',notes_prompt:'Verbal only?'}},
{t:'Distance & Direction',d:'Use touch to guide her across the room, around objects, onto surfaces.',
guidance:{vocal:'"Touch" from various distances',hand:'Palm as a lure to position her',position:'Use to guide movement'},
capture:{type:'reps',successLabel:'Followed to touch',missLabel:'Lost interest',notes_prompt:'Furthest distance?'}},
{t:'Novel Contexts',d:'Touch in new environments, with strangers holding palm (for greeting), at the vet.',
guidance:{vocal:'"Touch" in new places',hand:'Others can present palm too',position:'New environments'},
capture:{type:'reps',successLabel:'Touched in context',missLabel:'Too distracted',notes_prompt:'Context? Who held palm?'}}]},
// --- CIRCLE II ---
{id:'name',name:'Name Recognition',abbr:'NR',phase:2,prereqs:['attention'],
desc:'Zuzu\'s name should always predict good things — never use it negatively.',
steps:[
{t:'Name = Treat',d:'Say "Zuzu" clearly then treat immediately. No response needed. 15-20 pairings.',
guidance:{vocal:'"Zuzu" clearly then treat',hand:'Deliver treat right after',position:'Any relaxed position'},
capture:{type:'observe',successLabel:'Pair completed',missLabel:null,notes_prompt:'How many pairings?'}},
{t:'Name Orientation',d:'Say name when mildly distracted. Mark any head turn toward you.',
guidance:{vocal:'"Zuzu" then mark turn with "yes"',hand:'Treat ready',position:'Within a few feet'},
capture:{type:'reps',successLabel:'Turned to name',missLabel:'No response',notes_prompt:'Response speed?'}},
{t:'Distance',d:'Call name from across the room. Mark orientation toward you.',
guidance:{vocal:'"Zuzu" from further away',hand:'Treat on arrival',position:'Across room'},
capture:{type:'reps',successLabel:'Oriented',missLabel:'Ignored',notes_prompt:'Distance?'}},
{t:'Busy Environments',d:'Use name in distracting environments. Accept slower responses.',
guidance:{vocal:'"Zuzu" — upbeat tone',hand:'High-value treats',position:'Distracting environment'},
capture:{type:'reps',successLabel:'Responded',missLabel:'Too distracted',notes_prompt:'Environment?'}}]},
{id:'recall',name:'Recall',abbr:'RC',phase:2,prereqs:['name'],
desc:'Coming when called — the most important safety behavior. NEVER call to punish.',
steps:[
{t:'Restrained Recall',d:'Partner holds Zuzu. Call excitedly, partner releases. Huge reward on arrival.',
guidance:{vocal:'"Zuzu, come!" — excited voice',hand:'Open arms, crouch down',position:'6-10 feet away'},
capture:{type:'reps',successLabel:'Came running',missLabel:'Hesitated',notes_prompt:'Speed?'}},
{t:'Surprise Recalls',d:'During calm moments at home, call randomly. Jackpot treat on arrival.',
guidance:{vocal:'"Zuzu, come!" from another room',hand:'Jackpot treats',position:'Various rooms'},
capture:{type:'reps',successLabel:'Came quickly',missLabel:'Ignored',notes_prompt:'Response time?'}},
{t:'Long Line Outdoors',d:'On a long line outside, call when sniffing. Never reel her in.',
guidance:{vocal:'"Zuzu, come!" — excited',hand:'Show treat, reward generously',position:'Hold long line loosely'},
capture:{type:'reps',successLabel:'Recalled',missLabel:'Ignored',notes_prompt:'Distance?'}},
{t:'Around Distractions',d:'Recall near other dogs, people. Start far from distractions.',
guidance:{vocal:'Same excited recall cue',hand:'Highest value treats',position:'Far from distractions'},
capture:{type:'reps',successLabel:'Chose to come',missLabel:'Too distracted',notes_prompt:'What distraction?'}},
{t:'Proof Reliability',d:'Practice in new environments. Keep reinforcing for life.',
guidance:{vocal:'Always excited — recall is never free',hand:'Always reward',position:'New environments'},
capture:{type:'reps',successLabel:'Reliable recall',missLabel:'Failed',notes_prompt:'Hardest distraction overcome?'}}]},
{id:'sit',name:'Sit',abbr:'SI',phase:2,prereqs:[],
desc:'A foundational position cue — gateway to many other wards.',
steps:[
{t:'Lure or Capture',d:'Arc treat over head — butt goes down. Mark the instant she sits.',
guidance:{vocal:'"Yes" instant butt touches floor',hand:'Arc treat over head',position:'Facing her'},
capture:{type:'reps',successLabel:'Sat',missLabel:'Didn\'t sit',notes_prompt:'Lure or captured?'}},
{t:'Add Verbal Cue',d:'Say "sit" BEFORE she sits. Word then behavior then mark then treat.',
guidance:{vocal:'"Sit" then she sits then "yes"',hand:'Fade lure to smaller motion',position:'Facing'},
capture:{type:'reps',successLabel:'Sat on cue',missLabel:'Needed lure',notes_prompt:'Verbal only?'}},
{t:'Any Position',d:'Practice from standing, walking, lying. Sit from any starting position.',
guidance:{vocal:'"Sit" from various contexts',hand:'Minimal hand signal',position:'Various'},
capture:{type:'reps',successLabel:'Sat',missLabel:'Confused',notes_prompt:'Starting position?'}},
{t:'Add Duration',d:'Delay the mark. Wait 2-3-5-10 seconds before marking.',
guidance:{vocal:'"Sit" then pause then "yes"',hand:'Still hand',position:'Standing, relaxed'},
capture:{type:'duration',successLabel:'Held sit',missLabel:'Broke early',notes_prompt:'Duration held?'}},
{t:'Add Distractions',d:'Sit around distractions. Lower duration in harder environments.',
guidance:{vocal:'"Sit" in distracting environment',hand:'None — verbal only',position:'Near distractions'},
capture:{type:'reps',successLabel:'Sat despite distractions',missLabel:'Too distracted',notes_prompt:'Distractions?'}}]},
{id:'release',name:'Release Cue',abbr:'RE',phase:2,prereqs:['sit'],
desc:'A clear word meaning "you\'re free to move" — essential for position holds.',
steps:[
{t:'Pair the Word',d:'Ask for sit, then say "Free!" and toss treat so she moves.',
guidance:{vocal:'"Free!" + excited tone',hand:'Toss treat so she moves',position:'After a brief sit'},
capture:{type:'reps',successLabel:'Released on cue',missLabel:'Didn\'t move',notes_prompt:'Does she understand?'}},
{t:'Release Before She Breaks',d:'Always release BEFORE she breaks on her own.',
guidance:{vocal:'"Free!" before she gets up',hand:'Toss treat on release',position:'Standing nearby'},
capture:{type:'reps',successLabel:'Waited for release',missLabel:'Broke early',notes_prompt:'Duration before releasing?'}},
{t:'Vary the Reward',d:'Sometimes treat, sometimes play, sometimes just freedom.',
guidance:{vocal:'"Free!" or "Break!"',hand:'Various rewards',position:'Various'},
capture:{type:'reps',successLabel:'Clean release',missLabel:'Anticipated',notes_prompt:'Reward type?'}},
{t:'Use with Everything',d:'Pair release with sit, down, wait, door. Universal "you\'re done" signal.',
guidance:{vocal:'Same release word consistently',hand:'Varies by context',position:'Various'},
capture:{type:'reps',successLabel:'Understood',missLabel:'Confused',notes_prompt:'Which behaviors paired?'}}]},
{id:'down',name:'Down',abbr:'DN',phase:2,prereqs:['sit'],
desc:'Lying down on cue — useful for settling and longer stays.',
steps:[
{t:'Lure from Sit',d:'From sit, lower treat between paws to floor. Mark when elbows touch.',
guidance:{vocal:'"Yes" when elbows touch',hand:'Lower treat between paws',position:'Kneeling in front'},
capture:{type:'reps',successLabel:'Downed',missLabel:'Didn\'t down',notes_prompt:'Full down?'}},
{t:'Lure from Standing',d:'Lower treat to floor from standing position.',
guidance:{vocal:'"Yes" on down',hand:'Treat to floor — slow',position:'Standing, facing'},
capture:{type:'reps',successLabel:'Down from stand',missLabel:'Sat instead',notes_prompt:'Intermediate sit?'}},
{t:'Add Verbal Cue',d:'Say "down" before she lies down. Fade lure to hand signal to verbal.',
guidance:{vocal:'"Down" then she lies then "yes"',hand:'Fade to flat hand signal',position:'Various'},
capture:{type:'reps',successLabel:'Verbal only',missLabel:'Needed hand',notes_prompt:'Responding to verbal?'}},
{t:'Build Duration',d:'Delay mark. Build from 5s to 30s+. Release before she breaks.',
guidance:{vocal:'"Down" then pause then "yes" then release',hand:'Calm, still',position:'Step back gradually'},
capture:{type:'duration',successLabel:'Held down',missLabel:'Got up',notes_prompt:'Duration? Relaxed?'}},
{t:'Various Surfaces',d:'Practice on carpet, tile, grass, concrete.',
guidance:{vocal:'Same cue',hand:'May need re-lure on new surfaces',position:'New environments'},
capture:{type:'reps',successLabel:'Downed',missLabel:'Refused',notes_prompt:'Surface?'}}]},
{id:'leaveit',name:'Leave It',abbr:'LI',phase:2,prereqs:['nomugging'],
desc:'Don\'t touch it in the first place — leave-it item is NEVER the reward.',
steps:[
{t:'Two-Treat Method',d:'Show treat in closed fist. Reward from OTHER hand when she backs off.',
guidance:{vocal:'"Yes" when she disengages',hand:'Closed fist — reward from OTHER hand',position:'Sitting in front'},
capture:{type:'reps',successLabel:'Backed off',missLabel:'Kept trying',notes_prompt:'Speed?'}},
{t:'Add the Cue',d:'Say "leave it" before presenting item.',
guidance:{vocal:'"Leave it" then she backs off then "yes"',hand:'Present item, reward other hand',position:'Facing'},
capture:{type:'reps',successLabel:'Left on cue',missLabel:'Went for it',notes_prompt:'Responding to verbal?'}},
{t:'Floor Items',d:'Place item on floor. Say "leave it". Cover if needed.',
guidance:{vocal:'"Leave it" before she approaches',hand:'Ready to cover item',position:'Standing over item'},
capture:{type:'reps',successLabel:'Left floor item',missLabel:'Went for it',notes_prompt:'Covered or uncovered?'}},
{t:'On Walks',d:'Practice leaving items found on walks.',
guidance:{vocal:'"Leave it" on walks',hand:'Treat from pocket',position:'Walking beside her'},
capture:{type:'reps',successLabel:'Left it',missLabel:'Grabbed it',notes_prompt:'What item?'}},
{t:'High-Value Items',d:'Practice with extremely tempting items. Start far, work closer.',
guidance:{vocal:'"Leave it"',hand:'Highest value reward from other hand',position:'Increasing proximity'},
capture:{type:'reps',successLabel:'Left high-value',missLabel:'Couldn\'t resist',notes_prompt:'Item? Distance?'}}]},
{id:'dropit',name:'Drop It',abbr:'DI',phase:2,prereqs:[],
desc:'Release what\'s in your mouth — trade UP, never chase. She gets the toy back.',
steps:[
{t:'Trade Game',d:'Show treat while she has toy. When she drops toy, give treat AND toy back.',
guidance:{vocal:'Show treat silently at first',hand:'Offer treat, return toy after',position:'Nearby, relaxed'},
capture:{type:'reps',successLabel:'Traded',missLabel:'Wouldn\'t trade',notes_prompt:'Toy type?'}},
{t:'Add Cue',d:'Say "drop it" before showing treat. Build to word alone.',
guidance:{vocal:'"Drop it" then treat then return toy',hand:'Fade showing treat',position:'Nearby'},
capture:{type:'reps',successLabel:'Dropped on cue',missLabel:'Needed lure',notes_prompt:'Verbal only?'}},
{t:'Various Objects',d:'Practice with different items. Always trade UP in value.',
guidance:{vocal:'"Drop it"',hand:'Treat after drop, return safe items',position:'Various'},
capture:{type:'reps',successLabel:'Dropped',missLabel:'Held on',notes_prompt:'Object type?'}},
{t:'Quick Response',d:'Build speed of response. Immediate release on cue.',
guidance:{vocal:'"Drop it" — expect immediate',hand:'Quick treat delivery',position:'Various'},
capture:{type:'reps',successLabel:'Quick drop',missLabel:'Slow/refused',notes_prompt:'Response speed?'}}]},
{id:'chinrest',name:'Chin Rest',abbr:'CN',phase:2,prereqs:['touch','calmness'],
desc:'Chin on hand = consent signal for cooperative care. If she lifts chin, you stop. Chirag Patel / Kikopup protocol.',
steps:[
{t:'Lure Chin Down',d:'Hold treat between fingers, lower hand. When her chin rests on your other palm, mark and treat.',
guidance:{vocal:'Quiet "yes" when chin settles',hand:'Flat palm as chin rest, treat from other hand',position:'Sitting beside her'},
capture:{type:'reps',successLabel:'Chin rested',missLabel:'Pulled away',notes_prompt:'Duration of rest?'}},
{t:'Build Duration',d:'Delay the mark. Chin rests 2s, 3s, 5s. She learns: chin down = treats keep coming.',
guidance:{vocal:'Quiet marker after pause',hand:'Treat while chin stays',position:'Same calm position'},
capture:{type:'duration',successLabel:'Held chin',missLabel:'Lifted early',notes_prompt:'Longest hold?'}},
{t:'Add Cue',d:'Say "chin" before she offers it. Chin on palm → treats. Lifting chin = pause all handling.',
guidance:{vocal:'"Chin" then she rests then "yes"',hand:'Present palm as target',position:'Sitting'},
capture:{type:'reps',successLabel:'On cue',missLabel:'Needed lure',notes_prompt:'Verbal only?'}},
{t:'Pair with Touch',d:'Chin rest while you briefly touch ear, paw, side. Stop touching if chin lifts.',
guidance:{vocal:'"Chin" then brief touch then treat',hand:'One hand as chin rest, other touches body',position:'Beside her'},
capture:{type:'reps',successLabel:'Allowed touch',missLabel:'Lifted chin',notes_prompt:'Body part touched?'}},
{t:'Full Care Sessions',d:'Chin rest during brushing, nail inspection, ear check. She controls the pace.',
guidance:{vocal:'Ongoing calm praise',hand:'Chin rest = continue, lift = pause',position:'Grooming position'},
capture:{type:'duration',successLabel:'Cooperated',missLabel:'Withdrew consent',notes_prompt:'What handling? Duration?'}}]},
{id:'place',name:'Go to Place',abbr:'PL',phase:2,prereqs:['calmness'],
desc:'Cued mat/bed settle — "go to your spot." Builds on captured calmness but adds a verbal send-away cue.',
steps:[
{t:'Reward on Mat',d:'Place mat nearby. Toss treats onto it. She learns: mat = treat zone.',
guidance:{vocal:'None yet — let the mat do the work',hand:'Toss treats onto mat',position:'Near the mat'},
capture:{type:'observe',successLabel:'Went to mat',missLabel:null,notes_prompt:'How quickly did she go?'}},
{t:'Shape Settling',d:'Once she goes to mat, only reward lying down on it. Build the down-on-mat behavior.',
guidance:{vocal:'"Yes" when she lies on mat',hand:'Deliver treats on mat',position:'Standing a few feet away'},
capture:{type:'reps',successLabel:'Settled on mat',missLabel:'Stayed standing',notes_prompt:'Time to settle?'}},
{t:'Add Cue',d:'Say "place" or "go to bed" and gesture toward mat. Mark when she goes and settles.',
guidance:{vocal:'"Place" + point to mat then "yes" on settle',hand:'Point toward mat',position:'Increasing distance from mat'},
capture:{type:'reps',successLabel:'Went on cue',missLabel:'Needed lure',notes_prompt:'Distance from mat?'}},
{t:'Build Duration',d:'She stays on mat while you move around, do chores, eat. Treat intermittently.',
guidance:{vocal:'Periodic quiet "yes"',hand:'Deliver treats on mat without recall',position:'Moving around room'},
capture:{type:'duration',successLabel:'Stayed on place',missLabel:'Left mat',notes_prompt:'Duration? What were you doing?'}},
{t:'Distractions & Distance',d:'Doorbell, guests, food prep. Lower criteria in harder contexts. Mat = safe default.',
guidance:{vocal:'"Place" before distraction arrives',hand:'High-value treats on mat',position:'Real-life situations'},
capture:{type:'reps',successLabel:'Held place',missLabel:'Broke',notes_prompt:'Distraction? How close?'}}]},
// --- CIRCLE III ---
{id:'leashpressure',name:'Leash Pressure Yields',abbr:'LP',phase:3,prereqs:['attention'],
desc:'Leash tension means "move toward it" — foundation for loose leash walking.',
steps:[
{t:'Introduce Leash',d:'Wear harness and leash with zero pressure. Reward relaxed behavior.',
guidance:{vocal:'Praise calm behavior in gear',hand:'Treat for ignoring leash',position:'Indoors, no walking yet'},
capture:{type:'observe',successLabel:'Wore calmly',missLabel:null,notes_prompt:'Reaction to harness?'}},
{t:'Follow Pressure',d:'Slight tension then she steps toward you then mark and treat. Never pull hard.',
guidance:{vocal:'"Yes" when she steps toward tension',hand:'Gentle pressure, treat on yield',position:'Standing still'},
capture:{type:'reps',successLabel:'Yielded',missLabel:'Resisted',notes_prompt:'How much pressure?'}},
{t:'All Directions',d:'Yield to gentle pressure left, right, forward.',
guidance:{vocal:'"Yes" on each yield',hand:'Gentle pressure, quick release',position:'Various directions'},
capture:{type:'reps',successLabel:'Yielded',missLabel:'Pulled against',notes_prompt:'Directions?'}},
{t:'Moving Together',d:'Walk slowly, reward when leash stays loose.',
guidance:{vocal:'"Yes" for loose leash',hand:'Treats at your side',position:'Walking slowly indoors'},
capture:{type:'reps',successLabel:'Walked loose',missLabel:'Pulled',notes_prompt:'Best stretch?'}}]},
{id:'llwindoor',name:'LLW Indoor',abbr:'LW',phase:3,prereqs:['leashpressure','attention'],
desc:'Loose leash walking mastered indoors first — must be reliable before going outside.',
steps:[
{t:'Follow Me Game',d:'Walk around house, mark when at your side. Treat at hip level.',
guidance:{vocal:'"Yes" when at your side',hand:'Treat at hip level',position:'Walking through house'},
capture:{type:'reps',successLabel:'At my side',missLabel:'Pulled',notes_prompt:'Rooms covered?'}},
{t:'Add Turns',d:'Change direction frequently. Mark when she adjusts.',
guidance:{vocal:'"Yes" on direction changes',hand:'Treat at hip on turns',position:'Change direction often'},
capture:{type:'reps',successLabel:'Followed turn',missLabel:'Missed turn',notes_prompt:'Turn types?'}},
{t:'Build Duration',d:'Walk longer stretches without treats. Intermittent reinforcement.',
guidance:{vocal:'Periodic "yes" and treat',hand:'Space out treats',position:'Walking, relaxed pace'},
capture:{type:'duration',successLabel:'Walked nicely',missLabel:'Lost focus',notes_prompt:'Longest stretch?'}},
{t:'Hallways & Doorways',d:'Navigate tighter spaces. Keep leash loose through transitions.',
guidance:{vocal:'"Yes" through doorways',hand:'Treat after transition',position:'Through house'},
capture:{type:'reps',successLabel:'Loose through space',missLabel:'Pulled',notes_prompt:'Which spaces?'}}]},
{id:'llwoutdoor',name:'LLW Outdoor',abbr:'LO',phase:3,prereqs:['llwindoor','interrupter'],
desc:'Taking loose leash walking outside — outdoors is much harder.',
steps:[
{t:'Quiet Area',d:'Start in quiet area. Mark any loose-leash steps. Reward frequently.',
guidance:{vocal:'"Yes" for loose leash',hand:'Treat every few steps',position:'Quiet outdoor area'},
capture:{type:'reps',successLabel:'Loose steps',missLabel:'Pulled',notes_prompt:'Location?'}},
{t:'Neighborhood Walks',d:'Short LLW stretches during walks. Use interrupter if she fixates.',
guidance:{vocal:'Interrupter if needed, "yes" for check-ins',hand:'Treat at hip',position:'Neighborhood walk'},
capture:{type:'reps',successLabel:'Nice stretches',missLabel:'Pulled hard',notes_prompt:'Best stretch?'}},
{t:'Past Distractions',d:'Walk past people, dogs at distance. Use interrupter, mark focus.',
guidance:{vocal:'Interrupter + "yes" for focus',hand:'High-value treats near triggers',position:'Distance from distractions'},
capture:{type:'reps',successLabel:'Passed calmly',missLabel:'Lost it',notes_prompt:'Trigger? Distance?'}},
{t:'Extended Walks',d:'Longer stretches of loose leash in moderate environments.',
guidance:{vocal:'Periodic reinforcement',hand:'Intermittent treats',position:'Regular pace'},
capture:{type:'duration',successLabel:'Good walk',missLabel:'Lots of pulling',notes_prompt:'Walk duration?'}},
{t:'High-Distraction Areas',d:'Parks, busy areas. Accept needing more treats.',
guidance:{vocal:'Frequent markers',hand:'Highest value treats',position:'Busy environments'},
capture:{type:'reps',successLabel:'Managed it',missLabel:'Over threshold',notes_prompt:'Location? Distractions?'}}]},
{id:'fetch',name:'Fetch',abbr:'FE',phase:3,prereqs:['dropit'],
desc:'Building a retrieve game — great exercise and mental stimulation.',
steps:[
{t:'Chase the Toy',d:'Toss toy short distance. Encourage interest. Any interaction = mark.',
guidance:{vocal:'Excited "get it!"',hand:'Short toss',position:'On floor'},
capture:{type:'observe',successLabel:'Chased it',missLabel:null,notes_prompt:'Interest level?'}},
{t:'Pick Up & Hold',d:'Mark when she picks up toy. Shape returning.',
guidance:{vocal:'"Yes" for picking up',hand:'Treat near you',position:'Near where toy lands'},
capture:{type:'reps',successLabel:'Picked up',missLabel:'Lost interest',notes_prompt:'Did she bring it back?'}},
{t:'Return to You',d:'Only mark when she brings toy toward you.',
guidance:{vocal:'"Bring it!" + "yes" when turning to you',hand:'Pat ground near you',position:'Stay in one spot'},
capture:{type:'reps',successLabel:'Returned',missLabel:'Kept it',notes_prompt:'How close?'}},
{t:'Drop & Throw Again',d:'Drop it then throw again. The throw IS the reward.',
guidance:{vocal:'"Drop it" then throw again',hand:'Quick throw after drop',position:'Standing'},
capture:{type:'reps',successLabel:'Full cycle',missLabel:'Wouldn\'t drop',notes_prompt:'How many cycles?'}}]},
{id:'lookat',name:'Look at That',abbr:'LA',phase:3,prereqs:['attention'],
desc:'See a trigger, look back at you for a treat. Reactivity management from Control Unleashed, taught by Kikopup.',
steps:[
{t:'Mark the Look',d:'At a huge distance from a mild trigger, mark when Zuzu notices it and looks back at you.',
guidance:{vocal:'"Yes" the instant she looks back from trigger',hand:'Treat quickly',position:'Far from trigger'},
capture:{type:'reps',successLabel:'Looked back',missLabel:'Fixated',notes_prompt:'Trigger? Distance?'}},
{t:'Build the Pattern',d:'See trigger → look at you becomes automatic. She starts checking in without prompting.',
guidance:{vocal:'"Yes" for each voluntary check-in',hand:'Treat at your side',position:'Comfortable distance'},
capture:{type:'reps',successLabel:'Auto check-in',missLabel:'Needed prompt',notes_prompt:'How many auto check-ins?'}},
{t:'Decrease Distance',d:'Gradually work closer to triggers. If she fixates, increase distance. Always under threshold.',
guidance:{vocal:'"Yes" for look-backs at closer range',hand:'High-value treats',position:'Decreasing distance'},
capture:{type:'reps',successLabel:'Calm at distance',missLabel:'Over threshold',notes_prompt:'Closest distance?'}},
{t:'Various Triggers',d:'Dogs, people, bikes, skateboards. Each new trigger starts at large distance again.',
guidance:{vocal:'Same pattern — see it, look at you, treat',hand:'Highest value treats',position:'Under threshold distance'},
capture:{type:'reps',successLabel:'Handled trigger',missLabel:'Reacted',notes_prompt:'Trigger type?'}},
{t:'Real-World Walks',d:'Use LAT on regular walks. She scans environment, checks in with you, gets rewarded.',
guidance:{vocal:'"Yes" for voluntary check-ins on walks',hand:'Treat pouch ready',position:'Walking together'},
capture:{type:'reps',successLabel:'Walk check-ins',missLabel:'Reactive episode',notes_prompt:'Triggers passed? Distance?'}}]},
{id:'handling',name:'Handling & Grooming',abbr:'HG',phase:3,prereqs:['calmness','chinrest'],
desc:'Cooperative care — touch = treat. If she moves away, LET HER. Chin rest = consent to continue.',
steps:[
{t:'Touch = Treat',d:'Brief gentle touch anywhere then treat. Build positive association.',
guidance:{vocal:'Calm "yes" after touch',hand:'Brief touch, immediate treat',position:'Beside her'},
capture:{type:'observe',successLabel:'Accepted touch',missLabel:null,notes_prompt:'Body parts? Reaction?'}},
{t:'Paw Handling',d:'Touch and briefly hold each paw then treat.',
guidance:{vocal:'Calm "yes"',hand:'Touch paw then treat then brief hold',position:'Beside her, low'},
capture:{type:'reps',successLabel:'Allowed hold',missLabel:'Pulled away',notes_prompt:'Which paws?'}},
{t:'Body Exam',d:'Touch ears, teeth area, tail then treat each time.',
guidance:{vocal:'Calm reassurance + treat',hand:'Gentle brief touches',position:'Beside on floor'},
capture:{type:'reps',successLabel:'Allowed exam',missLabel:'Moved away',notes_prompt:'Sensitive areas?'}},
{t:'Tool Introduction',d:'Show brush, nail clippers then treat. Touch with tool then treat.',
guidance:{vocal:'"Yes" for accepting tool',hand:'Tool touch then treat',position:'Beside, tools nearby'},
capture:{type:'reps',successLabel:'Accepted tool',missLabel:'Avoided',notes_prompt:'Which tool?'}},
{t:'Full Handling',d:'Extended handling, brushing, nail touching. She can leave anytime.',
guidance:{vocal:'Ongoing calm praise',hand:'Extended handling with treat breaks',position:'Comfortable position'},
capture:{type:'duration',successLabel:'Cooperated',missLabel:'Left',notes_prompt:'Duration? Tools?'}}]},
{id:'separation',name:'Separation Training',abbr:'ST',phase:3,prereqs:['crate','calmness'],
desc:'Building tolerance to being alone. First 15 minutes is the hardest barrier.',
steps:[
{t:'Departure Cue Desensitization',d:'Pick up keys, put on shoes, sit back down. Desensitize departure cues.',
guidance:{vocal:'None — just do departure actions',hand:'Pick up keys, bag, coat then put down',position:'Moving around house'},
capture:{type:'observe',successLabel:'Practiced cues',missLabel:null,notes_prompt:'Which cues? Reaction?'}},
{t:'Brief Absences (5-30s)',d:'Leave room 5s, return before stress. Build to 30s. Stay boring on return.',
guidance:{vocal:'No goodbye or hello',hand:'Treat calmly after return',position:'Leave and return'},
capture:{type:'duration',successLabel:'Calm',missLabel:'Stressed',notes_prompt:'Duration? Vocalization?'}},
{t:'Short Absences (1-5 min)',d:'Leave the house for 1 min. Return boring. Build to 5.',
guidance:{vocal:'Low-key departure',hand:'Leave enrichment',position:'Leave house'},
capture:{type:'duration',successLabel:'Calm alone',missLabel:'Distressed',notes_prompt:'Duration?'}},
{t:'Medium Absences (5-30 min)',d:'5-15 min is hardest. Go slow. Most anxiety in first 15 min.',
guidance:{vocal:'Boring departure',hand:'Kong before leaving',position:'Leave normally'},
capture:{type:'duration',successLabel:'Managed it',missLabel:'Anxious',notes_prompt:'Duration? Enrichment eaten?'}},
{t:'Extended Absences (30+ min)',d:'Build to 30-60+ min. If she handles 30, she can usually handle more.',
guidance:{vocal:'Normal departure',hand:'Enrichment available',position:'Normal absence'},
capture:{type:'duration',successLabel:'Home alone success',missLabel:'Regressed',notes_prompt:'Duration? Behavior on return?'}}]},
{id:'doormanners',name:'Door Manners',abbr:'DM',phase:3,prereqs:['sit','release','nomugging'],
desc:'Waiting at doors instead of bolting — uses sit and release together.',
steps:[
{t:'Sit at Door',d:'Approach closed door. Ask sit. Only touch handle when sitting.',
guidance:{vocal:'"Sit" before touching handle',hand:'Hand to handle only when sitting',position:'At closed door'},
capture:{type:'reps',successLabel:'Sat at door',missLabel:'Broke sit',notes_prompt:'Which door?'}},
{t:'Door Opens Slightly',d:'Sit then open door a crack. Close if she moves.',
guidance:{vocal:'"Yes" for holding sit as door opens',hand:'Open slowly, close if she moves',position:'At door'},
capture:{type:'reps',successLabel:'Held sit',missLabel:'Moved',notes_prompt:'How far open?'}},
{t:'Full Open Wait',d:'Door wide open, waits until release cue.',
guidance:{vocal:'Hold... hold... "Free!"',hand:'Door fully open, treat for waiting',position:'At open door'},
capture:{type:'duration',successLabel:'Waited',missLabel:'Bolted',notes_prompt:'Duration?'}},
{t:'Real Entries & Exits',d:'Practice at all doors. With visitors. Real-life situations.',
guidance:{vocal:'"Sit" then open then "Free!"',hand:'Guide as needed',position:'Various doors'},
capture:{type:'reps',successLabel:'Polite',missLabel:'Bolted',notes_prompt:'Which door? Visitors?'}}]}
];

// === TREE LAYOUT === Shield-shaped game tree. AT is keystone at top.
// Three convergence gateways: LO (leash+interrupter), DM (sit+release+impulse), ST (calmness+crate)
const TREE_POS={
attention:{x:140,y:55},touch:{x:270,y:55},
name:{x:70,y:150},leashpressure:{x:210,y:150},mouthing:{x:340,y:150},
recall:{x:40,y:250},interrupter:{x:140,y:250},llwindoor:{x:270,y:250},house:{x:360,y:250},
llwoutdoor:{x:195,y:345},lookat:{x:340,y:345},
nomugging:{x:55,y:440},sit:{x:175,y:440},dropit:{x:300,y:440},
leaveit:{x:40,y:535},down:{x:120,y:535},release:{x:240,y:535},fetch:{x:345,y:535},
doormanners:{x:175,y:630},
calmness:{x:100,y:720},crate:{x:280,y:720},
place:{x:50,y:810},chinrest:{x:160,y:810},handling:{x:300,y:810},
separation:{x:195,y:900}
};
const TREE_W=390,TREE_H=960;
const EDGES=[
['attention','name'],['attention','leashpressure'],['attention','lookat'],
['name','recall'],
['leashpressure','llwindoor'],['llwindoor','llwoutdoor'],['interrupter','llwoutdoor'],
['nomugging','leaveit'],['nomugging','doormanners'],
['sit','release'],['sit','down'],['sit','doormanners'],['release','doormanners'],
['dropit','fetch'],
['touch','chinrest'],
['calmness','place'],['calmness','chinrest'],['calmness','separation'],
['chinrest','handling'],
['crate','separation']
];

// === INSCRIPTIONS ===
const INSCRIPTIONS=[
{id:'first_ritual',t:'First Ritual Performed',ic:'RI',check:D=>D.sessions.length>=1},
{id:'ten_rituals',t:'Ten Rituals Completed',ic:'RI',check:D=>D.sessions.length>=10},
{id:'twentyfive',t:'Twenty-Five Rituals',ic:'RI',check:D=>D.sessions.length>=25},
{id:'fifty',t:'Fifty Rituals',ic:'RI',check:D=>D.sessions.length>=50},
{id:'hundred',t:'One Hundred Rituals',ic:'RI',check:D=>D.sessions.length>=100},
{id:'vigil_3',t:'3-Day Vigil',ic:'VI',check:(D,s)=>s>=3},
{id:'vigil_7',t:'7-Day Vigil',ic:'VI',check:(D,s)=>s>=7},
{id:'vigil_14',t:'14-Day Vigil',ic:'VI',check:(D,s)=>s>=14},
{id:'vigil_30',t:'30-Day Vigil',ic:'VI',check:(D,s)=>s>=30},
{id:'circle_1',t:'Circle I Complete -- Foundation Sealed',ic:'C1',
 check:D=>WARDS.filter(w=>w.phase===1).every(w=>D.progress[w.id]&&D.progress[w.id].masteredAt)},
{id:'circle_2',t:'Circle II Complete -- Core Sealed',ic:'C2',
 check:D=>WARDS.filter(w=>w.phase===2).every(w=>D.progress[w.id]&&D.progress[w.id].masteredAt)},
{id:'circle_3',t:'Circle III Complete -- Life Wards Sealed',ic:'C3',
 check:D=>WARDS.filter(w=>w.phase===3).every(w=>D.progress[w.id]&&D.progress[w.id].masteredAt)},
{id:'all_sealed',t:"Pazuzu's Shield Complete",ic:'PZ',
 check:D=>WARDS.every(w=>D.progress[w.id]&&D.progress[w.id].masteredAt)},
{id:'first_alone_30',t:'First 30-Minute Separation',ic:'AL',check:D=>D.aloneLogs.some(l=>l.dur>=1800)},
{id:'first_alone_60',t:'First Hour Alone',ic:'AL',check:D=>D.aloneLogs.some(l=>l.dur>=3600)},
{id:'potty_7',t:'7 Days Accident-Free',ic:'PT',check:D=>{
 if(!D.pottyLogs.length)return false;const now=new Date();
 for(let i=0;i<7;i++){const d=new Date(now);d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);
  if(D.pottyLogs.some(p=>p.dt.slice(0,10)===ds&&p.loc==='inside'))return false;}return true;}}
];
WARDS.forEach(w=>INSCRIPTIONS.push({id:'ward_'+w.id,t:'Ward of '+w.name+' Sealed',ic:w.abbr,
 check:D=>D.progress[w.id]&&D.progress[w.id].masteredAt}));

// === BODY LANGUAGE SIGNALS ===
const BODY_SIGNALS=['Lip licking','Yawning','Panting','Pacing','Trembling','Whale eye',
 'Tucked tail','Raised hackles','Drooling','Scratching','Hiding','Clingy','Freezing','Ground sniffing','Turning away','Low posture'];

// === DATA MODEL ===
let D;const STORE_KEY='pazuzuWards',OLD_KEY='zuTrainer';

function defaultData(){
 const p={};WARDS.forEach(w=>{p[w.id]={step:0,unlocked:w.prereqs.length===0,startedAt:null,masteredAt:null};});
 return{
  profile:{name:'Zuzu',weight:8.5,rescueDate:'',breed:'Chiweenie',age:'',origin:'Mexico rescue'},
  settings:{duration:180,threshold:80,evalSessions:3,soundEnabled:true,reminders:true},
  progress:p,sessions:[],milestones:[],pottyLogs:[],aloneLogs:[],enrichmentLogs:[],
  foodNotes:{kibble:'',highValueTreats:[],medValueTreats:[],lowValueTreats:[],dislikes:[],allergies:[],feedingSchedule:'',notes:''},
  behaviorNotes:[],dailySchedule:[],aloneTimerState:{running:false,startTime:null,elapsed:0}
 };
}

function load(){
 try{
  const raw=localStorage.getItem(STORE_KEY);
  if(raw){D=JSON.parse(raw);ensureFields();return;}
  const old=localStorage.getItem(OLD_KEY);
  if(old){D=defaultData();const o=JSON.parse(old);
   if(o.profile)Object.assign(D.profile,o.profile);if(o.settings)Object.assign(D.settings,o.settings);
   if(o.sessions)D.sessions=o.sessions;if(o.milestones)D.milestones=o.milestones;
   if(o.pottyLogs)D.pottyLogs=o.pottyLogs;if(o.aloneLogs)D.aloneLogs=o.aloneLogs;
   if(o.progress)Object.keys(o.progress).forEach(k=>{if(D.progress[k])Object.assign(D.progress[k],o.progress[k]);});
   ensureFields();save();toast('Data migrated from previous version');return;}
  D=defaultData();save();
 }catch(e){console.error('Load error:',e);D=defaultData();save();}
}

function ensureFields(){
 const def=defaultData();
 Object.keys(def).forEach(k=>{if(!(k in D))D[k]=def[k];});
 WARDS.forEach(w=>{if(!D.progress[w.id])D.progress[w.id]={step:0,unlocked:w.prereqs.length===0,startedAt:null,masteredAt:null};});
 Object.keys(def.settings).forEach(k=>{if(!(k in D.settings))D.settings[k]=def.settings[k];});
 Object.keys(def.foodNotes).forEach(k=>{if(!(k in D.foodNotes))D.foodNotes[k]=def.foodNotes[k];});
 Object.keys(def.profile).forEach(k=>{if(!(k in D.profile))D.profile[k]=def.profile[k];});
 ['sessions','milestones','pottyLogs','aloneLogs','enrichmentLogs','behaviorNotes','dailySchedule'].forEach(k=>{if(!Array.isArray(D[k]))D[k]=[];});
 if(!D.aloneTimerState)D.aloneTimerState={running:false,startTime:null,elapsed:0};
 updateUnlocks();
}

function save(){
 try{D._lastModified=Date.now();localStorage.setItem(STORE_KEY,JSON.stringify(D));}catch(e){console.error('Save:',e);}
 queueGistSync();
}

function updateUnlocks(){
 WARDS.forEach(w=>{
  if(w.prereqs.length===0){D.progress[w.id].unlocked=true;return;}
  D.progress[w.id].unlocked=w.prereqs.every(p=>D.progress[p]&&D.progress[p].masteredAt);
 });
}

// === UTILITIES ===
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6);}
function fmtDate(iso){if(!iso)return'';const d=new Date(iso);return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});}
function fmtTime(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+(sec<10?'0':'')+sec;}
function fmtDur(s){if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m';}
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;$('#toasts').appendChild(t);setTimeout(()=>t.remove(),3200);}
function wardById(id){return WARDS.find(w=>w.id===id);}
function getRate(ok,no){const t=ok+(no||0);return t?Math.round(ok/t*100):0;}
function today(){return new Date().toISOString().slice(0,10);}

// === MODAL ===
function openModal(html){$('#modalContent').innerHTML='<div class="modal-handle"></div>'+html;$('#modal').classList.add('open');}
function closeModal(){$('#modal').classList.remove('open');}

// === TAB NAV ===
let activeTab='shrine';
function switchTab(tab){
 $$('.tab-panel').forEach(p=>p.classList.remove('active'));
 $$('.nav-btn').forEach(b=>b.classList.remove('active'));
 $('#tab-'+tab).classList.add('active');
 document.querySelector(`.nav-btn[data-tab="${tab}"]`).classList.add('active');
 activeTab=tab;renderTab(tab);
}
function renderTab(tab){
 switch(tab){
  case'shrine':renderShrine();break;case'wardtree':renderWardTree();break;
  case'ritual':renderRitualTab();break;case'chronicle':renderChronicle();break;
  case'chronicles':renderChronicles();break;
 }
}

// === VIGIL (STREAK) ===
function calcVigil(){
 if(!D.sessions.length)return 0;
 const days=new Set(D.sessions.map(s=>s.dt.slice(0,10)));
 let streak=0,d=new Date();
 for(let i=0;i<365;i++){
  const ds=d.toISOString().slice(0,10);
  if(days.has(ds)){streak++;}else if(i>0){break;}
  d.setDate(d.getDate()-1);
 }
 return streak;
}

// === WARD TREE ===
function getWardStatus(w){
 const p=D.progress[w.id];
 if(p.masteredAt)return'sealed';
 if(p.startedAt)return'in-progress';
 if(p.unlocked)return'available';
 return'locked';
}

function renderWardTree(){
 const el=$('#tab-wardtree');
 let svg=`<svg class="tree-svg" width="${TREE_W}" height="${TREE_H}" viewBox="0 0 ${TREE_W} ${TREE_H}">`;
 // Draw edges
 EDGES.forEach(([from,to])=>{
  const a=TREE_POS[from],b=TREE_POS[to];
  const fs=getWardStatus(wardById(from)),ts=getWardStatus(wardById(to));
  let cls='tree-line';
  if(fs==='sealed'&&ts==='sealed')cls+=' sealed';
  else if(fs==='sealed'||fs==='in-progress')cls+=' active';
  svg+=`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" class="${cls}"/>`;
 });
 // Draw nodes
 WARDS.forEach(w=>{
  const pos=TREE_POS[w.id],st=getWardStatus(w),p=D.progress[w.id];
  svg+=`<g class="tree-node ${st}" onclick="openWardDetail('${w.id}')" data-id="${w.id}">`;
  if(st==='available')svg+=`<circle class="pulse-ring" cx="${pos.x}" cy="${pos.y}" r="24"/>`;
  if(st==='in-progress'){
   const pct=p.step/w.steps.length;
   const r=22,c=2*Math.PI*r,offset=c*(1-pct);
   svg+=`<circle class="progress-arc" cx="${pos.x}" cy="${pos.y}" r="${r}" stroke-dasharray="${c}" stroke-dashoffset="${offset}" transform="rotate(-90 ${pos.x} ${pos.y})"/>`;
  }
  svg+=`<circle class="node-bg" cx="${pos.x}" cy="${pos.y}" r="20"/>`;
  svg+=`<text x="${pos.x}" y="${pos.y}">${w.abbr}</text>`;
  svg+=`</g>`;
 });
 svg+=`</svg>`;
 el.innerHTML=`<h2 class="text-center mb-8">The Ward Tree</h2>
  <div class="text-center text-dim" style="font-size:0.75rem;margin-bottom:12px">Tap a ward to view details</div>
  <div class="tree-container">${svg}</div>`;
}

// === WARD DETAIL SHEET ===
function openWardDetail(id){
 const w=wardById(id),p=D.progress[id],st=getWardStatus(w);
 const curStep=w.steps[p.step]||w.steps[w.steps.length-1];
 let stepsHtml=w.steps.map((s,i)=>{
  let cls=i<p.step?'done':i===p.step?'current':'future';
  if(p.masteredAt)cls='done';
  return`<div class="step-item ${cls}"><div class="step-num">${i+1}</div>
   <div class="step-info"><div class="step-title">${s.t}</div><div class="step-desc">${s.d}</div></div></div>`;
 }).join('');
 let statusBadge=st==='sealed'?'<span class="badge badge-ok">Sealed</span>':
  st==='in-progress'?`<span class="badge badge-warn">Step ${p.step+1}/${w.steps.length}</span>`:
  st==='available'?'<span class="badge" style="background:var(--pri-glow);color:var(--pri)">Available</span>':
  '<span class="badge" style="background:var(--card2);color:var(--txt3)">Locked</span>';
 let guidanceHtml='';
 if(curStep&&curStep.guidance){
  const g=curStep.guidance;
  guidanceHtml=`<div class="guidance-box">
   ${g.vocal?`<div class="g-item"><span class="g-label">Voice</span><span>${g.vocal}</span></div>`:''}
   ${g.hand?`<div class="g-item"><span class="g-label">Hand</span><span>${g.hand}</span></div>`:''}
   ${g.position?`<div class="g-item"><span class="g-label">Pos</span><span>${g.position}</span></div>`:''}
  </div>`;
 }
 let actions='';
 if(st==='available'||st==='in-progress'){
  actions=`<button class="btn btn-pri btn-block btn-lg mt-12" onclick="closeModal();startRitual('${id}')">Begin Ritual</button>`;
 }else if(st==='locked'){
  const needed=w.prereqs.map(pid=>wardById(pid).name).join(', ');
  actions=`<div class="text-dim mt-12" style="font-size:0.8rem;text-center">Requires: ${needed}</div>`;
 }
 const phaseNames={1:'Circle I: Foundation',2:'Circle II: Core',3:'Circle III: Life'};
 openModal(`<div class="modal-header"><div><h2>${w.name}</h2>
  <div class="text-dim" style="font-size:0.75rem">${phaseNames[w.phase]} ${statusBadge}</div></div>
  <button class="modal-close" onclick="closeModal()">X</button></div>
  <p style="font-size:0.85rem;color:var(--txt2);margin-bottom:16px">${w.desc}</p>
  ${st!=='locked'&&curStep?`<h3>Current: ${curStep.t}</h3>${guidanceHtml}`:''}
  <div class="divider"></div><h3 style="margin-bottom:8px">Steps</h3>
  <div class="step-list">${stepsHtml}</div>${actions}`);
}

// === TRAINING RITUAL ===
let ritual={active:false,ward:null,step:null,timer:null,elapsed:0,duration:180,ok:0,no:0,paused:false,holds:[],holdStart:null};

function startRitual(wardId){
 const w=wardById(wardId),p=D.progress[wardId];
 // First time flow
 if(!p.startedAt&&!p.masteredAt){showFirstTimeModal(w);return;}
 showPreSession(w);
}

function showFirstTimeModal(w){
 let html=`<div class="modal-header"><h2>Where is Zuzu with this Ward?</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>
  <p class="text-dim mb-8" style="font-size:0.85rem">Pick the step that matches her current ability:</p>
  <div class="step-list">`;
 w.steps.forEach((s,i)=>{
  html+=`<div class="step-item current" style="cursor:pointer;opacity:1" onclick="pickStartStep('${w.id}',${i})">
   <div class="step-num">${i+1}</div>
   <div class="step-info"><div class="step-title">${s.t}</div><div class="step-desc">${s.d}</div></div></div>`;
 });
 html+=`</div>`;openModal(html);
}

function pickStartStep(wardId,stepIdx){
 D.progress[wardId].step=stepIdx;D.progress[wardId].startedAt=new Date().toISOString();
 save();closeModal();showPreSession(wardById(wardId));
}

function showPreSession(w){
 const p=D.progress[w.id],step=w.steps[p.step],cap=step.capture;
 switchTab('ritual');
 const g=step.guidance||{};
 let guidanceHtml=`<div class="guidance-box">
  ${g.vocal?`<div class="g-item"><span class="g-label">Voice</span><span>${g.vocal}</span></div>`:''}
  ${g.hand?`<div class="g-item"><span class="g-label">Hand</span><span>${g.hand}</span></div>`:''}
  ${g.position?`<div class="g-item"><span class="g-label">Pos</span><span>${g.position}</span></div>`:''}
 </div>`;
 let capInfo=cap.type==='reps'?'Track: '+cap.successLabel+' / '+cap.missLabel:
  cap.type==='duration'?'Track: Hold duration':
  cap.type==='observe'?'Track: '+cap.successLabel+' (observe only)':'Track: Timed reps';
 $('#tab-ritual').innerHTML=`<div class="card">
  <h2>${w.name}</h2>
  <div class="text-dim" style="font-size:0.8rem">Step ${p.step+1}: ${step.t}</div>
  <p style="font-size:0.85rem;margin:8px 0">${step.d}</p>
  ${guidanceHtml}
  <div class="text-dim mt-8" style="font-size:0.8rem">${capInfo}</div>
 </div>
 <div class="text-center"><div class="label mb-8">Duration</div>
  <div class="dur-chips">
   ${[60,120,180,300].map(d=>`<div class="dur-chip${d===D.settings.duration?' active':''}" onclick="selectDuration(${d},this)">${d<120?d+'s':d/60+'m'}</div>`).join('')}
  </div>
 </div>
 <button class="btn btn-pri btn-block btn-lg mt-12" onclick="beginCountdown('${w.id}')">Begin Ritual</button>`;
}

function selectDuration(d,el){
 D.settings.duration=d;save();
 $$('.dur-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');
}

function beginCountdown(wardId){
 const overlay=$('#countdown');overlay.style.display='flex';
 let count=3;
 overlay.innerHTML=`<span>${count}</span>`;
 const iv=setInterval(()=>{
  count--;
  if(count>0){overlay.innerHTML=`<span>${count}</span>`;}
  else if(count===0){overlay.innerHTML=`<span>Begin!</span>`;}
  else{clearInterval(iv);overlay.style.display='none';runSession(wardId);}
 },700);
}

function runSession(wardId){
 const w=wardById(wardId),p=D.progress[wardId],step=w.steps[p.step],cap=step.capture;
 ritual={active:true,ward:w,step:p.step,elapsed:0,duration:D.settings.duration,ok:0,no:0,paused:false,holds:[],holdStart:null,wardId:wardId};
 const renderUI=()=>{
  let captureHtml='';
  if(cap.type==='reps'||cap.type==='timed_reps'){
   captureHtml=`<div class="cap-row">
    <button class="cap-wide success" onclick="captureOk()"><span class="count" id="okCount">${ritual.ok}</span>${cap.successLabel}</button>
    ${cap.missLabel?`<button class="cap-wide miss" onclick="captureNo()"><span class="count" id="noCount">${ritual.no}</span>${cap.missLabel}</button>`:''}
   </div>`;
  }else if(cap.type==='observe'){
   captureHtml=`<div class="cap-row">
    <button class="cap-wide observe" onclick="captureOk()"><span class="count" id="okCount">${ritual.ok}</span>${cap.successLabel}</button>
   </div>`;
  }else if(cap.type==='duration'){
   captureHtml=`<div class="capture-area" style="flex-direction:column;align-items:center">
    <button class="hold-btn" id="holdBtn" onclick="toggleHold()">${ritual.holdStart?'Holding...':'Tap to Start Hold'}</button>
    <div id="holdTime" style="font-size:1.2rem;color:var(--acc);margin-top:8px;font-variant-numeric:tabular-nums">0:00</div>
    ${cap.missLabel?`<div class="cap-row" style="margin-top:12px">
     <button class="cap-wide success" onclick="captureOk()"><span class="count" id="okCount">${ritual.ok}</span>${cap.successLabel}</button>
     <button class="cap-wide miss" onclick="captureNo()"><span class="count" id="noCount">${ritual.no}</span>${cap.missLabel}</button>
    </div>`:`<div class="session-stats mt-8"><span><span class="val" id="okCount">${ritual.ok}</span>${cap.successLabel||'good'}</span></div>`}
    <div class="session-stats mt-8"><span><span class="val" id="holdCount">${ritual.holds.length}</span>holds</span>
     <span><button class="undo-btn" onclick="undoLastCapture()">Undo</button></span>
    </div>
   </div>`;
  }
  let statsHtml='';
  if(cap.type==='reps'||cap.type==='timed_reps'){
   const rate=getRate(ritual.ok,ritual.no);
   statsHtml=`<div class="session-stats"><span><span class="val" id="statTotal">${ritual.ok+ritual.no}</span>total</span>
    <span><span class="val" id="statRate">${rate}%</span>rate</span>
    <span><button class="undo-btn" onclick="undoLastCapture()">Undo</button></span></div>`;
  }else if(cap.type==='observe'){
   statsHtml=`<div class="session-stats"><span><button class="undo-btn" onclick="undoLastCapture()">Undo</button></span></div>`;
  }
  $('#tab-ritual').innerHTML=`
   <div class="session-timer" id="sessionTimer">${fmtTime(ritual.duration-ritual.elapsed)}</div>
   ${captureHtml}${statsHtml}
   <div style="display:flex;gap:8px;justify-content:center;margin-top:16px">
    <button class="btn btn-sec btn-sm" onclick="togglePause()" id="pauseBtn">${ritual.paused?'Resume':'Pause'}</button>
    <button class="btn btn-sec btn-sm" onclick="endSessionEarly()">End Early</button>
   </div>
   <details style="margin-top:16px"><summary class="text-dim" style="font-size:0.8rem;cursor:pointer">Step Instructions</summary>
    <p style="font-size:0.8rem;margin-top:8px">${step.d}</p></details>`;
 };
 renderUI();
 ritual.timer=setInterval(()=>{
  if(ritual.paused)return;
  ritual.elapsed++;
  const remaining=ritual.duration-ritual.elapsed;
  const timerEl=$('#sessionTimer');
  if(timerEl)timerEl.textContent=fmtTime(Math.max(0,remaining));
  // Update hold timer if active
  if(ritual.holdStart){
   const ht=$('#holdTime');
   if(ht)ht.textContent=fmtTime(Math.floor((Date.now()-ritual.holdStart)/1000));
  }
  if(remaining<=0){endSession();}
 },1000);
}

let lastCapture=null;

function captureOk(){
 ritual.ok++;lastCapture={type:'ok'};
 const el=$('#okCount');if(el)el.textContent=ritual.ok;
 updateSessionStats();
 if(navigator.vibrate)navigator.vibrate(50);
}

function captureNo(){
 ritual.no++;lastCapture={type:'no'};
 const el=$('#noCount');if(el)el.textContent=ritual.no;
 updateSessionStats();
 if(navigator.vibrate)navigator.vibrate([30,30,30]);
}

function undoLastCapture(){
 if(!lastCapture)return;
 if(lastCapture.type==='ok'){
  ritual.ok--;
  if(lastCapture.holdDur!=null){ritual.holds.pop();const hc=$('#holdCount');if(hc)hc.textContent=ritual.holds.length;}
  const el=$('#okCount');if(el)el.textContent=ritual.ok;
 }else{
  ritual.no--;
  const el=$('#noCount');if(el)el.textContent=ritual.no;
 }
 lastCapture=null;updateSessionStats();toast('Undone');
}

function updateSessionStats(){
 const total=ritual.ok+ritual.no;
 const rate=getRate(ritual.ok,ritual.no);
 const t=$('#statTotal');if(t)t.textContent=total;
 const r=$('#statRate');if(r)r.textContent=rate+'%';
}

function toggleHold(){
 const btn=$('#holdBtn');
 if(!ritual.holdStart){
  ritual.holdStart=Date.now();
  if(btn){btn.classList.add('holding');btn.textContent='Holding...';}
 }else{
  const dur=Math.floor((Date.now()-ritual.holdStart)/1000);
  ritual.holds.push(dur);ritual.ok++;ritual.holdStart=null;lastCapture={type:'ok',holdDur:dur};
  if(btn){btn.classList.remove('holding');btn.textContent='Tap to Start Hold';}
  const hc=$('#holdCount');if(hc)hc.textContent=ritual.holds.length;
  const oc=$('#okCount');if(oc)oc.textContent=ritual.ok;
  const ht=$('#holdTime');if(ht)ht.textContent=fmtTime(dur)+' (last)';
 }
}

function togglePause(){
 ritual.paused=!ritual.paused;
 const btn=$('#pauseBtn');if(btn)btn.textContent=ritual.paused?'Resume':'Pause';
}

function endSessionEarly(){ritual.elapsed=ritual.duration;endSession();}

function endSession(){
 if(!ritual.active)return;
 clearInterval(ritual.timer);ritual.active=false;
 playDing();if(navigator.vibrate)navigator.vibrate(200);
 const timerEl=$('#sessionTimer');
 if(timerEl){timerEl.textContent='0:00';timerEl.classList.add('flash');}
 setTimeout(()=>showSummary(),800);
}

function showSummary(){
 const w=ritual.ward,p=D.progress[w.id],step=w.steps[ritual.step],cap=step.capture;
 const rate=getRate(ritual.ok,ritual.no);
 // Save session
 const sess={id:uid(),sid:w.id,dt:new Date().toISOString(),step:ritual.step,
  ok:ritual.ok,no:cap.missLabel?ritual.no:null,dur:Math.min(ritual.elapsed,ritual.duration),
  notes:'',captureType:cap.type};
 D.sessions.push(sess);
 if(!p.startedAt)p.startedAt=new Date().toISOString();
 save();
 // Calculate rolling average
 const recent=D.sessions.filter(s=>s.sid===w.id&&s.step===ritual.step).slice(-D.settings.evalSessions);
 const avgRate=recent.length?Math.round(recent.reduce((a,s)=>a+getRate(s.ok,s.no||0),0)/recent.length):rate;
 let recommendation='';let canAdvance=false;
 if(cap.type==='observe'){
  recommendation='Great observation session!';
  const validObs=recent.filter(s=>s.ok>=1);
  if(validObs.length>=D.settings.evalSessions)canAdvance=true;
 }else if(avgRate>=D.settings.threshold&&recent.length>=D.settings.evalSessions){
  recommendation='Ready to advance to next step!';canAdvance=true;
 }else if(avgRate<50){
  recommendation='Consider reinforcing the previous step -- regression is normal.';
 }else{
  recommendation='Keep practicing -- Zuzu is getting there!';
 }
 const isLastStep=ritual.step>=w.steps.length-1;
 let advanceBtn='';
 if(canAdvance&&!isLastStep){
  advanceBtn=`<button class="btn btn-ok btn-block mt-8" onclick="advanceStep('${w.id}')">Advance to Next Step</button>`;
 }else if(canAdvance&&isLastStep){
  advanceBtn=`<button class="btn btn-pri btn-block mt-8" onclick="sealWard('${w.id}')">Seal This Ward!</button>`;
 }
 let statsHtml='';
 if(cap.type==='duration'){
  const avg=ritual.holds.length?Math.round(ritual.holds.reduce((a,b)=>a+b,0)/ritual.holds.length):0;
  const best=ritual.holds.length?Math.max(...ritual.holds):0;
  statsHtml=`<div class="profile-stats"><div class="stat"><div class="stat-val">${ritual.holds.length}</div><div class="stat-lbl">Holds</div></div>
   <div class="stat"><div class="stat-val">${fmtTime(avg)}</div><div class="stat-lbl">Avg</div></div>
   <div class="stat"><div class="stat-val">${fmtTime(best)}</div><div class="stat-lbl">Best</div></div></div>`;
 }else if(cap.missLabel){
  statsHtml=`<div class="profile-stats"><div class="stat"><div class="stat-val">${ritual.ok}</div><div class="stat-lbl">${cap.successLabel}</div></div>
   <div class="stat"><div class="stat-val">${ritual.no}</div><div class="stat-lbl">${cap.missLabel}</div></div>
   <div class="stat"><div class="stat-val">${rate}%</div><div class="stat-lbl">Rate</div></div></div>`;
 }else{
  statsHtml=`<div class="profile-stats"><div class="stat"><div class="stat-val">${ritual.ok}</div><div class="stat-lbl">${cap.successLabel}</div></div></div>`;
 }
 $('#tab-ritual').innerHTML=`<div class="card text-center">
  <h2>Ritual Complete</h2>
  <div class="text-dim mb-8">${w.name} -- Step ${ritual.step+1}: ${step.t}</div>
  ${statsHtml}
  <div class="text-dim mt-8" style="font-size:0.85rem">${avgRate}% rolling avg over ${recent.length} session${recent.length!==1?'s':''}</div>
  <div class="divider"></div>
  <p style="font-size:0.9rem">${recommendation}</p>
  ${advanceBtn}
  <div class="form-group mt-12"><label>Session Notes</label>
   <textarea id="sessionNotes" placeholder="${cap.notes_prompt}"></textarea></div>
  <button class="btn btn-sec btn-block" onclick="saveSessionNotes('${sess.id}')">Save Notes</button>
 </div>
 <button class="btn btn-ghost btn-block mt-8" onclick="renderRitualTab()">Back to Ward List</button>`;
 checkMilestones();
}

function saveSessionNotes(sessId){
 const notes=$('#sessionNotes').value;
 const s=D.sessions.find(s=>s.id===sessId);
 if(s){s.notes=notes;save();toast('Notes saved');}
}

function advanceStep(wardId){
 const p=D.progress[wardId],w=wardById(wardId);
 if(p.step<w.steps.length-1){p.step++;save();toast('Advanced to step '+(p.step+1));}
 renderRitualTab();
}

function sealWard(wardId){
 D.progress[wardId].masteredAt=new Date().toISOString();
 save();updateUnlocks();save();
 toast('Ward of '+wardById(wardId).name+' has been Sealed!');
 // Check for newly unlocked wards
 WARDS.forEach(w=>{
  if(w.prereqs.includes(wardId)&&D.progress[w.id].unlocked&&!D.progress[w.id].startedAt){
   toast(w.name+' is now available!');
  }
 });
 checkMilestones();renderRitualTab();
}

function checkMilestones(){
 const streak=calcVigil();
 INSCRIPTIONS.forEach(ins=>{
  if(D.milestones.some(m=>m.id===ins.id))return;
  if(ins.check(D,streak)){
   D.milestones.push({id:ins.id,t:ins.t,ic:ins.ic,dt:new Date().toISOString()});
   toast('Inscription: '+ins.t);
  }
 });
 save();
}

// === AUDIO ===
function playDing(){
 if(!D.settings.soundEnabled)return;
 try{
  const ctx=new(window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator(),gain=ctx.createGain();
  osc.connect(gain);gain.connect(ctx.destination);
  osc.type='sine';osc.frequency.value=880;
  gain.gain.setValueAtTime(0.3,ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.8);
  osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.8);
  const osc2=ctx.createOscillator(),gain2=ctx.createGain();
  osc2.connect(gain2);gain2.connect(ctx.destination);
  osc2.type='sine';osc2.frequency.value=1318.5;
  gain2.gain.setValueAtTime(0.2,ctx.currentTime+0.15);
  gain2.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+1);
  osc2.start(ctx.currentTime+0.15);osc2.stop(ctx.currentTime+1);
 }catch(e){}
}

// === RITUAL TAB (ward selector) ===
function renderRitualTab(){
 if(ritual.active)return; // Don't overwrite active session
 const available=WARDS.filter(w=>D.progress[w.id].unlocked&&!D.progress[w.id].masteredAt);
 const sealed=WARDS.filter(w=>D.progress[w.id].masteredAt);
 let html=`<h2 class="mb-8">Begin a Ritual</h2>`;
 if(available.length){
  html+=`<div class="label mb-8">Available Wards</div>`;
  available.forEach(w=>{
   const p=D.progress[w.id],step=w.steps[p.step];
   html+=`<div class="rite-item" onclick="startRitual('${w.id}')">
    <div class="rite-abbr">${w.abbr}</div>
    <div class="rite-name">${w.name}</div>
    <div class="rite-step">Step ${p.step+1}: ${step?step.t:''}</div></div>`;
  });
 }
 if(sealed.length){
  html+=`<div class="label mt-12 mb-8">Sealed Wards (practice)</div>`;
  sealed.forEach(w=>{
   html+=`<div class="rite-item" onclick="startRitual('${w.id}')" style="opacity:0.7">
    <div class="rite-abbr" style="background:var(--pri);color:var(--bg);border-color:var(--pri)">${w.abbr}</div>
    <div class="rite-name">${w.name}</div>
    <div class="rite-step text-ok">Sealed</div></div>`;
  });
 }
 if(!available.length&&!sealed.length){
  html+=`<div class="empty-state">No wards available yet. Check the Ward Tree!</div>`;
 }
 $('#tab-ritual').innerHTML=html;
}

// === ALONE TIMER ===
let aloneInterval=null;

function startAloneTimer(){
 D.aloneTimerState={running:true,startTime:Date.now(),elapsed:0};
 save();resumeAloneTimer();toast('Alone timer started');
}

function resumeAloneTimer(){
 if(!D.aloneTimerState.running)return;
 $('#alonePill').classList.add('active');
 if(aloneInterval)clearInterval(aloneInterval);
 aloneInterval=setInterval(updateAlonePill,1000);
 updateAlonePill();
}

function updateAlonePill(){
 if(!D.aloneTimerState.running)return;
 const elapsed=Math.floor((Date.now()-D.aloneTimerState.startTime)/1000)+D.aloneTimerState.elapsed;
 const timeStr=fmtTime(elapsed);
 $('#alonePillTime').textContent=timeStr;
 const shrineEl=$('#shrineAloneTime');
 if(shrineEl)shrineEl.textContent=timeStr;
}

function getAloneElapsed(){
 if(!D.aloneTimerState.running)return 0;
 return Math.floor((Date.now()-D.aloneTimerState.startTime)/1000)+D.aloneTimerState.elapsed;
}

function stopAloneTimer(){
 const elapsed=getAloneElapsed();
 D.aloneTimerState={running:false,startTime:null,elapsed:0};
 save();$('#alonePill').classList.remove('active');
 if(aloneInterval){clearInterval(aloneInterval);aloneInterval=null;}
 return elapsed;
}

function openAloneForm(){
 const isRunning=D.aloneTimerState&&D.aloneTimerState.running;
 const elapsed=isRunning?getAloneElapsed():0;
 let html=`<div class="modal-header"><h2>Alone Time</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>`;
 if(isRunning){
  html+=`<div class="text-center mb-8"><div class="vigil-number" style="color:var(--bad)">${fmtTime(elapsed)}</div>
   <div class="text-dim">Timer running</div></div>
   <button class="btn btn-bad btn-block mb-8" onclick="finishAloneTime()">Stop & Log</button>`;
 }else{
  html+=`<button class="btn btn-pri btn-block mb-8" onclick="closeModal();startAloneTimer()">Start Alone Timer</button>
   <div class="divider"></div><h3 class="mb-8">Log Past Alone Time</h3>`;
 }
 html+=aloneFormFields(elapsed);
 openModal(html);
}

function aloneFormFields(dur){
 return`<div class="form-group"><label>Duration (minutes)</label>
  <input type="number" id="aloneDur" value="${Math.round(dur/60)}" min="0"></div>
 <div class="form-group"><label>Location</label>
  <div class="chip-group" id="aloneLoc">${['Crate','Room','House','Yard'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Distance</label>
  <div class="chip-group" id="aloneDist">${['Door','Room','Floor','Out'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Departure Reaction</label>
  <div class="chip-group" id="aloneDepart">${['Calm','Noticed','Whined','Barked','Panicked'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Arrival Reaction</label>
  <div class="chip-group" id="aloneArrive">${['Calm','Excited','Frantic','Ignored'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Body Language Observed</label>
  <div class="body-chip-grid" id="aloneBody">${BODY_SIGNALS.map(s=>
   `<div class="body-chip" onclick="this.classList.toggle('active')">${s}</div>`).join('')}</div></div>
 <div class="form-group"><label>Vocalization</label>
  <div class="chip-group" id="aloneVocal">${['None','Whining','Barking','Howling','Crying'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Enrichment Used</label>
  <div class="chip-group" id="aloneEnrich">${['None','Kong','Puzzle','Chew','Lick mat'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Notes</label>
  <textarea id="aloneNotes" placeholder="How did it go?"></textarea></div>
 <button class="btn btn-pri btn-block" onclick="saveAloneLog()">Save Alone Log</button>`;
}

function toggleChip(el){
 el.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
 el.classList.add('active');
}

function getActiveChip(parentId){
 const el=document.querySelector('#'+parentId+' .chip.active');
 return el?el.textContent.toLowerCase():'';
}

function finishAloneTime(){
 const elapsed=stopAloneTimer();
 const durInput=$('#aloneDur');if(durInput)durInput.value=Math.round(elapsed/60);
}

function saveAloneLog(){
 const dur=parseInt($('#aloneDur').value||'0')*60;
 const bodyLangs=[...document.querySelectorAll('#aloneBody .body-chip.active')].map(e=>e.textContent);
 D.aloneLogs.push({id:uid(),dt:new Date().toISOString(),dur:dur,
  loc:getActiveChip('aloneLoc'),dist:getActiveChip('aloneDist'),
  departureReaction:getActiveChip('aloneDepart'),arrivalReaction:getActiveChip('aloneArrive'),
  bodyLanguage:bodyLangs,vocalization:getActiveChip('aloneVocal'),
  enrichmentUsed:getActiveChip('aloneEnrich'),
  notes:$('#aloneNotes').value,calm:''});
 save();closeModal();toast('Alone time logged');checkMilestones();
 if(activeTab==='shrine')renderShrine();
}

// === POTTY LOG ===
function openPottyForm(){
 openModal(`<div class="modal-header"><h2>Log Potty</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>
 <div class="form-group"><label>Type</label>
  <div class="chip-group" id="pottyType">${['Pee','Poop','Both'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Location</label>
  <div class="chip-group" id="pottyLoc">${['Outside','Inside'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Context</label>
  <div class="chip-group" id="pottyCtx">${['After meal','After nap','After play','Morning','Bedtime'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Surface</label>
  <div class="chip-group" id="pottySurf">${['Grass','Concrete','Gravel','Pad','Floor'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Signal Given</label>
  <div class="chip-group" id="pottySig">${['None','Sniffing','Circling','Door','Whining'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Notes</label>
  <textarea id="pottyNotes" placeholder="Any details?"></textarea></div>
 <button class="btn btn-pri btn-block" onclick="savePottyLog()">Save</button>`);
}

function savePottyLog(){
 D.pottyLogs.push({id:uid(),dt:new Date().toISOString(),
  type:getActiveChip('pottyType'),loc:getActiveChip('pottyLoc'),
  ctx:getActiveChip('pottyCtx'),surface:getActiveChip('pottySurf'),
  signalGiven:getActiveChip('pottySig'),notes:$('#pottyNotes').value,photo:''});
 save();closeModal();toast('Potty logged');checkMilestones();
 if(activeTab==='shrine')renderShrine();
}

// === ENRICHMENT LOG ===
function openEnrichmentForm(){
 openModal(`<div class="modal-header"><h2>Log Enrichment</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>
 <div class="form-group"><label>Type</label>
  <div class="chip-group" id="enrichType">${['Kong','Puzzle','Lick mat','Snuffle mat','Scatter feed','Decompression walk','Flirt pole','Chew','Other'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Duration (minutes)</label>
  <input type="number" id="enrichDur" value="10" min="1"></div>
 <div class="form-group"><label>Engagement</label>
  <div class="chip-group" id="enrichEng">${['High','Medium','Low','Refused'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Notes</label>
  <textarea id="enrichNotes" placeholder="What worked well?"></textarea></div>
 <button class="btn btn-pri btn-block" onclick="saveEnrichmentLog()">Save</button>`);
}

function saveEnrichmentLog(){
 D.enrichmentLogs.push({id:uid(),dt:new Date().toISOString(),
  type:getActiveChip('enrichType'),duration:parseInt($('#enrichDur').value||'0'),
  engagement:getActiveChip('enrichEng'),notes:$('#enrichNotes').value});
 save();closeModal();toast('Enrichment logged');
 if(activeTab==='shrine')renderShrine();
}

// === BEHAVIOR LOG ===
function openBehaviorForm(){
 openModal(`<div class="modal-header"><h2>Log Behavior</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>
 <div class="form-group"><label>Category</label>
  <div class="chip-group" id="behCat">${['Reactivity','Fear','Excitement','Resource guarding','Aggression','Positive social','Other'].map((v,i)=>
   `<div class="chip${i===0?' active':''}" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Trigger</label>
  <input type="text" id="behTrigger" placeholder="What caused it?"></div>
 <div class="form-group"><label>Intensity</label>
  <div class="chip-group" id="behInt">${['Mild','Moderate','Severe'].map(v=>
   `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
 <div class="form-group"><label>Body Language</label>
  <div class="body-chip-grid" id="behBody">${BODY_SIGNALS.map(s=>
   `<div class="body-chip" onclick="this.classList.toggle('active')">${s}</div>`).join('')}</div></div>
 <div class="form-group"><label>Your Response</label>
  <input type="text" id="behResponse" placeholder="What did you do?"></div>
 <div class="form-group"><label>Outcome</label>
  <input type="text" id="behOutcome" placeholder="How did it resolve?"></div>
 <div class="form-group"><label>Notes</label>
  <textarea id="behNotes" placeholder="Additional details"></textarea></div>
 <button class="btn btn-pri btn-block" onclick="saveBehaviorLog()">Save</button>`);
}

function saveBehaviorLog(){
 const bodyLangs=[...document.querySelectorAll('#behBody .body-chip.active')].map(e=>e.textContent);
 D.behaviorNotes.push({id:uid(),dt:new Date().toISOString(),
  category:getActiveChip('behCat'),trigger:$('#behTrigger').value,
  intensity:getActiveChip('behInt'),bodyLanguage:bodyLangs,
  response:$('#behResponse').value,outcome:$('#behOutcome').value,
  notes:$('#behNotes').value});
 save();closeModal();toast('Behavior logged');
 if(activeTab==='shrine')renderShrine();
}

// === DAILY SCHEDULE ===
const SCHEDULE_TYPES=[
 {key:'wake',label:'Wake/Uncrate',abbr:'WK',details:['Calm','Excited','Whining','Barking']},
 {key:'cuddle',label:'Cuddle',abbr:'CU',details:['Lap','Couch','Floor','Refused']},
 {key:'mouth',label:'Mouthing',abbr:'MO',details:['Hands','Feet','Clothes','Redirected','Gentle']},
 {key:'meal',label:'Meal',abbr:'ML',details:['Breakfast','Lunch','Dinner','Ate all','Partial','Refused']},
 {key:'walk',label:'Walk',abbr:'WA',details:['Short','Medium','Long','Sniffari']},
 {key:'nap',label:'Nap/Crate',abbr:'NP',details:['Crate','Bed','Couch','Floor']},
 {key:'bedtime',label:'Bedtime',abbr:'BD',details:['Calm','Fussy','Needed settling']}
];

function openScheduleLog(typeKey){
 const st=SCHEDULE_TYPES.find(t=>t.key===typeKey);if(!st)return;
 openModal(`<div class="modal-header"><h2>${st.label}</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>
  <div class="form-group"><label>Detail</label>
   <div class="chip-group" id="schedDetail">${st.details.map(v=>
    `<div class="chip" onclick="toggleChip(this)">${v}</div>`).join('')}</div></div>
  <div class="form-group"><label>Notes</label>
   <textarea id="schedNotes" placeholder="Quick note (optional)"></textarea></div>
  <button class="btn btn-pri btn-block" onclick="saveScheduleEntry('${st.key}')">Log</button>`);
}

function saveScheduleEntry(typeKey){
 D.dailySchedule.push({id:uid(),dt:new Date().toISOString(),type:typeKey,
  detail:getActiveChip('schedDetail'),notes:$('#schedNotes').value});
 save();closeModal();toast('Logged');
 if(activeTab==='shrine')renderShrine();
}

function getTodaySchedule(){
 const td=today();
 return D.dailySchedule.filter(e=>e.dt.slice(0,10)===td).sort((a,b)=>new Date(a.dt)-new Date(b.dt));
}

function deleteScheduleEntry(id){
 D.dailySchedule=D.dailySchedule.filter(e=>e.id!==id);save();renderShrine();
}

function renderTimeline(){
 const entries=getTodaySchedule();
 if(!entries.length)return'<div class="text-dim" style="font-size:0.8rem;padding:8px 0">No entries yet today. Tap an event above to start logging.</div>';
 return entries.map(e=>{
  const st=SCHEDULE_TYPES.find(t=>t.key===e.type)||{abbr:'??',label:e.type};
  const time=new Date(e.dt).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  return`<div class="history-item" style="position:relative">
   <div style="position:absolute;left:15px;top:0;bottom:-12px;width:2px;background:var(--brd)"></div>
   <div class="h-abbr" style="z-index:1">${st.abbr}</div>
   <div class="h-info"><div class="h-title">${st.label}${e.detail?' — '+e.detail:''}</div>
    ${e.notes?'<div class="h-detail">'+e.notes+'</div>':''}
    <div class="h-date">${time}</div></div>
   <button style="background:none;border:none;color:var(--txt3);font-size:1rem;padding:8px;cursor:pointer" onclick="deleteScheduleEntry('${e.id}')">x</button>
  </div>`;
 }).join('');
}

// === QUICK LOG (one-tap) ===
function quickLog(typeKey){
 D.dailySchedule.push({id:uid(),dt:new Date().toISOString(),type:typeKey,detail:'',notes:''});
 save();toast('Logged');
 if(activeTab==='shrine')renderShrine();
}

function quickStopAlone(){
 const elapsed=stopAloneTimer();
 D.aloneLogs.push({id:uid(),dt:new Date().toISOString(),dur:elapsed,
  loc:'',dist:'',departureReaction:'',arrivalReaction:'',
  bodyLanguage:[],vocalization:'',enrichmentUsed:'',notes:'',calm:''});
 save();toast('Alone time logged: '+fmtDur(elapsed));checkMilestones();
 if(activeTab==='shrine')renderShrine();
}

function toggleTimeline(el){
 el.classList.toggle('open');
 const content=$('#timelineContent');
 if(content)content.style.display=content.style.display==='none'?'':'none';
}

// === SHRINE (HOME) ===
function renderShrine(){
 const streak=calcVigil();
 const totalRituals=D.sessions.length;
 const sealedWards=WARDS.filter(w=>D.progress[w.id].masteredAt).length;
 const rite=getDailyRite();
 const todayEntries=getTodaySchedule();
 const timelineCollapsed=todayEntries.length>5;

 let riteHtml=rite.map(w=>{
  const p=D.progress[w.id],step=w.steps[p.step];
  return`<div class="rite-item" onclick="startRitual('${w.id}')">
   <div class="rite-abbr">${w.abbr}</div>
   <div class="rite-name">${w.name}</div>
   <div class="rite-step">${step?step.t:''}</div></div>`;
 }).join('')||'<div class="text-dim" style="font-size:0.85rem">Complete all wards or start training!</div>';

 let aloneHtml='';
 if(D.aloneTimerState&&D.aloneTimerState.running){
  aloneHtml=`<div class="alone-shrine">
   <div class="as-dot"></div>
   <div class="as-time" id="shrineAloneTime">${fmtTime(getAloneElapsed())}</div>
   <button class="btn btn-bad btn-sm" onclick="quickStopAlone()">Stop & Log</button>
  </div>`;
 }

 const aloneAction=D.aloneTimerState&&D.aloneTimerState.running?'openAloneForm()':'startAloneTimer()';

 $('#tab-shrine').innerHTML=`
  <div style="position:relative">
   <button class="gear-btn" onclick="openSettings()"><svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.48.48 0 00-.48-.41h-3.84a.48.48 0 00-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87a.48.48 0 00.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.26.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1115.6 12 3.61 3.61 0 0112 15.6z"/></svg></button>
   <div class="shrine-profile">
    <div class="shrine-portrait"><svg viewBox="0 0 64 64" fill="none" stroke="var(--pri)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
     <path d="M14 28c-3-12 0-18 4-22c2-2 4-1 5 2c1 4 3 8 8 10"/>
     <path d="M50 28c3-12 0-18-4-22c-2-2-4-1-5 2c-1 4-3 8-8 10"/>
     <ellipse cx="32" cy="36" rx="16" ry="18"/>
     <circle cx="24" cy="32" r="2.5" fill="var(--pri)" stroke="none"/>
     <circle cx="40" cy="32" r="2.5" fill="var(--pri)" stroke="none"/>
     <ellipse cx="32" cy="40" rx="4" ry="2.5" fill="var(--pri)" stroke="none"/>
     <path d="M28 40c-2 3-3 5-2 7" stroke-width="1.5"/>
     <path d="M36 40c2 3 3 5 2 7" stroke-width="1.5"/>
    </svg></div>
    <div class="shrine-info">
     <h1>${D.profile.name}</h1>
     <div class="shrine-sub">${D.profile.breed} | Day ${streak} Vigil</div>
    </div>
   </div>
   <div class="shrine-stats">
    <div class="ss"><span class="sv">${streak}</span><span class="sl">Vigil</span></div>
    <div class="ss"><span class="sv">${totalRituals}</span><span class="sl">Rituals</span></div>
    <div class="ss"><span class="sv">${sealedWards}</span><span class="sl">Sealed</span></div>
    <div class="ss"><span class="sv">${WARDS.length - sealedWards}</span><span class="sl">Remaining</span></div>
   </div>
  </div>
  ${aloneHtml}
  <div class="section-header"><h3>Quick Log</h3></div>
  <div class="quick-grid">
   <button class="quick-btn cat-routine" onclick="quickLog('wake')">Wake</button>
   <button class="quick-btn cat-routine" onclick="quickLog('meal')">Meal</button>
   <button class="quick-btn cat-care" onclick="openPottyForm()">Potty</button>
   <button class="quick-btn cat-routine" onclick="quickLog('walk')">Walk</button>
   <button class="quick-btn cat-routine" onclick="quickLog('nap')">Nap</button>
   <button class="quick-btn cat-routine" onclick="quickLog('cuddle')">Cuddle</button>
   <button class="quick-btn cat-note" onclick="quickLog('mouth')">Mouth</button>
   <button class="quick-btn cat-care" onclick="openEnrichmentForm()">Enrich</button>
   <button class="quick-btn cat-alert" onclick="${aloneAction}">Alone</button>
   <button class="quick-btn cat-routine" onclick="quickLog('bedtime')">Bed</button>
  </div>
  <div style="margin-top:12px">
   <div class="timeline-toggle${timelineCollapsed?'':' open'}" onclick="toggleTimeline(this)">
    <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    <h3 style="margin:0">Today</h3>
    <span class="text-dim" style="font-size:0.75rem;margin-left:4px">${todayEntries.length} entries</span>
   </div>
  </div>
  <div id="timelineContent" style="${timelineCollapsed?'display:none':''}">
   ${renderTimeline()}
  </div>
  <div class="divider"></div>
  <div class="section-header"><h3>The Daily Rite</h3></div>
  <div class="rite-list">${riteHtml}</div>`;
}

function getDailyRite(){
 const available=WARDS.filter(w=>D.progress[w.id].unlocked&&!D.progress[w.id].masteredAt);
 if(!available.length)return[];
 // Score each ward
 return available.map(w=>{
  let score=0;
  const sessions=D.sessions.filter(s=>s.sid===w.id);
  const lastSession=sessions.length?new Date(sessions[sessions.length-1].dt):null;
  // Least recently practiced
  if(!lastSession)score+=100;
  else score+=Math.min(50,Math.floor((Date.now()-lastSession.getTime())/3600000));
  // Close to advancement
  const recent=sessions.filter(s=>s.step===D.progress[w.id].step).slice(-D.settings.evalSessions);
  if(recent.length){
   const avg=Math.round(recent.reduce((a,s)=>a+getRate(s.ok,s.no||0),0)/recent.length);
   if(avg>=60&&avg<D.settings.threshold)score+=30;
  }
  // Recently unlocked
  if(!D.progress[w.id].startedAt)score+=20;
  return{w,score};
 }).sort((a,b)=>b.score-a.score).slice(0,3).map(x=>x.w);
}

// === CHRONICLE (Session History) ===
let chronicleFilterVal='';
function renderChronicle(){
 let html=`<h2 class="mb-8">Chronicle</h2>`;
 // Filter
 html+=`<div class="form-group"><select id="chronicleFilter" onchange="chronicleFilterVal=this.value;renderChronicle()">
  <option value="">All Wards</option>
  ${WARDS.map(w=>`<option value="${w.id}"${chronicleFilterVal===w.id?' selected':''}>${w.name}</option>`).join('')}</select></div>`;
 const filter=chronicleFilterVal;
 let sessions=[...D.sessions].reverse();
 if(filter)sessions=sessions.filter(s=>s.sid===filter);
 if(!sessions.length){html+=`<div class="empty-state">No rituals recorded yet.</div>`;$('#tab-chronicle').innerHTML=html;return;}
 sessions.slice(0,50).forEach(s=>{
  const w=wardById(s.sid);if(!w)return;
  const rate=getRate(s.ok,s.no||0);
  const step=w.steps[s.step];
  html+=`<div class="history-item"><div class="h-abbr">${w.abbr}</div>
   <div class="h-info"><div class="h-title">${w.name} -- ${step?step.t:'Step '+(s.step+1)}</div>
    <div class="h-detail">${s.ok} ${s.captureType==='observe'?'observed':'ok'}${s.no!=null?' / '+s.no+' miss':''}${s.no!=null?' ('+rate+'%)':''} | ${fmtDur(s.dur)}</div>
    ${s.notes?'<div class="h-detail" style="color:var(--txt)">'+s.notes+'</div>':''}
    <div class="h-date">${fmtDate(s.dt)}</div></div></div>`;
 });
 $('#tab-chronicle').innerHTML=html;
}

// === CHRONICLES (Progress) ===
function renderChronicles(){
 let html=`<h2 class="mb-8">Chronicles</h2>`;
 // Heatmap
 html+=`<div class="card"><h3>Activity</h3>${renderHeatmap()}</div>`;
 // Inscriptions
 const earned=D.milestones.slice().reverse();
 if(earned.length){
  html+=`<div class="card"><h3>Inscriptions</h3>`;
  earned.forEach(m=>{
   html+=`<div class="inscription"><div class="ins-icon">${m.ic}</div>
    <div style="flex:1"><div class="ins-text">${m.t}</div><div class="ins-date">${fmtDate(m.dt)}</div></div></div>`;
  });
  html+=`</div>`;
 }
 // Separation chart
 if(D.aloneLogs.length>1){
  html+=`<div class="card"><h3>Separation Progress</h3><div class="sep-chart" style="height:100px">${renderSepChart()}</div></div>`;
 }
 // Ward progress bars
 html+=`<div class="card"><h3>Ward Progress</h3>`;
 WARDS.forEach(w=>{
  const p=D.progress[w.id];if(!p.unlocked&&!p.masteredAt)return;
  const pct=p.masteredAt?100:Math.round(p.step/w.steps.length*100);
  html+=`<div class="ward-progress"><div class="abbr${p.masteredAt?' sealed':''}">${w.abbr}</div>
   <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
   <div class="step-text">${p.masteredAt?'Sealed':p.step+'/'+w.steps.length}</div></div>`;
 });
 html+=`</div>`;
 $('#tab-chronicles').innerHTML=html;
}

function renderHeatmap(){
 const now=new Date();const totalDays=56;
 const counts={};
 D.sessions.forEach(s=>{const d=s.dt.slice(0,10);counts[d]=(counts[d]||0)+1;});
 // Build array of dates from 55 days ago to today
 const days=[];
 for(let i=totalDays-1;i>=0;i--){
  const d=new Date(now);d.setDate(d.getDate()-i);days.push(d);
 }
 // Find the Monday on or before the first day
 const firstDay=days[0];const dow=firstDay.getDay();
 const mondayOffset=(dow===0?6:dow-1); // days since Monday
 // Pad start with empty cells to align to Monday
 const padded=[];for(let i=0;i<mondayOffset;i++)padded.push(null);
 padded.push(...days);
 // Group into weeks (columns of 7 rows: Mon-Sun)
 const weeks=[];
 for(let i=0;i<padded.length;i+=7){weeks.push(padded.slice(i,i+7));}
 let html='<div class="heatmap">';
 weeks.forEach(week=>{
  html+='<div class="heatmap-week">';
  for(let d=0;d<7;d++){
   const date=week[d];
   if(!date){html+='<div class="heatmap-cell"></div>';continue;}
   const ds=date.toISOString().slice(0,10);
   const c=counts[ds]||0;
   const lvl=c===0?'':c===1?'l1':c===2?'l2':c<=4?'l3':'l4';
   html+=`<div class="heatmap-cell ${lvl}" title="${ds}: ${c}"></div>`;
  }
  html+='</div>';
 });
 html+='</div>';return html;
}

function renderSepChart(){
 const logs=D.aloneLogs.slice(-20);if(!logs.length)return'';
 const maxDur=Math.max(...logs.map(l=>l.dur));
 const w=360,h=90,pad=5;
 let svg=`<svg viewBox="0 0 ${w} ${h}">`;
 const step=Math.max(1,(w-pad*2)/(logs.length-1||1));
 let points=logs.map((l,i)=>{
  const x=pad+i*step,y=h-pad-(l.dur/maxDur)*(h-pad*2);return`${x},${y}`;
 }).join(' ');
 svg+=`<polyline points="${points}" fill="none" stroke="var(--acc)" stroke-width="2"/>`;
 logs.forEach((l,i)=>{
  const x=pad+i*step,y=h-pad-(l.dur/maxDur)*(h-pad*2);
  svg+=`<circle cx="${x}" cy="${y}" r="3" fill="var(--acc)"/>`;
 });
 svg+=`<text x="${w-pad}" y="${h-pad}" fill="var(--txt3)" font-size="9" text-anchor="end">${fmtDur(maxDur)}</text>`;
 svg+=`</svg>`;return svg;
}

// === SETTINGS ===
function openSettings(){
 openModal(`<div class="modal-header"><h2>Settings</h2>
  <button class="modal-close" onclick="closeModal()">X</button></div>
 <div class="form-group"><label>Default Ritual Duration</label>
  <select id="setDur"><option value="60"${D.settings.duration===60?' selected':''}>1 min</option>
   <option value="120"${D.settings.duration===120?' selected':''}>2 min</option>
   <option value="180"${D.settings.duration===180?' selected':''}>3 min</option>
   <option value="300"${D.settings.duration===300?' selected':''}>5 min</option></select></div>
 <div class="form-group"><label>Advancement Threshold (%)</label>
  <input type="number" id="setThresh" value="${D.settings.threshold}" min="50" max="100"></div>
 <div class="form-group"><label>Eval Sessions (rolling avg)</label>
  <input type="number" id="setEval" value="${D.settings.evalSessions}" min="1" max="10"></div>
 <div class="form-group"><label>Sound</label>
  <div class="chip-group"><div class="chip${D.settings.soundEnabled?' active':''}" onclick="toggleChip(this)" id="setSound">On</div>
   <div class="chip${!D.settings.soundEnabled?' active':''}" onclick="toggleChip(this)">Off</div></div></div>
 <button class="btn btn-pri btn-block mt-8" onclick="saveSettings()">Save Settings</button>
 <div class="divider"></div>
 <h3 class="mb-8">Zuzu's Profile</h3>
 <div class="form-group"><label>Name</label><input type="text" id="profName" value="${D.profile.name}"></div>
 <div class="form-group"><label>Breed</label><input type="text" id="profBreed" value="${D.profile.breed}"></div>
 <div class="form-group"><label>Weight (kg)</label><input type="number" id="profWeight" value="${D.profile.weight}" step="0.1"></div>
 <div class="form-group"><label>Rescue Date</label><input type="date" id="profRescue" value="${D.profile.rescueDate}"></div>
 <button class="btn btn-sec btn-block" onclick="saveProfile()">Save Profile</button>
 <div class="divider"></div>
 <h3 class="mb-8">Zuzu's Palate</h3>
 <div class="form-group"><label>Kibble</label><input type="text" id="foodKibble" value="${D.foodNotes.kibble}"></div>
 <div class="form-group"><label>High-Value Treats</label><input type="text" id="foodHigh" value="${(D.foodNotes.highValueTreats||[]).join(', ')}" placeholder="Comma separated"></div>
 <div class="form-group"><label>Medium-Value Treats</label><input type="text" id="foodMed" value="${(D.foodNotes.medValueTreats||[]).join(', ')}"></div>
 <div class="form-group"><label>Low-Value Treats</label><input type="text" id="foodLow" value="${(D.foodNotes.lowValueTreats||[]).join(', ')}"></div>
 <div class="form-group"><label>Allergies</label><input type="text" id="foodAllergy" value="${(D.foodNotes.allergies||[]).join(', ')}"></div>
 <button class="btn btn-sec btn-block" onclick="saveFoodNotes()">Save Palate</button>
 <div class="divider"></div>
 <h3 class="mb-8">Data</h3>
 <div style="display:flex;gap:8px">
  <button class="btn btn-ghost" style="flex:1" onclick="exportData()">Export JSON</button>
  <button class="btn btn-ghost" style="flex:1" onclick="$('#importFile').click()">Import JSON</button>
 </div>
 <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
 <div class="divider"></div>
 <h3 class="mb-8">Cloud Sync (GitHub Gist)</h3>
 <div id="syncSettingsArea"></div>
 <div class="divider"></div>
 <button class="btn btn-bad btn-block mt-12 btn-sm" onclick="if(confirm('Erase ALL data?')){localStorage.removeItem(STORE_KEY);location.reload();}">Reset All Data</button>`);
 setTimeout(renderSyncSettings,50);
}

function saveSettings(){
 D.settings.duration=parseInt($('#setDur').value);
 D.settings.threshold=parseInt($('#setThresh').value);
 D.settings.evalSessions=parseInt($('#setEval').value);
 D.settings.soundEnabled=$('#setSound').classList.contains('active');
 save();toast('Settings saved');closeModal();
}

function saveProfile(){
 D.profile.name=$('#profName').value||'Zuzu';
 D.profile.breed=$('#profBreed').value;
 D.profile.weight=parseFloat($('#profWeight').value)||8.5;
 D.profile.rescueDate=$('#profRescue').value;
 save();toast('Profile saved');
}

function saveFoodNotes(){
 const split=v=>(v||'').split(',').map(s=>s.trim()).filter(Boolean);
 D.foodNotes.kibble=$('#foodKibble').value;
 D.foodNotes.highValueTreats=split($('#foodHigh').value);
 D.foodNotes.medValueTreats=split($('#foodMed').value);
 D.foodNotes.lowValueTreats=split($('#foodLow').value);
 D.foodNotes.allergies=split($('#foodAllergy').value);
 save();toast('Palate saved');
}

function exportData(){
 const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
 const a=document.createElement('a');a.href=URL.createObjectURL(blob);
 a.download='pazuzu-backup-'+today()+'.json';a.click();
 localStorage.setItem('pazuzu_lastExport',Date.now().toString());
 toast('Data exported');
}

function importData(input){
 const file=input.files[0];if(!file)return;
 const reader=new FileReader();
 reader.onload=e=>{
  try{
   const data=JSON.parse(e.target.result);
   if(!data.progress||!data.sessions){toast('Invalid backup file');return;}
   D=data;ensureFields();save();toast('Data imported');closeModal();renderTab(activeTab);
  }catch(err){toast('Error reading file');}
 };
 reader.readAsText(file);input.value='';
}

// === GIST SYNC ===
const GIST_TOKEN_KEY='pazuzu_gist_token';
const GIST_ID_KEY='pazuzu_gist_id';
let gistSyncTimeout=null;
let lastGistSync=0;

function getGistToken(){return localStorage.getItem(GIST_TOKEN_KEY)||'';}
function getGistId(){return localStorage.getItem(GIST_ID_KEY)||'';}
function setGistToken(t){localStorage.setItem(GIST_TOKEN_KEY,t);}
function setGistId(id){localStorage.setItem(GIST_ID_KEY,id);}

function queueGistSync(){
 if(!getGistToken())return;
 if(gistSyncTimeout)clearTimeout(gistSyncTimeout);
 gistSyncTimeout=setTimeout(()=>pushToGist(),5000);
}

async function pushToGist(){
 const token=getGistToken();if(!token)return;
 const gistId=getGistId();
 const payload={description:'Pazuzu Wards backup',public:false,
  files:{'pazuzu-data.json':{content:JSON.stringify(D,null,2)}}};
 try{
  let res;
  if(gistId){
   res=await fetch('https://api.github.com/gists/'+gistId,{
    method:'PATCH',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
    body:JSON.stringify(payload)});
  }else{
   res=await fetch('https://api.github.com/gists',{
    method:'POST',headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
    body:JSON.stringify(payload)});
  }
  if(!res.ok){
   if(res.status===404&&gistId){
    // Gist was deleted, create new one
    localStorage.removeItem(GIST_ID_KEY);return pushToGist();
   }
   console.error('Gist sync failed:',res.status);return;
  }
  const data=await res.json();
  if(!gistId&&data.id)setGistId(data.id);
  lastGistSync=Date.now();
  updateSyncIndicator();
 }catch(e){console.error('Gist sync error:',e);}
}

async function pullFromGist(){
 const token=getGistToken(),gistId=getGistId();
 if(!token||!gistId)return false;
 try{
  const res=await fetch('https://api.github.com/gists/'+gistId,{
   headers:{'Authorization':'Bearer '+token}});
  if(!res.ok)return false;
  const data=await res.json();
  const file=data.files['pazuzu-data.json'];
  if(!file)return false;
  const remote=JSON.parse(file.content);
  // Use whichever is newer
  if(remote._lastModified&&(!D._lastModified||remote._lastModified>D._lastModified)){
   D=remote;ensureFields();localStorage.setItem(STORE_KEY,JSON.stringify(D));
   toast('Synced from cloud');renderTab(activeTab);return true;
  }
  return false;
 }catch(e){console.error('Gist pull error:',e);return false;}
}

function updateSyncIndicator(){
 const el=$('#syncStatus');
 if(!el)return;
 if(!getGistToken()){el.textContent='Not configured';el.style.color='var(--txt3)';return;}
 if(lastGistSync){
  const ago=Math.floor((Date.now()-lastGistSync)/1000);
  el.textContent=ago<60?'Synced just now':'Synced '+Math.floor(ago/60)+'m ago';
  el.style.color='var(--ok)';
 }else{el.textContent='Waiting...';el.style.color='var(--txt2)';}
}

async function testGistConnection(){
 const token=$('#gistToken').value.trim();
 if(!token){toast('Enter a token first');return;}
 try{
  const res=await fetch('https://api.github.com/user',{headers:{'Authorization':'Bearer '+token}});
  if(res.ok){
   const user=await res.json();
   setGistToken(token);
   toast('Connected as '+user.login);
   // Try to push immediately
   await pushToGist();
   renderSyncSettings();
  }else{toast('Token invalid ('+res.status+')');}
 }catch(e){toast('Connection failed');}
}

function disconnectGist(){
 localStorage.removeItem(GIST_TOKEN_KEY);
 localStorage.removeItem(GIST_ID_KEY);
 lastGistSync=0;
 toast('Disconnected');
 renderSyncSettings();
}

function renderSyncSettings(){
 const el=$('#syncSettingsArea');if(!el)return;
 const token=getGistToken();
 if(token){
  el.innerHTML=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
   <div style="width:8px;height:8px;border-radius:50%;background:var(--ok)"></div>
   <span style="font-size:0.85rem;color:var(--ok)">Connected</span>
   <span id="syncStatus" style="font-size:0.75rem;color:var(--txt2);margin-left:auto"></span></div>
   <div style="font-size:0.75rem;color:var(--txt3);margin-bottom:8px">Gist ID: ${getGistId()||'creating...'}</div>
   <div style="display:flex;gap:8px">
    <button class="btn btn-sec btn-sm" style="flex:1" onclick="pushToGist().then(()=>toast('Pushed'))">Push Now</button>
    <button class="btn btn-sec btn-sm" style="flex:1" onclick="pullFromGist().then(ok=>toast(ok?'Pulled':'Already up to date'))">Pull Now</button>
   </div>
   <button class="btn btn-ghost btn-sm btn-block mt-8" style="color:var(--bad);border-color:var(--bad)" onclick="disconnectGist()">Disconnect</button>`;
  updateSyncIndicator();
 }else{
  el.innerHTML=`<div style="font-size:0.8rem;color:var(--txt2);margin-bottom:8px">
   Sync your data to a private GitHub Gist. Create a token at
   <span style="color:var(--acc)">github.com/settings/tokens</span> with "gist" scope.</div>
   <div class="form-group"><label>Personal Access Token</label>
    <input type="password" id="gistToken" placeholder="ghp_..."></div>
   <button class="btn btn-pri btn-block btn-sm" onclick="testGistConnection()">Connect</button>`;
 }
}

// === INIT ===
async function init(){
 load();renderTab('shrine');
 if(D.aloneTimerState&&D.aloneTimerState.running)resumeAloneTimer();
 // Try pulling fresh data from Gist
 if(getGistToken()&&getGistId())await pullFromGist();
 setInterval(()=>{if(D.aloneTimerState&&D.aloneTimerState.running)save();},30000);
 document.addEventListener('visibilitychange',()=>{
  if(D.aloneTimerState&&D.aloneTimerState.running)save();
  if(!document.hidden&&D.aloneTimerState&&D.aloneTimerState.running)resumeAloneTimer();
  if(!document.hidden&&getGistToken()&&getGistId())pullFromGist();
 });
 window.addEventListener('beforeunload',()=>{if(D.aloneTimerState&&D.aloneTimerState.running)save();});
}
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
