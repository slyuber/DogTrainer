<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#0A0A0F">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Pazuzu's Wards</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icons/icon-192.svg">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=DM+Sans:ital,wght@0,400;0,500;0,700&display=swap" rel="stylesheet">
<style>
:root{
  --pri:#D4A853;--pri-glow:rgba(212,168,83,0.20);--pri-dim:#8B7035;
  --acc:#4ECDC4;--acc-glow:rgba(78,205,196,0.15);
  --ok:#7BC67E;--warn:#E8B84B;--bad:#C75B5B;
  --bg:#0A0A0F;--card:#12121E;--card2:#1A1A2A;--input:#161625;
  --txt:#E8E4D9;--txt2:#9B9685;--txt3:#5A564A;
  --brd:#2A2A3A;
  --r:14px;--rs:10px;
  --font-d:'Cinzel',Georgia,serif;
  --font-b:'DM Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{-webkit-text-size-adjust:100%}
body{
  font-family:var(--font-b);background:var(--bg);color:var(--txt);
  min-height:100dvh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;
  -webkit-font-smoothing:antialiased;overscroll-behavior-y:contain;line-height:1.5;
}
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:0.025;
  background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
}
button{cursor:pointer;border:none;font:inherit;color:inherit;background:none;-webkit-user-select:none;user-select:none}
input,textarea{font:inherit;color:var(--txt);background:var(--input);border:1px solid var(--brd);border-radius:var(--rs);padding:11px 14px;outline:none;width:100%}
input:focus,textarea:focus{border-color:var(--pri)}
textarea{resize:vertical;min-height:56px}
h1,h2,h3{font-family:var(--font-d);font-weight:700}

/* Layout */
.app{display:flex;flex-direction:column;min-height:100dvh;max-width:430px;margin:0 auto;position:relative}
.hdr{padding:14px 18px 6px;display:flex;align-items:center;justify-content:space-between}
.hdr h1{font-size:1.1rem;color:var(--pri);letter-spacing:0.5px}
.hdr-gear{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;color:var(--txt3)}
.hdr-gear:active{color:var(--pri)}
.main{flex:1;overflow-y:auto;overflow-x:hidden;padding:6px 16px 16px;-webkit-overflow-scrolling:touch}
.pan{display:none}
.pan.on{display:block}

/* Bottom Nav */
.nav{display:flex;border-top:1px solid var(--brd);background:var(--card);padding:4px 0;padding-bottom:env(safe-area-inset-bottom)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px;color:var(--txt3);font-size:0.65rem;font-family:var(--font-b);font-weight:500;letter-spacing:0.3px;transition:color .15s}
.nav-btn.on{color:var(--pri)}
.nav-btn:active{color:var(--pri)}
.nav-btn svg{width:22px;height:22px}

/* Cards */
.cd{background:var(--card);border:1px solid var(--brd);border-radius:var(--r);padding:16px;margin-bottom:12px;position:relative}
.cd-glow{box-shadow:var(--glow-gold);border-color:var(--pri-dim)}
.cd h3{font-size:0.95rem;color:var(--pri);margin-bottom:6px}
.cd-sub{font-size:0.8rem;color:var(--txt2);line-height:1.45}

/* Buttons */
.btn-p{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--pri);color:#0A0A0F;font-weight:700;font-family:var(--font-d);padding:14px 24px;border-radius:var(--rs);font-size:0.9rem;min-height:48px;letter-spacing:0.5px;width:100%;transition:transform .1s}
.btn-p:active{transform:scale(0.97)}
.btn-s{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--card2);border:1px solid var(--brd);padding:12px 18px;border-radius:var(--rs);font-size:0.85rem;min-height:44px;color:var(--txt);font-weight:500;transition:transform .1s}
.btn-s:active{transform:scale(0.97)}
.btn-ok{background:var(--ok);color:#0A0A0F;font-weight:700;font-size:1.1rem;padding:18px;border-radius:var(--rs);min-height:56px;flex:1;transition:transform .08s}
.btn-ok:active{transform:scale(0.95)}
.btn-no{background:var(--bad);color:#fff;font-weight:700;font-size:1.1rem;padding:18px;border-radius:var(--rs);min-height:56px;flex:1;transition:transform .08s}
.btn-no:active{transform:scale(0.95)}
.btn-sm{padding:8px 14px;font-size:0.78rem;min-height:36px;border-radius:8px}
.btn-icon{width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:50%;color:var(--txt2)}
.btn-icon:active{color:var(--pri);background:var(--pri-glow)}
.btn-danger{background:var(--bad);color:#fff;font-weight:600}

/* Toggle Chips */
.tog-row{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
.tog{padding:8px 14px;border-radius:20px;font-size:0.8rem;border:1px solid var(--brd);color:var(--txt2);background:var(--card2);min-height:36px;transition:all .12s;font-weight:500}
.tog.on{border-color:var(--pri);color:var(--pri);background:var(--pri-glow)}
.tog:active{transform:scale(0.96)}
.tog-acc.on{border-color:var(--acc);color:var(--acc);background:var(--acc-glow)}

/* Skill Icon Badges */
.si{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-weight:700;font-size:0.75rem;color:var(--bg);flex-shrink:0;letter-spacing:0.5px}
.si-1{background:var(--pri)}
.si-2{background:var(--acc)}
.si-3{background:var(--ok)}
.si-locked{background:var(--txt3);opacity:0.5}
.si-mastered{background:var(--pri);box-shadow:0 0 12px rgba(212,168,83,0.4)}

/* Ward Tree */
.tree-wrap{position:relative;width:100%;min-height:480px;margin:8px 0}
.tree-svg{position:absolute;inset:0;pointer-events:none}
.tree-node{position:absolute;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-weight:700;font-size:0.7rem;cursor:pointer;transition:all .15s;z-index:2;border:2px solid var(--brd)}
.tree-node.locked{background:var(--card);color:var(--txt3);opacity:0.5;border-color:var(--txt3)}
.tree-node.available{background:var(--card2);color:var(--pri);border-color:var(--pri-dim);animation:pulse 2s infinite}
.tree-node.active{background:var(--pri-glow);color:var(--pri);border-color:var(--pri)}
.tree-node.mastered{background:var(--pri);color:var(--bg);border-color:var(--pri);box-shadow:0 0 16px rgba(212,168,83,0.35)}
.tree-node:active{transform:scale(0.92)}
.tree-label{position:absolute;top:52px;left:50%;transform:translateX(-50%);font-size:0.55rem;color:var(--txt3);white-space:nowrap;text-align:center;font-family:var(--font-b);font-weight:500;pointer-events:none}
.tree-phase{font-family:var(--font-d);font-size:0.75rem;color:var(--pri-dim);margin:4px 0;letter-spacing:1px}

/* Guidance Box */
.guide-box{background:var(--card2);border:1px solid var(--brd);border-radius:var(--rs);padding:12px;margin:10px 0}
.guide-row{display:flex;gap:8px;align-items:flex-start;margin:4px 0;font-size:0.8rem;color:var(--txt2)}
.guide-icon{color:var(--acc);font-weight:700;min-width:20px;font-size:0.75rem}

/* Session UI */
.sess-timer{font-family:var(--font-d);font-size:2.8rem;text-align:center;color:var(--pri);padding:16px 0;letter-spacing:2px}
.sess-btns{display:flex;gap:12px;margin:12px 0}
.sess-count{text-align:center;font-size:0.85rem;color:var(--txt2);margin:8px 0}
.sess-rate{font-family:var(--font-d);font-size:1.4rem;color:var(--pri);text-align:center}

/* Progress Bar */
.pbar{height:6px;background:var(--card2);border-radius:3px;overflow:hidden;margin:6px 0}
.pbar-fill{height:100%;border-radius:3px;transition:width .3s}
.pbar-pri .pbar-fill{background:var(--pri)}
.pbar-ok .pbar-fill{background:var(--ok)}

/* Section Headers */
.sec-h{font-family:var(--font-d);font-size:0.85rem;color:var(--pri-dim);letter-spacing:1.5px;text-transform:uppercase;margin:18px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--brd)}
.sec-h::before{content:'';display:inline-block;width:16px;height:1px;background:var(--pri-dim);margin-right:8px;vertical-align:middle}

/* Quick Action Grid */
.qa-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
.qa-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);font-size:0.75rem;color:var(--txt2);min-height:72px;transition:transform .1s;font-weight:500}
.qa-btn:active{transform:scale(0.96);border-color:var(--pri-dim)}
.qa-btn svg{width:24px;height:24px;color:var(--pri)}

/* Heatmap */
.hm-wrap{overflow-x:auto;padding:4px 0;margin:8px 0}
.hm-grid{display:flex;gap:3px}
.hm-col{display:flex;flex-direction:column;gap:3px}
.hm-cell{width:14px;height:14px;border-radius:3px;background:var(--card2)}
.hm-1{background:rgba(212,168,83,0.2)}
.hm-2{background:rgba(212,168,83,0.4)}
.hm-3{background:rgba(212,168,83,0.65)}
.hm-4{background:var(--pri)}

/* Modal */
.modal-wrap{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;display:flex;align-items:flex-end;justify-content:center;padding:16px}
.modal{background:var(--card);border:1px solid var(--brd);border-radius:var(--r) var(--r) 0 0;padding:24px 20px;width:100%;max-width:430px;max-height:85vh;overflow-y:auto}
.modal h2{font-family:var(--font-d);font-size:1rem;color:var(--pri);margin-bottom:12px}
.modal-btns{display:flex;gap:10px;margin-top:16px}
.modal-btns .btn-p,.modal-btns .btn-s{flex:1}

/* Slide-up Detail Sheet */
.sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;max-height:85vh;background:var(--card);border:1px solid var(--brd);border-radius:var(--r) var(--r) 0 0;padding:24px 20px;overflow-y:auto;z-index:90;animation:slideUp .25s ease-out}
.sheet-close{position:absolute;top:12px;right:12px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;color:var(--txt3);font-size:1.2rem}
.sheet-close:active{color:var(--pri)}
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:89}

/* Overlay (Settings) */
.overlay{position:fixed;inset:0;background:var(--bg);z-index:80;overflow-y:auto;padding:20px 16px;max-width:430px;margin:0 auto}
.overlay .hdr{padding:0 0 12px}

/* Toast */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--card2);color:var(--txt);border:1px solid var(--pri-dim);padding:12px 20px;border-radius:var(--rs);font-size:0.85rem;opacity:0;transition:all .3s;z-index:110;pointer-events:none;max-width:360px;text-align:center;font-family:var(--font-b)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Countdown Overlay */
.countdown-wrap{position:fixed;inset:0;background:rgba(10,10,15,0.95);z-index:120;display:flex;align-items:center;justify-content:center}
.countdown-num{font-family:var(--font-d);font-size:6rem;color:var(--pri);animation:countPop .6s ease-out}

/* Alone Timer Pill */
.alone-pill{position:fixed;top:8px;left:50%;transform:translateX(-50%);background:var(--bad);color:#fff;padding:6px 16px;border-radius:20px;font-size:0.78rem;font-weight:700;z-index:70;display:flex;align-items:center;gap:8px;cursor:pointer;font-family:var(--font-b)}
.alone-pill::before{content:'';width:8px;height:8px;border-radius:50%;background:#fff;animation:blink 1s infinite}
.alone-pill:active{transform:translateX(-50%) scale(0.96)}

/* Step List */
.step-list{margin:8px 0}
.step-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd);align-items:flex-start;cursor:pointer}
.step-item:last-child{border-bottom:none}
.step-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;flex-shrink:0;border:2px solid var(--brd);color:var(--txt3);font-family:var(--font-d)}
.step-num.done{background:var(--pri);color:var(--bg);border-color:var(--pri)}
.step-num.current{border-color:var(--pri);color:var(--pri)}
.step-info{flex:1;min-width:0}
.step-info h4{font-size:0.82rem;font-weight:600;margin-bottom:2px}
.step-info p{font-size:0.75rem;color:var(--txt2);line-height:1.4}
.step-item:active{background:var(--card2);border-radius:var(--rs)}

/* Skill Row (for lists) */
.sk-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);margin-bottom:8px;cursor:pointer;transition:transform .1s}
.sk-row:active{transform:scale(0.98)}
.sk-info{flex:1;min-width:0}
.sk-info h4{font-size:0.85rem;font-weight:600;margin-bottom:2px}
.sk-info p{font-size:0.72rem;color:var(--txt2)}
.sk-prereq{font-size:0.7rem;color:var(--bad);margin-top:2px}

/* Vigil (streak) display */
.vigil{display:flex;align-items:center;gap:8px;font-family:var(--font-d);font-size:1.4rem;color:var(--pri);margin:8px 0}
.vigil-flame{width:28px;height:28px;color:var(--warn)}

/* Stat pills */
.stats{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.stat{background:var(--card);border:1px solid var(--brd);border-radius:var(--rs);padding:10px 14px;flex:1;min-width:80px;text-align:center}
.stat-val{font-family:var(--font-d);font-size:1.3rem;color:var(--pri)}
.stat-lbl{font-size:0.68rem;color:var(--txt3);margin-top:2px}

/* Form labels */
.lbl{font-size:0.78rem;color:var(--txt2);margin:12px 0 4px;font-weight:500}
.lbl:first-child{margin-top:0}

/* Log entries */
.log-entry{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--brd);align-items:flex-start}
.log-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.7rem;font-weight:700;font-family:var(--font-d)}
.log-body{flex:1;min-width:0}
.log-body h4{font-size:0.8rem;font-weight:600;margin-bottom:2px}
.log-body p{font-size:0.72rem;color:var(--txt2)}
.log-time{font-size:0.68rem;color:var(--txt3);flex-shrink:0}

/* Animations */
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 var(--pri-glow)}50%{box-shadow:0 0 12px 4px var(--pri-glow)}}
@keyframes slideUp{from{transform:translateX(-50%) translateY(100%)}to{transform:translateX(-50%) translateY(0)}}
@keyframes countPop{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes glowPulse{0%,100%{box-shadow:0 0 8px rgba(212,168,83,0.2)}50%{box-shadow:0 0 24px rgba(212,168,83,0.4)}}

.hide{display:none!important}
.anim-in{animation:fadeIn .25s ease-out}
</style>
</head>
<body>
<div class="app">

<div id="alonePill" class="alone-pill hide" onclick="showAloneForm()">
  <span id="alonePillTime">00:00</span> alone
</div>

<header class="hdr">
  <h1>Pazuzu's Wards</h1>
  <button class="hdr-gear" onclick="toggleSettings()" aria-label="Settings">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.32 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>
</header>

<main class="main">
  <section id="pShrine" class="pan on"></section>
  <section id="pTree" class="pan"></section>
  <section id="pRitual" class="pan"></section>
  <section id="pChron" class="pan"></section>
  <section id="pProg" class="pan"></section>
</main>

<nav class="nav">
  <button class="nav-btn on" data-tab="shrine" onclick="go('shrine')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 20h18M5 16h14M7 12h10M9 8h6M11 4h2"/></svg>
    Shrine
  </button>
  <button class="nav-btn" data-tab="tree" onclick="go('tree')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L3 7v6c0 5 4 9 9 11 5-2 9-6 9-11V7l-9-5z"/></svg>
    Wards
  </button>
  <button class="nav-btn" data-tab="ritual" onclick="go('ritual')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2c-2 4-6 7-6 12a6 6 0 0012 0c0-5-4-8-6-12z"/></svg>
    Ritual
  </button>
  <button class="nav-btn" data-tab="chron" onclick="go('chron')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="3" width="16" height="18" rx="1"/><path d="M8 7h8M8 11h8M8 15h5"/></svg>
    Chronicle
  </button>
  <button class="nav-btn" data-tab="prog" onclick="go('prog')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 20h4v-6h4v-4h4v-2h4v-4h2"/></svg>
    Progress
  </button>
</nav>
</div>

<div id="settingsPanel" class="overlay hide"></div>
<div id="modal" class="modal-wrap hide" onclick="if(event.target===this)closeModal()"></div>
<div id="toast" class="toast"></div>
<div id="countdown" class="countdown-wrap hide"></div>
<div id="sheetBg" class="sheet-bg hide" onclick="closeSheet()"></div>
<div id="sheet" class="sheet hide"></div>

<script>
'use strict';

/* ============================================================
   SKILLS DATABASE — All 20 Wards
   ============================================================ */
const SKILLS=[
// ── CIRCLE I: FOUNDATION WARDS ──
{id:'attention',name:'Attention Ward',abbr:'AT',phase:1,prereqs:[],
 desc:'Teaching Zuzu to offer eye contact voluntarily — the foundation of all communication.',
 video:'https://www.youtube.com/results?search_query=kikopup+eye+contact+training',
 steps:[
  {t:'Capture Eye Contact',d:'Wait for Zuzu to glance at your eyes. Mark and treat instantly. No cue yet — reward natural glances toward your face.',
   guidance:{vocal:'Mark "yes" the instant eyes meet yours',hand:'Hands still — no luring',position:'Facing Zuzu, relaxed posture'},
   capture:{type:'observe',successLabel:'Looked',missLabel:null,notes_prompt:'How quickly did she offer eye contact? Duration of glances?'}},
  {t:'Build Duration',d:'Gradually wait for longer eye contact before marking. Start 1 second, build to 3. If she breaks, just wait — never prompt.',
   guidance:{vocal:'Delay the "yes" marker slightly each session',hand:'No hand motion',position:'Facing, 2-3 feet away'},
   capture:{type:'duration',successLabel:'Held gaze',missLabel:'Broke early',notes_prompt:'Longest hold? Average duration?'}},
  {t:'Mild Distractions',d:'Practice with toy on floor or person nearby. Mark eye contact despite distraction. Keep to 2-3 min sessions.',
   guidance:{vocal:'"Yes" when she chooses you over distraction',hand:'None — let her choose',position:'Near distraction source'},
   capture:{type:'reps',successLabel:'Chose me',missLabel:'Distracted',notes_prompt:'What distractions? How did she handle them?'}},
  {t:'Add Verbal Cue',d:'Say "watch me" just BEFORE she looks. Pair word with the behavior she already knows.',
   guidance:{vocal:'"Watch me" then mark "yes" when she looks',hand:'Brief point to eyes if needed, then fade',position:'Various distances'},
   capture:{type:'reps',successLabel:'Responded',missLabel:'No response',notes_prompt:'Latency? Responds without hand signal?'}},
  {t:'Proof Everywhere',d:'Practice in different rooms, outdoors on leash, near other dogs at distance. Accept shorter duration in new contexts.',
   guidance:{vocal:'"Watch me" cue',hand:'None needed',position:'New environments'},
   capture:{type:'reps',successLabel:'Responded',missLabel:'Too distracted',notes_prompt:'Environment? Distance from distractions?'}}
]},
{id:'interrupter',name:'Positive Interrupter',abbr:'PI',phase:1,prereqs:[],
 desc:'A special sound that means "stop what you\'re doing and come get something amazing."',
 video:'https://www.youtube.com/results?search_query=kikopup+positive+interrupter',
 steps:[
  {t:'Charge the Sound',d:'Make a unique sound (kissy noise) then immediately give HIGH-VALUE treat. Repeat 15-20 times. She doesn\'t need to do anything yet.',
   guidance:{vocal:'Kissy noise (or chosen sound) then immediate treat',hand:'Deliver treat right after sound',position:'Any — she can be doing anything'},
   capture:{type:'observe',successLabel:'Pair done',missLabel:null,notes_prompt:'Sound chosen? How many pairings? Any head turn yet?'}},
  {t:'Test Response',d:'When mildly distracted, make the sound. She should whip her head toward you. If not, charge more.',
   guidance:{vocal:'Interrupter when mildly distracted',hand:'Treat ready',position:'Within a few feet'},
   capture:{type:'reps',successLabel:'Head whip',missLabel:'No response',notes_prompt:'Response speed? Distraction level?'}},
  {t:'Use with Distractions',d:'Practice when sniffing, looking away. Sound then mark and treat. Never use over threshold (too scared/excited).',
   guidance:{vocal:'Interrupter then "yes" then jackpot treat',hand:'None',position:'Various distances'},
   capture:{type:'reps',successLabel:'Interrupted',missLabel:'Over threshold',notes_prompt:'Distraction level? Response time?'}},
  {t:'Increase Difficulty',d:'Use around harder distractions. Always reward generously — this is a jackpot sound. Never overuse.',
   guidance:{vocal:'Same sound — must ALWAYS predict amazing reward',hand:'Jackpot treats (multiple high-value)',position:'Real-world scenarios'},
   capture:{type:'reps',successLabel:'Jackpot response',missLabel:'Weak/no response',notes_prompt:'Hardest distraction she responded to?'}}
]},
{id:'nomugging',name:'Impulse Control',abbr:'IC',phase:1,prereqs:[],
 desc:'Teaching Zuzu that self-control earns rewards — the It\'s Yer Choice foundation.',
 video:'https://www.youtube.com/results?search_query=kikopup+its+yer+choice+impulse+control',
 steps:[
  {t:'Closed Fist',d:'Hold treat in closed fist. She\'ll nose, paw, lick. Wait. The moment she backs off or looks away, mark and treat from OTHER hand.',
   guidance:{vocal:'"Yes" when she backs off',hand:'Closed fist with treat — reward from OTHER hand',position:'Sitting in front of Zuzu'},
   capture:{type:'reps',successLabel:'Backed off',missLabel:'Still mugging',notes_prompt:'Time to first back-off? Getting faster?'}},
  {t:'Open Hand',d:'Open hand with treat near floor. Cover if she lunges. Mark and reward from other hand when she disengages.',
   guidance:{vocal:'"Yes" on disengage',hand:'Open palm — cover quickly if she goes for it',position:'Hand low, kneeling'},
   capture:{type:'reps',successLabel:'Showed restraint',missLabel:'Went for it',notes_prompt:'Open hand duration? Fastest disengage?'}},
  {t:'Treat on Floor',d:'Place treat on floor, cover if she goes for it. Mark and reward from other hand. Build to uncovered treat.',
   guidance:{vocal:'"Yes" when she chooses not to take it',hand:'Ready to cover — reward from other hand',position:'Kneeling beside treat'},
   capture:{type:'reps',successLabel:'Left it',missLabel:'Grabbed it',notes_prompt:'Covered or uncovered? Duration of restraint?'}},
  {t:'Around Food',d:'Build duration around visible food. Practice near plate, low tables, food prep. Reward the choice to ignore.',
   guidance:{vocal:'"Yes" for ignoring food',hand:'Treat ready as reward',position:'Near real food situations'},
   capture:{type:'reps',successLabel:'Ignored food',missLabel:'Went for it',notes_prompt:'What food? How close? How long?'}}
]},
{id:'calmness',name:'Capturing Calmness',abbr:'CC',phase:1,prereqs:[],
 desc:'Rewarding calm states throughout the day — Zuzu learns relaxation pays.',
 video:'https://www.youtube.com/results?search_query=kikopup+capturing+calmness',
 steps:[
  {t:'Reward Calm Moments',d:'When Zuzu naturally lies down or settles, gently mark and toss treat. No cue, no prompting — reinforcing a state of being.',
   guidance:{vocal:'Quiet, calm "yes"',hand:'Gently toss or place treat — no excitement',position:'Wherever she settles'},
   capture:{type:'observe',successLabel:'Calm captured',missLabel:null,notes_prompt:'Where did she settle? How long calm before mark?'}},
  {t:'On a Mat',d:'When she settles on her mat, calmly reward. Drop several treats one at a time while she stays. Deliver slowly and quietly.',
   guidance:{vocal:'Very quiet marker or none',hand:'Slow, calm treat delivery',position:'Near her mat, calm energy'},
   capture:{type:'duration',successLabel:'Settled on mat',missLabel:'Got up',notes_prompt:'Duration on mat? Stay after last treat?'}},
  {t:'Build Duration',d:'Space out rewards while she stays relaxed. If she gets up, no correction — just reward the next calm settle.',
   guidance:{vocal:'Minimal — quiet presence',hand:'Increasingly spaced treats',position:'Gradually increase distance from mat'},
   capture:{type:'duration',successLabel:'Stayed settled',missLabel:'Got up',notes_prompt:'Longest duration between treats?'}},
  {t:'Exciting Contexts',d:'Mat settling when visitors arrive, new rooms, activity. Lower criteria in harder contexts.',
   guidance:{vocal:'Calm marker when she chooses mat',hand:'Higher value treats in harder contexts',position:'Mat in exciting environments'},
   capture:{type:'reps',successLabel:'Settled despite activity',missLabel:'Too excited',notes_prompt:'What was happening? Distance from trigger?'}}
]},
{id:'crate',name:'Crate Training',abbr:'CR',phase:1,prereqs:[],
 desc:'Making the crate a safe den — never punishment. Zuzu should walk in voluntarily.',
 video:'https://www.youtube.com/results?search_query=kikopup+crate+training',
 steps:[
  {t:'Crate Discovery',d:'Toss treats near then into crate. Door stays OPEN. No luring or pushing. End on a good note if hesitant.',
   guidance:{vocal:'None — let curiosity drive',hand:'Toss treats near, then just inside',position:'Sitting near crate, relaxed'},
   capture:{type:'observe',successLabel:'Approached/entered',missLabel:null,notes_prompt:'How close? Body language?'}},
  {t:'Meals Inside',d:'Feed meals inside with door open. Enter willingly. If not, place bowl closer to opening and move further in over sessions.',
   guidance:{vocal:'None',hand:'Bowl progressively further inside',position:'Near crate, not blocking exit'},
   capture:{type:'observe',successLabel:'Ate inside',missLabel:null,notes_prompt:'How far inside? Relaxed or rushed?'}},
  {t:'Brief Door Closure',d:'While eating inside, gently close door. Open BEFORE she finishes. Gradually extend. Stay nearby.',
   guidance:{vocal:'None — calm presence',hand:'Close gently, treat through bars',position:'Right next to crate'},
   capture:{type:'duration',successLabel:'Calm with door closed',missLabel:'Stressed',notes_prompt:'Duration closed? Any stress signals?'}},
  {t:'Short Separations',d:'Close door, step away 10 seconds, return calmly, treat, then open. Build slowly. Never punish with crate.',
   guidance:{vocal:'Calm "good girl" through bars',hand:'Treat through bars on return',position:'Step away, then out of sight'},
   capture:{type:'duration',successLabel:'Calm while away',missLabel:'Distressed',notes_prompt:'Distance? Duration? Any whining?'}},
  {t:'Extended Duration',d:'Build to 30+ min with you in another room. Leave Kong or safe chew. Keep departures/arrivals boring.',
   guidance:{vocal:'Low-key goodbye and hello',hand:'Provide enrichment',position:'Different room — out of sight'},
   capture:{type:'duration',successLabel:'Settled full duration',missLabel:'Stressed early',notes_prompt:'Total minutes? Enrichment used? Vocalization?'}}
]},
{id:'house',name:'House Training',abbr:'HT',phase:1,prereqs:[],
 desc:'Building reliable potty routine with reward-based outdoor elimination.',
 video:'https://www.youtube.com/results?search_query=kikopup+house+training+puppy',
 steps:[
  {t:'Frequent Outings',d:'Every 1-2 hours, after meals/naps/play. Same spot. Wait quietly. When she goes, mark and treat party.',
   guidance:{vocal:'"Yes! Good girl!" — big celebration',hand:'Treat party — multiple treats',position:'Same potty spot, standing quietly'},
   capture:{type:'observe',successLabel:'Went outside',missLabel:null,notes_prompt:'Time since last outing? After meal/nap/play?'}},
  {t:'Learn Her Signals',d:'Watch for sniffing, circling, going to door. Take out immediately. Reward every outdoor success.',
   guidance:{vocal:'Praise outdoor success',hand:'Treat every success',position:'Observing from nearby'},
   capture:{type:'reps',successLabel:'Signalled + success',missLabel:'Accident',notes_prompt:'What signal? How quickly did you respond?'}},
  {t:'Extend Intervals',d:'Gradually increase time between outings. Continue rewarding outdoor. If accidents, just clean up — no punishment.',
   guidance:{vocal:'Continue praising',hand:'Continue treating',position:'Normal routine'},
   capture:{type:'reps',successLabel:'Held it',missLabel:'Accident',notes_prompt:'Hours between outings? Time of day patterns?'}},
  {t:'Full Freedom',d:'Gradually give access to more rooms. Occasional treats for going outside maintain the habit.',
   guidance:{vocal:'Intermittent praise',hand:'Occasional treat',position:'Full house access'},
   capture:{type:'observe',successLabel:'Reliable day',missLabel:null,notes_prompt:'Rooms? Any regression? Days since accident?'}}
]},

// ── CIRCLE II: CORE WARDS ──
{id:'name',name:'Name Recognition',abbr:'NR',phase:2,prereqs:[],
 desc:'Zuzu\'s name should predict wonderful things — never used for scolding.',
 video:'https://www.youtube.com/results?search_query=kikopup+name+recognition+dog',
 steps:[
  {t:'Name = Treat',d:'Say "Zuzu" in a happy tone, then immediately treat. No response needed yet — just building the association.',
   guidance:{vocal:'Say "Zuzu" clearly then treat',hand:'Deliver treat after name',position:'Any'},
   capture:{type:'observe',successLabel:'Pair done',missLabel:null,notes_prompt:'How many pairings? Any orientation toward you?'}},
  {t:'Name Orientation',d:'Say "Zuzu" when she\'s mildly distracted. Mark and treat when she looks toward you.',
   guidance:{vocal:'"Zuzu" then "yes" when she looks',hand:'Treat ready',position:'Within a few feet'},
   capture:{type:'reps',successLabel:'Looked',missLabel:'No response',notes_prompt:'Response speed? Distraction level?'}},
  {t:'Distance',d:'Say her name from across the room. Mark and reward any orientation toward you.',
   guidance:{vocal:'"Zuzu" from distance',hand:'Show treat or toss toward her',position:'Across the room'},
   capture:{type:'reps',successLabel:'Oriented',missLabel:'Ignored',notes_prompt:'Distance? Room?'}},
  {t:'Busy Environments',d:'Use name outdoors and in distracting environments. Reward generously for responses.',
   guidance:{vocal:'"Zuzu" — happy, clear tone',hand:'High-value treat',position:'Various environments'},
   capture:{type:'reps',successLabel:'Responded',missLabel:'Too distracted',notes_prompt:'Environment? Distraction level?'}}
]},
{id:'recall',name:'Recall',abbr:'RC',phase:2,prereqs:['attention'],
 desc:'Coming when called — a safety behavior. NEVER call to end fun or to punish.',
 video:'https://www.youtube.com/results?search_query=kikopup+recall+come+when+called',
 steps:[
  {t:'Restrained Recall',d:'Partner holds Zuzu. You call excitedly and run away. Partner releases. Big party when she reaches you.',
   guidance:{vocal:'"Zuzu, come!" — excited, high pitch',hand:'Open arms, crouch down',position:'Running away from her'},
   capture:{type:'reps',successLabel:'Came running',missLabel:'Hesitated',notes_prompt:'Speed? Enthusiasm? Distance?'}},
  {t:'Surprise Recalls',d:'Call unexpectedly in the house. Jackpot reward every time. Make coming to you the best thing ever.',
   guidance:{vocal:'"Zuzu, come!" — enthusiastic',hand:'Treat party on arrival',position:'Different rooms'},
   capture:{type:'reps',successLabel:'Came',missLabel:'Ignored',notes_prompt:'Response time? What was she doing?'}},
  {t:'Long Line Outdoors',d:'Use 15-30 foot line. Call, reward. Never reel her in — let her choose to come. If she doesn\'t, try again closer.',
   guidance:{vocal:'Same excited recall cue',hand:'Show treat, crouch',position:'Outdoors, long line'},
   capture:{type:'reps',successLabel:'Came',missLabel:'No response',notes_prompt:'Distance? Distractions?'}},
  {t:'Around Distractions',d:'Recall near other dogs (at distance), people, squirrels. Start far from distractions, decrease distance over time.',
   guidance:{vocal:'Recall cue — may need higher pitch',hand:'Highest value treats',position:'Distance from distractions'},
   capture:{type:'reps',successLabel:'Came despite distraction',missLabel:'Stayed with distraction',notes_prompt:'What distraction? Distance?'}},
  {t:'Proof Reliability',d:'Various environments, distances, distractions. Continue rewarding recalls for life — this is a safety behavior.',
   guidance:{vocal:'Standard recall cue',hand:'Always reward',position:'Anywhere'},
   capture:{type:'reps',successLabel:'Reliable recall',missLabel:'Missed',notes_prompt:'Environment? Toughest scenario?'}}
]},
{id:'sit',name:'Sit',abbr:'SI',phase:2,prereqs:[],
 desc:'A basic position cue. Can be lured or captured from natural sits.',
 video:'https://www.youtube.com/results?search_query=kikopup+teach+sit',
 steps:[
  {t:'Lure or Capture',d:'Arc treat slowly over her head — her butt goes down naturally. Or capture natural sits. Mark the instant she sits.',
   guidance:{vocal:'"Yes" the instant butt hits floor',hand:'Arc treat from nose upward over head',position:'Standing in front'},
   capture:{type:'reps',successLabel:'Sat',missLabel:'Missed',notes_prompt:'Lured or captured? Speed?'}},
  {t:'Add Verbal Cue',d:'Say "sit" just BEFORE she sits (when you\'re confident she will). Word predicts the action.',
   guidance:{vocal:'Say "sit" THEN lure/wait',hand:'Fade lure to smaller motion',position:'In front'},
   capture:{type:'reps',successLabel:'Sat on cue',missLabel:'Needed lure',notes_prompt:'Verbal only or still needs hand?'}},
  {t:'Any Position',d:'Cue from standing, sitting, different angles. She should respond regardless of your body position.',
   guidance:{vocal:'"Sit" from various postures',hand:'No hand signal',position:'Various angles and postures'},
   capture:{type:'reps',successLabel:'Sat',missLabel:'Confused',notes_prompt:'Your position? Her starting position?'}},
  {t:'Add Duration',d:'Gradually delay the mark after she sits. Build to 10-30 second sit-stays.',
   guidance:{vocal:'"Sit" then delay "yes"',hand:'Palm-out stay signal optional',position:'In front, gradually step back'},
   capture:{type:'duration',successLabel:'Held sit',missLabel:'Broke early',notes_prompt:'Duration held? Any fidgeting?'}},
  {t:'Add Distractions',d:'Sit around food, toys, people, outdoors. Lower duration criteria in new contexts.',
   guidance:{vocal:'"Sit" in distracting environments',hand:'None',position:'Various environments'},
   capture:{type:'reps',successLabel:'Sat despite distraction',missLabel:'Couldn\'t hold',notes_prompt:'What distraction? Duration achieved?'}}
]},
{id:'release',name:'Release Cue',abbr:'RE',phase:2,prereqs:['sit'],
 desc:'A word that means "you\'re done, you can move now." Essential for all stay behaviors.',
 video:'https://www.youtube.com/results?search_query=kikopup+release+cue+dog',
 steps:[
  {t:'Pair the Word',d:'After a brief sit, say "free!" and toss treat so she must move to get it. Word = permission to move.',
   guidance:{vocal:'"Free!" (or "break!") then toss treat',hand:'Toss treat away so she moves',position:'In front after sit'},
   capture:{type:'reps',successLabel:'Moved on cue',missLabel:'Stayed confused',notes_prompt:'Does she move immediately on "free"?'}},
  {t:'Before She Breaks',d:'Release BEFORE she would break the sit on her own. She learns the word, not just impatience.',
   guidance:{vocal:'"Free!" before fidgeting starts',hand:'Toss treat or gesture to go',position:'In front'},
   capture:{type:'reps',successLabel:'Clean release',missLabel:'Broke before cue',notes_prompt:'Timing? Did she wait for the word?'}},
  {t:'Vary the Reward',d:'Sometimes treat, sometimes "go play," sometimes freedom to sniff. Release = good things.',
   guidance:{vocal:'"Free!" with different rewards following',hand:'Various — treat, point to toy, gesture',position:'Various situations'},
   capture:{type:'reps',successLabel:'Responded to release',missLabel:'Confused',notes_prompt:'What reward followed? Did she understand?'}},
  {t:'Use with Everything',d:'Apply release cue after sit, down, wait at door, etc. It becomes the universal "you\'re done" signal.',
   guidance:{vocal:'"Free!" after any stay behavior',hand:'Consistent release motion',position:'Any situation requiring a stay'},
   capture:{type:'reps',successLabel:'Reliable release',missLabel:'Needed help',notes_prompt:'Context used? How well did she generalize?'}}
]},
{id:'down',name:'Down',abbr:'DN',phase:2,prereqs:['sit'],
 desc:'Lying down on cue — useful for settling and stay behaviors.',
 video:'https://www.youtube.com/results?search_query=kikopup+teach+down+lie+down',
 steps:[
  {t:'Lure from Sit',d:'From sit, slowly lower treat between front paws to floor. Mark the instant elbows touch ground.',
   guidance:{vocal:'"Yes" when elbows hit floor',hand:'Lower treat from nose straight down between paws',position:'In front, kneeling'},
   capture:{type:'reps',successLabel:'Downed',missLabel:'Stood up',notes_prompt:'Full down or just a crouch? Speed?'}},
  {t:'Lure from Standing',d:'Lure down without sitting first. Lower treat to floor slowly. Mark full down.',
   guidance:{vocal:'"Yes" on full down',hand:'Treat from nose to floor',position:'In front'},
   capture:{type:'reps',successLabel:'Down from stand',missLabel:'Sat instead',notes_prompt:'Does she go straight to down?'}},
  {t:'Add Verbal Cue',d:'Say "down" before luring. Gradually fade the hand motion. Word becomes the primary cue.',
   guidance:{vocal:'"Down" then lure then "yes"',hand:'Fade lure to smaller motion',position:'In front'},
   capture:{type:'reps',successLabel:'Down on cue',missLabel:'Needed full lure',notes_prompt:'Verbal only or hand needed?'}},
  {t:'Build Duration',d:'Delay mark after she lies down. Build to 30-second down-stay.',
   guidance:{vocal:'"Down" then delay "yes"',hand:'None',position:'Gradually increase distance'},
   capture:{type:'duration',successLabel:'Held down',missLabel:'Got up',notes_prompt:'Duration? Relaxed or tense?'}},
  {t:'Various Surfaces',d:'Practice down on grass, concrete, mat, carpet. Dogs may hesitate on cold/wet/unfamiliar surfaces.',
   guidance:{vocal:'"Down" on various surfaces',hand:'May need lure on new surfaces',position:'Various locations'},
   capture:{type:'reps',successLabel:'Downed on surface',missLabel:'Refused',notes_prompt:'What surface? Any hesitation?'}}
]},
{id:'leaveit',name:'Leave It',abbr:'LI',phase:2,prereqs:['nomugging'],
 desc:'Don\'t touch it in the first place. The item is NEVER the reward — always reward from other hand.',
 video:'https://www.youtube.com/results?search_query=kikopup+leave+it',
 steps:[
  {t:'Two-Treat Method',d:'Show treat in one hand, close fist. When she disengages, reward from OTHER hand. The shown treat is never given.',
   guidance:{vocal:'"Yes" when she looks away from closed fist',hand:'Closed fist one hand, reward from other',position:'In front'},
   capture:{type:'reps',successLabel:'Left it',missLabel:'Went for it',notes_prompt:'Speed of disengage?'}},
  {t:'Add the Cue',d:'Say "leave it" before presenting the item. Then mark and reward disengage from other hand.',
   guidance:{vocal:'"Leave it" then present item then "yes"',hand:'Same two-hand method',position:'In front'},
   capture:{type:'reps',successLabel:'Left on cue',missLabel:'Went for it',notes_prompt:'Responds to verbal? Latency?'}},
  {t:'Floor Items',d:'Place items on floor, cover if she goes for them. Mark and reward from other hand for ignoring.',
   guidance:{vocal:'"Leave it" before floor item',hand:'Ready to cover, reward from pocket/other hand',position:'Kneeling near item'},
   capture:{type:'reps',successLabel:'Ignored floor item',missLabel:'Went for it',notes_prompt:'What item? Covered or open?'}},
  {t:'On Walks',d:'Use "leave it" for things on ground during walks. Reward from treat pouch for moving past.',
   guidance:{vocal:'"Leave it" for sidewalk items',hand:'Treat from pouch',position:'Walking past items'},
   capture:{type:'reps',successLabel:'Left it on walk',missLabel:'Grabbed/fixated',notes_prompt:'What item? How quickly did she respond?'}},
  {t:'High-Value Items',d:'Leave it with very tempting items. Always reward with something BETTER than what she left.',
   guidance:{vocal:'"Leave it" for high-value items',hand:'Jackpot from other hand',position:'Various'},
   capture:{type:'reps',successLabel:'Left high-value item',missLabel:'Couldn\'t resist',notes_prompt:'What item? Treat value used as reward?'}}
]},
{id:'dropit',name:'Drop It',abbr:'DI',phase:2,prereqs:[],
 desc:'Release what\'s in your mouth. Always trade UP, always give the toy BACK.',
 video:'https://www.youtube.com/results?search_query=kikopup+drop+it+trade',
 steps:[
  {t:'Trade Game',d:'When she has a toy, offer high-value treat near her nose. She drops toy to eat. Give treat then give toy BACK.',
   guidance:{vocal:'No cue yet — just trade',hand:'Treat near nose, return toy after',position:'Near her with toy'},
   capture:{type:'reps',successLabel:'Dropped for trade',missLabel:'Held on',notes_prompt:'What toy? Trade willingness?'}},
  {t:'Add Cue',d:'Say "drop it" just before offering the trade. Pair the word with the action.',
   guidance:{vocal:'"Drop it" then present treat',hand:'Treat near nose, return toy',position:'Near her'},
   capture:{type:'reps',successLabel:'Dropped on cue',missLabel:'Needed trade prompt',notes_prompt:'Responds to verbal? Speed?'}},
  {t:'Various Objects',d:'Practice with different toys, sticks, found items. Always trade UP in value. Always return safe items.',
   guidance:{vocal:'"Drop it"',hand:'High-value trade',position:'Various'},
   capture:{type:'reps',successLabel:'Dropped novel item',missLabel:'Held on',notes_prompt:'What object? Trade difficulty?'}},
  {t:'Quick Response',d:'Build speed of response. She should spit it out immediately on cue. Continue trading for life.',
   guidance:{vocal:'"Drop it" — expect fast response',hand:'Immediate reward',position:'Any situation'},
   capture:{type:'reps',successLabel:'Quick drop',missLabel:'Slow/no response',notes_prompt:'Response time? Context?'}}
]},

// ── CIRCLE III: LIFE WARDS ──
{id:'leashpressure',name:'Leash Pressure Yields',abbr:'LP',phase:3,prereqs:['attention'],
 desc:'Teaching Zuzu that leash tension means turn toward handler, not pull harder.',
 video:'https://www.youtube.com/results?search_query=kikopup+leash+pressure+yields',
 steps:[
  {t:'Collar Touch',d:'Touch her collar, treat. Build comfort with collar handling before adding any leash work.',
   guidance:{vocal:'Quiet "yes" on collar touch',hand:'Touch collar gently then treat',position:'Beside her'},
   capture:{type:'observe',successLabel:'Accepted touch',missLabel:null,notes_prompt:'Body language during collar touch?'}},
  {t:'Light Pressure',d:'With leash on, apply very slight tension. The instant she turns toward you or steps toward you, mark and treat.',
   guidance:{vocal:'"Yes" the instant she yields toward you',hand:'Gentle leash tension — never jerk',position:'Facing her, few feet away'},
   capture:{type:'reps',successLabel:'Yielded',missLabel:'Pulled against',notes_prompt:'Amount of pressure? Speed of yield?'}},
  {t:'Following Pressure',d:'Walk slowly, let leash go taut. When she checks in, mark and treat. Build habit of yielding.',
   guidance:{vocal:'"Yes" for checking in',hand:'Reward at your side',position:'Walking slowly indoors'},
   capture:{type:'reps',successLabel:'Followed pressure',missLabel:'Pulled',notes_prompt:'Indoors? How many check-ins?'}},
  {t:'Direction Changes',d:'Change direction. When she follows the leash pressure to come with you, mark and treat.',
   guidance:{vocal:'"Yes" for direction change follow',hand:'Treat at your side after turn',position:'Walking, changing directions'},
   capture:{type:'reps',successLabel:'Followed change',missLabel:'Kept going',notes_prompt:'How many direction changes? Response speed?'}}
]},
{id:'llwindoor',name:'LLW Indoor',abbr:'LW',phase:3,prereqs:['leashpressure','attention'],
 desc:'Loose leash walking must be reliable indoors before going outside.',
 video:'https://www.youtube.com/results?search_query=kikopup+loose+leash+walking+indoor',
 steps:[
  {t:'Heel Position Reward',d:'Stand still. When she\'s at your side with loose leash, mark and treat. She learns position = reward.',
   guidance:{vocal:'"Yes" for being at your side',hand:'Treat at your side/hip level',position:'Standing still'},
   capture:{type:'reps',successLabel:'At heel',missLabel:'Pulled away',notes_prompt:'How quickly does she offer heel position?'}},
  {t:'First Steps',d:'Take 2-3 steps. If leash stays loose, mark and treat. If she pulls, stop and wait for slack.',
   guidance:{vocal:'"Yes" for loose leash steps',hand:'Treat at hip level',position:'Walking slowly'},
   capture:{type:'reps',successLabel:'Loose leash steps',missLabel:'Pulled',notes_prompt:'How many steps before pulling?'}},
  {t:'Hallway Walking',d:'Walk down a hallway. Stop when she pulls, reward loose leash. Build to whole hallway without pulling.',
   guidance:{vocal:'Mark loose leash moments',hand:'Frequent treats at side',position:'Hallway'},
   capture:{type:'reps',successLabel:'Hallway stretch',missLabel:'Pulled',notes_prompt:'Furthest distance without pull?'}},
  {t:'Through Rooms',d:'Navigate house with turns. Reward following. Build to walking through multiple rooms on loose leash.',
   guidance:{vocal:'Mark turns and check-ins',hand:'Treat at side',position:'Through house'},
   capture:{type:'duration',successLabel:'Room-to-room success',missLabel:'Pulled on turn',notes_prompt:'How many rooms? Toughest transition?'}},
  {t:'Duration',d:'Longer indoor walks without pulling. Ready for outdoor when reliably loose indoors.',
   guidance:{vocal:'Intermittent markers',hand:'Variable treat delivery',position:'Throughout house'},
   capture:{type:'duration',successLabel:'Extended loose leash',missLabel:'Reverted to pulling',notes_prompt:'Duration? Ready for outdoor?'}}
]},
{id:'llwoutdoor',name:'LLW Outdoor',abbr:'LO',phase:3,prereqs:['llwindoor','interrupter'],
 desc:'Outdoor loose leash walking — the real challenge. Start in boring environments.',
 video:'https://www.youtube.com/results?search_query=kikopup+loose+leash+walking+outdoor',
 steps:[
  {t:'Low-Distraction Outdoor',d:'Quiet area, short walks. Reward loose leash constantly. Use interrupter for fixation. Keep it positive.',
   guidance:{vocal:'Frequent "yes" for loose leash',hand:'Treat every few steps initially',position:'Quiet street or yard'},
   capture:{type:'reps',successLabel:'Loose leash stretch',missLabel:'Pulled',notes_prompt:'Location? Treat frequency?'}},
  {t:'Moderate Distractions',d:'Neighborhood walks. Stop for pulls, reward loose leash. Use positive interrupter for sniff fixation.',
   guidance:{vocal:'Mark loose leash, use interrupter for fixation',hand:'High-value treats',position:'Neighborhood'},
   capture:{type:'reps',successLabel:'Walked past distraction',missLabel:'Fixated/pulled',notes_prompt:'Distractions encountered?'}},
  {t:'High Distractions',d:'Near parks, other dogs at distance. Allow sniffing (it\'s enrichment) but reward check-ins and loose leash.',
   guidance:{vocal:'Mark check-ins near distractions',hand:'Highest value treats',position:'Near but not at parks/dogs'},
   capture:{type:'reps',successLabel:'Loose leash near dogs',missLabel:'Over threshold',notes_prompt:'Closest distance to distraction?'}},
  {t:'Long Walks',d:'Full-length walks with mostly loose leash. Intermittent reward to maintain. Sniff breaks are OK and encouraged.',
   guidance:{vocal:'Intermittent markers',hand:'Variable reward schedule',position:'Regular walking routes'},
   capture:{type:'duration',successLabel:'Loose walk duration',missLabel:'Needed many corrections',notes_prompt:'Walk duration? Pulling frequency?'}}
]},
{id:'fetch',name:'Fetch',abbr:'FE',phase:3,prereqs:['dropit'],
 desc:'Retrieve and return — builds on drop it. Chase is the reward.',
 video:'https://www.youtube.com/results?search_query=kikopup+teach+fetch',
 steps:[
  {t:'Chase the Toy',d:'Toss toy short distance. Let her chase. If she picks it up, celebrate. No "bring it back" pressure yet.',
   guidance:{vocal:'Excited voice when she chases',hand:'Short toss, show excitement',position:'Open room or yard'},
   capture:{type:'observe',successLabel:'Chased it',missLabel:null,notes_prompt:'Interest level? Picked it up?'}},
  {t:'Bring It Back',d:'When she has the toy, make yourself interesting. Crouch, call her, show treat. Reward any return movement.',
   guidance:{vocal:'Excited recall, "bring it!"',hand:'Show treat, crouch, open arms',position:'Near her, make yourself the party'},
   capture:{type:'reps',successLabel:'Brought it back',missLabel:'Kept it / ran off',notes_prompt:'How close did she bring it?'}},
  {t:'Drop and Throw',d:'Use "drop it" cue, then immediately throw again. The throw IS the reward. She learns drop = more fetch.',
   guidance:{vocal:'"Drop it" then immediate throw',hand:'Take toy, throw again fast',position:'Open area'},
   capture:{type:'reps',successLabel:'Drop + return cycle',missLabel:'Didn\'t drop',notes_prompt:'How many cycles? Enthusiasm?'}},
  {t:'Distance',d:'Longer throws, consistent return. She should reliably chase, grab, return, and drop for another throw.',
   guidance:{vocal:'"Drop it" then "ready?" then throw',hand:'Longer tosses',position:'Yard or park'},
   capture:{type:'reps',successLabel:'Full fetch cycle',missLabel:'Incomplete',notes_prompt:'Distance? Consecutive successful fetches?'}}
]},
{id:'handling',name:'Handling & Grooming',abbr:'HG',phase:3,prereqs:['calmness'],
 desc:'Cooperative care — touch = treat. Uses Bucket Game. If she moves away, LET HER.',
 video:'https://www.youtube.com/results?search_query=kikopup+cooperative+care+handling',
 steps:[
  {t:'Touch = Treat',d:'Brief gentle touch anywhere on body, immediately treat. Start with shoulders and back (least sensitive).',
   guidance:{vocal:'Quiet "yes" on touch acceptance',hand:'Brief touch then treat',position:'Beside her, relaxed'},
   capture:{type:'observe',successLabel:'Accepted touch',missLabel:null,notes_prompt:'Body part touched? Body language?'}},
  {t:'Extended Touch',d:'Longer touch, ears, paws, mouth area. If she moves away, STOP. Let her choose to return.',
   guidance:{vocal:'Quiet marker, calm tone',hand:'Longer touch, various body parts',position:'Beside her on mat'},
   capture:{type:'duration',successLabel:'Tolerated handling',missLabel:'Moved away',notes_prompt:'Body part? Duration? Any stress signals?'}},
  {t:'Introduce Tools',d:'Show brush, nail clipper near her. Treat for looking at them. Touch tool to body briefly + treat. Never force.',
   guidance:{vocal:'Calm marker when she\'s relaxed with tool',hand:'Show tool, touch briefly to body',position:'On mat, at her pace'},
   capture:{type:'reps',successLabel:'Calm with tool',missLabel:'Moved away from tool',notes_prompt:'Which tool? How close? Duration of acceptance?'}},
  {t:'Full Grooming Session',d:'Complete grooming at her pace. Take breaks. Use Bucket Game for consent. She can end the session anytime.',
   guidance:{vocal:'Calm continuous reinforcement',hand:'Gentle grooming with frequent treats',position:'Comfortable position for both'},
   capture:{type:'duration',successLabel:'Completed grooming',missLabel:'Ended early (that\'s OK)',notes_prompt:'What grooming done? Duration? Stress level?'}}
]},
{id:'separation',name:'Separation Training',abbr:'ST',phase:3,prereqs:['crate','calmness'],
 desc:'Graduated departures. First 15 minutes is hardest. Film to watch for stress signals.',
 video:'https://www.youtube.com/results?search_query=kikopup+separation+anxiety+training',
 steps:[
  {t:'Departure Cue Desensitization',d:'Pick up keys, put on shoes, then sit down. Don\'t leave. Desensitize the cues that predict departure.',
   guidance:{vocal:'None — act normally',hand:'Handle departure items casually',position:'Moving around house normally'},
   capture:{type:'observe',successLabel:'Practiced cues',missLabel:null,notes_prompt:'Which cues practiced? Her reaction?'}},
  {t:'Brief Departures',d:'Leave room 10 seconds, return boring. No dramatic hello. Treat calmly. Build to 1-2 minutes.',
   guidance:{vocal:'Low-key departure and return',hand:'Treat calmly on return',position:'Out of sight briefly'},
   capture:{type:'duration',successLabel:'Calm while gone',missLabel:'Vocalized/stressed',notes_prompt:'Duration? Any vocalization?'}},
  {t:'Longer Departures',d:'Build to 5 minutes out of sight. Leave enrichment. Returns are BORING — save hellos for later.',
   guidance:{vocal:'Boring departure',hand:'Leave Kong/enrichment',position:'Out of house briefly'},
   capture:{type:'duration',successLabel:'Calm for duration',missLabel:'Stressed before time up',notes_prompt:'Minutes? Enrichment used? Ate it?'}},
  {t:'15-Minute Barrier',d:'The hardest barrier. Build past 15 minutes gradually. Most anxious behavior occurs in first 20-40 min.',
   guidance:{vocal:'Same boring departure',hand:'Enrichment provided',position:'Away from home'},
   capture:{type:'duration',successLabel:'Passed 15 min calm',missLabel:'Distressed within 15 min',notes_prompt:'Exact duration? Body language on return?'}},
  {t:'Extended Absence',d:'30+ minutes, then hours. Keep departures/arrivals low-key. Continue providing enrichment. Film to monitor.',
   guidance:{vocal:'Low-key departures forever',hand:'Enrichment routine',position:'Normal life absences'},
   capture:{type:'duration',successLabel:'Extended absence OK',missLabel:'Regression',notes_prompt:'Duration? Filming results? Calm level?'}}
]},
{id:'doormanners',name:'Door Manners',abbr:'DM',phase:3,prereqs:['sit','release'],
 desc:'Wait at doorways until released. Prevents bolting — a safety behavior.',
 video:'https://www.youtube.com/results?search_query=kikopup+door+manners+wait',
 steps:[
  {t:'Sit at Door',d:'Approach door, cue sit. Only reach for handle when she sits. If she stands, remove hand from handle.',
   guidance:{vocal:'"Sit" at door',hand:'Reach for handle only when sitting',position:'At closed door'},
   capture:{type:'reps',successLabel:'Sat at door',missLabel:'Broke sit',notes_prompt:'How quickly does she sit at the door?'}},
  {t:'Door Opens, Don\'t Move',d:'Open door a crack. If she moves, close it. Open wider when she stays. Close = no movement, not punishment.',
   guidance:{vocal:'No cue needed — door opening is the test',hand:'Open door slowly, close if she moves',position:'At door'},
   capture:{type:'reps',successLabel:'Stayed with door open',missLabel:'Moved toward door',notes_prompt:'How far could you open it? Duration?'}},
  {t:'Wait for Release',d:'Door fully open, she waits until "free!" before going through. Treat for waiting, release to go through.',
   guidance:{vocal:'"Free!" to release through door',hand:'None',position:'Door fully open'},
   capture:{type:'reps',successLabel:'Waited for release',missLabel:'Went through early',notes_prompt:'Duration waited? Any fidgeting?'}},
  {t:'All Doors',d:'Front door, back door, car door. Generalize the wait behavior to every doorway.',
   guidance:{vocal:'"Sit" then "free!" at all doors',hand:'Same pattern everywhere',position:'Various doorways'},
   capture:{type:'reps',successLabel:'Generalized',missLabel:'Forgot at new door',notes_prompt:'Which doors practiced? Any trouble spots?'}}
]}
];

/* ============================================================
   TREE LAYOUT — Node positions and edges
   ============================================================ */
const TREE_POS={
  attention:{x:65,y:40},interrupter:{x:190,y:40},nomugging:{x:315,y:40},
  calmness:{x:65,y:110},crate:{x:190,y:110},house:{x:315,y:110},
  name:{x:30,y:200},recall:{x:120,y:200},sit:{x:210,y:200},dropit:{x:345,y:200},
  leashpressure:{x:30,y:270},release:{x:155,y:270},down:{x:250,y:270},leaveit:{x:345,y:270},
  llwindoor:{x:30,y:350},handling:{x:140,y:350},separation:{x:250,y:350},fetch:{x:345,y:350},
  llwoutdoor:{x:30,y:430},doormanners:{x:190,y:430}
};
const TREE_EDGES=[
  ['attention','recall'],['attention','leashpressure'],
  ['interrupter','llwoutdoor'],
  ['nomugging','leaveit'],
  ['calmness','handling'],['calmness','separation'],
  ['crate','separation'],
  ['sit','release'],['sit','down'],['sit','doormanners'],
  ['release','doormanners'],
  ['dropit','fetch'],
  ['leashpressure','llwindoor'],
  ['llwindoor','llwoutdoor']
];

/* ============================================================
   INSCRIPTIONS (Milestones)
   ============================================================ */
const INSCRIPTIONS=[
  {id:'first_ritual',t:'First Ritual Performed',ic:'flame',check:s=>s.sessions.length>=1},
  {id:'ten_rituals',t:'Ten Rituals Completed',ic:'flame',check:s=>s.sessions.length>=10},
  {id:'twentyfive',t:'Twenty-Five Rituals',ic:'star',check:s=>s.sessions.length>=25},
  {id:'fifty',t:'Fifty Rituals',ic:'star',check:s=>s.sessions.length>=50},
  {id:'hundred',t:'One Hundred Rituals',ic:'crown',check:s=>s.sessions.length>=100},
  {id:'vigil_3',t:'3-Day Vigil',ic:'shield',check:s=>calcStreak(s)>=3},
  {id:'vigil_7',t:'7-Day Vigil',ic:'shield',check:s=>calcStreak(s)>=7},
  {id:'vigil_14',t:'14-Day Vigil',ic:'shield',check:s=>calcStreak(s)>=14},
  {id:'vigil_30',t:'30-Day Vigil',ic:'shield',check:s=>calcStreak(s)>=30},
  {id:'first_alone_30',t:'First 30-Minute Separation',ic:'house',check:s=>s.aloneLogs.some(a=>a.dur>=1800)},
  {id:'first_alone_60',t:'First Hour Alone',ic:'house',check:s=>s.aloneLogs.some(a=>a.dur>=3600)},
  {id:'potty_streak_7',t:'7 Days Accident-Free',ic:'leaf',check:s=>pottyStreak(s)>=7}
];

/* ============================================================
   BODY LANGUAGE SIGNALS — for tracking
   ============================================================ */
const BODY_SIGNALS=[
  'Lip licking','Yawning','Panting','Pacing','Trembling','Whale eye',
  'Tucked tail','Raised hackles','Drooling','Scratching','Hiding',
  'Clingy/velcro','Freezing','Ground sniffing','Turning away','Low posture'
];

const ENRICHMENT_TYPES=[
  'Kong','Puzzle toy','Lick mat','Snuffle mat','Scatter feed','Busy box',
  'Decompression walk','Flirt pole','Chew','Tug','Nose work','Other'
];

/* ============================================================
   DATA LAYER
   ============================================================ */
const STORE_KEY='pazuzuWards';
const OLD_KEY='zuTrainer';
const DEFAULTS={
  profile:{name:'Zuzu',weight:8.5,rescueDate:'',breed:'Chiweenie',age:'',origin:'Mexico rescue'},
  settings:{duration:180,threshold:80,evalSessions:3,treatTiers:'',soundEnabled:true,reminders:true},
  progress:{},
  sessions:[],
  milestones:[],
  pottyLogs:[],
  aloneLogs:[],
  enrichmentLogs:[],
  foodNotes:{kibble:'',highValueTreats:[],medValueTreats:[],lowValueTreats:[],dislikes:[],allergies:[],feedingSchedule:'',notes:''},
  behaviorNotes:[],
  aloneTimerState:{running:false,startTime:null,elapsed:0}
};

let D;

function load(){
  let raw=localStorage.getItem(STORE_KEY);
  if(!raw){
    // Migration from old key
    const old=localStorage.getItem(OLD_KEY);
    if(old){
      try{
        const od=JSON.parse(old);
        raw=JSON.stringify(Object.assign({},DEFAULTS,od));
        localStorage.setItem(STORE_KEY,raw);
      }catch(e){raw=null}
    }
  }
  if(raw){
    try{D=JSON.parse(raw)}catch(e){D=null}
  }
  if(!D)D={};
  // Deep merge defaults
  for(const k in DEFAULTS){
    if(!(k in D)){
      D[k]=JSON.parse(JSON.stringify(DEFAULTS[k]));
    }else if(typeof DEFAULTS[k]==='object'&&!Array.isArray(DEFAULTS[k])){
      for(const j in DEFAULTS[k]){
        if(!(j in D[k]))D[k][j]=DEFAULTS[k][j];
      }
    }
  }
  // Init skill progress
  SKILLS.forEach(sk=>{
    if(!D.progress[sk.id])D.progress[sk.id]={step:0,unlocked:false,startedAt:null,masteredAt:null};
  });
  // Unlock phase 1 and no-prereq skills
  SKILLS.forEach(sk=>{
    if(sk.phase===1||sk.prereqs.length===0)D.progress[sk.id].unlocked=true;
  });
  updateUnlocks();
  save();
}

function save(){
  localStorage.setItem(STORE_KEY,JSON.stringify(D));
}

function updateUnlocks(){
  SKILLS.forEach(sk=>{
    if(sk.prereqs.length===0||sk.phase===1){D.progress[sk.id].unlocked=true;return}
    D.progress[sk.id].unlocked=sk.prereqs.every(pid=>D.progress[pid]&&D.progress[pid].step>=1);
  });
}

/* ============================================================
   UTILITIES
   ============================================================ */
const $=id=>document.getElementById(id);

function toast(msg,dur=2500){
  const t=$('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

let modalCb=null;
function showModal(title,body,buttons){
  const m=$('modal');
  m.innerHTML=`<div class="modal"><h2>${title}</h2><div>${body}</div><div class="modal-btns">${buttons}</div></div>`;
  m.classList.remove('hide');
  m.onclick=e=>{if(e.target===m)closeModal()};
}
function closeModal(){$('modal').classList.add('hide');modalCb=null}

function confirm2(title,msg,yesText,yesCls){
  return new Promise(res=>{
    showModal(title,`<p class="cd-sub">${msg}</p>`,
      `<button class="btn-s" onclick="closeModal();window._cr(false)">Cancel</button>
       <button class="${yesCls||'btn-p'}" onclick="closeModal();window._cr(true)">${yesText||'Confirm'}</button>`);
    window._cr=res;
  });
}

function rollingAvg(skillId,step){
  const n=D.settings.evalSessions||3;
  const recent=D.sessions.filter(s=>s.sid===skillId&&s.step===step).slice(-n);
  if(recent.length===0)return -1;
  const rates=recent.map(s=>s.ok+s.no>0?s.ok/(s.ok+s.no)*100:0);
  return rates.reduce((a,b)=>a+b,0)/rates.length;
}

function calcStreak(data){
  const d=data||D;
  const days=new Set(d.sessions.map(s=>s.dt.slice(0,10)));
  let streak=0;
  const today=new Date();
  for(let i=0;i<365;i++){
    const dt=new Date(today);dt.setDate(dt.getDate()-i);
    const key=dt.toISOString().slice(0,10);
    if(days.has(key))streak++;
    else if(i>0)break;
  }
  return streak;
}

function pottyStreak(data){
  const d=data||D;
  const accidentDays=new Set(d.pottyLogs.filter(p=>p.loc==='inside').map(p=>p.dt.slice(0,10)));
  let streak=0;
  const today=new Date();
  for(let i=0;i<365;i++){
    const dt=new Date(today);dt.setDate(dt.getDate()-i);
    if(!accidentDays.has(dt.toISOString().slice(0,10)))streak++;
    else break;
  }
  return streak;
}

function dailyPlan(){
  const active=SKILLS.filter(sk=>D.progress[sk.id].unlocked&&!D.progress[sk.id].masteredAt);
  // Sort by: least recently trained, then closest to advancement
  const now=Date.now();
  active.sort((a,b)=>{
    const la=D.sessions.filter(s=>s.sid===a.id).slice(-1)[0];
    const lb=D.sessions.filter(s=>s.sid===b.id).slice(-1)[0];
    const ta=la?new Date(la.dt).getTime():0;
    const tb=lb?new Date(lb.dt).getTime():0;
    return ta-tb;
  });
  return active.slice(0,5);
}

function fmtTime(sec){
  const m=Math.floor(sec/60);const s=sec%60;
  return m+':'+(s<10?'0':'')+s;
}

function fmtDate(iso){
  if(!iso)return '';
  const d=new Date(iso);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

function fmtDateTime(iso){
  if(!iso)return '';
  const d=new Date(iso);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+
         d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}

function skillById(id){return SKILLS.find(s=>s.id===id)}

function nodeStatus(sk){
  const p=D.progress[sk.id];
  if(p.masteredAt)return 'mastered';
  if(!p.unlocked)return 'locked';
  if(p.step>0||D.sessions.some(s=>s.sid===sk.id))return 'active';
  return 'available';
}

/* Audio */
function playDing(){
  if(!D.settings.soundEnabled)return;
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const g=ctx.createGain();
    osc.connect(g);g.connect(ctx.destination);
    osc.type='sine';osc.frequency.value=880;
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.8);
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.8);
    const o2=ctx.createOscillator();const g2=ctx.createGain();
    o2.connect(g2);g2.connect(ctx.destination);
    o2.type='sine';o2.frequency.value=1318.5;
    g2.gain.setValueAtTime(0.2,ctx.currentTime+0.15);
    g2.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+1);
    o2.start(ctx.currentTime+0.15);o2.stop(ctx.currentTime+1);
  }catch(e){}
}

function vibrate(ms){try{navigator.vibrate&&navigator.vibrate(ms||200)}catch(e){}}

/* ============================================================
   NAVIGATION
   ============================================================ */
const TABS=['shrine','tree','ritual','chron','prog'];
const TAB_IDS={shrine:'pShrine',tree:'pTree',ritual:'pRitual',chron:'pChron',prog:'pProg'};
const RENDERERS={shrine:rShrine,tree:rTree,ritual:rRitual,chron:rChron,prog:rProg};
let curTab='shrine';

function go(tab){
  curTab=tab;
  TABS.forEach(t=>{
    const el=$(TAB_IDS[t]);if(el){el.classList.toggle('on',t===tab)}
    document.querySelectorAll(`.nav-btn[data-tab="${t}"]`).forEach(b=>b.classList.toggle('on',t===tab));
  });
  if(RENDERERS[tab])RENDERERS[tab]();
}

/* ============================================================
   SVG ICON HELPERS
   ============================================================ */
const ICONS={
  flame:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2c-2 4-6 7-6 12a6 6 0 0012 0c0-5-4-8-6-12z"/></svg>',
  shield:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L3 7v6c0 5 4 9 9 11 5-2 9-6 9-11V7l-9-5z"/></svg>',
  star:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1z"/></svg>',
  crown:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M4 15l4-10 4 6 4-6 4 10"/></svg>',
  house:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 10v10h14V10"/></svg>',
  leaf:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8C8 10 5.9 16.17 3.82 21.34M17 8A5 5 0 0121 3c-2.5 1-4.5 3-6 6z"/></svg>',
  circle:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>',
  pazuzu:'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L3 7v6c0 5 4 9 9 11 5-2 9-6 9-11V7l-9-5z"/></svg>',
  potty:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>',
  clock:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
  bone:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8a3 3 0 013-3 3 3 0 013 3v0a2 2 0 002 0h0a3 3 0 013-3 3 3 0 013 3 3 3 0 01-3 3 3 3 0 00-3 3v0a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3v0a2 2 0 00-2 0h0a3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3 3 3 0 003-3v0a3 3 0 01-3-3z"/></svg>',
  note:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="3" width="16" height="18" rx="1"/><path d="M8 7h8M8 11h8M8 15h5"/></svg>'
};

/* ============================================================
   ALONE TIMER PERSISTENCE
   ============================================================ */
let aloneInterval=null;

function updateAlonePill(){
  const pill=$('alonePill');
  if(!D.aloneTimerState.running){pill.classList.add('hide');return}
  pill.classList.remove('hide');
  const elapsed=Math.floor((Date.now()-D.aloneTimerState.startTime)/1000)+D.aloneTimerState.elapsed;
  $('alonePillTime').textContent=fmtTime(elapsed);
}

function startAloneTimer(){
  D.aloneTimerState={running:true,startTime:Date.now(),elapsed:0};
  save();
  aloneInterval=setInterval(()=>{updateAlonePill();if(D.aloneTimerState.running)save()},30000);
  updateAlonePill();
  // Update pill every second visually
  if(window._aloneTick)clearInterval(window._aloneTick);
  window._aloneTick=setInterval(updateAlonePill,1000);
  toast('Alone timer started');
}

function stopAloneTimer(){
  const elapsed=Math.floor((Date.now()-D.aloneTimerState.startTime)/1000)+D.aloneTimerState.elapsed;
  D.aloneTimerState={running:false,startTime:null,elapsed:0};
  save();
  if(aloneInterval)clearInterval(aloneInterval);
  if(window._aloneTick)clearInterval(window._aloneTick);
  updateAlonePill();
  return elapsed;
}

function resumeAloneTimer(){
  if(!D.aloneTimerState.running)return;
  aloneInterval=setInterval(()=>{updateAlonePill();if(D.aloneTimerState.running)save()},30000);
  if(window._aloneTick)clearInterval(window._aloneTick);
  window._aloneTick=setInterval(updateAlonePill,1000);
  updateAlonePill();
}

document.addEventListener('visibilitychange',()=>{
  if(D&&D.aloneTimerState.running)save();
});

/* ============================================================
   SHEET (Ward Detail Slide-up)
   ============================================================ */
function openSheet(skillId){
  const sk=skillById(skillId);if(!sk)return;
  const p=D.progress[sk.id];
  const status=nodeStatus(sk);
  const s=$('sheet'),bg=$('sheetBg');
  let stepsHtml=sk.steps.map((st,i)=>{
    const cls=i<p.step?'done':i===p.step?'current':'';
    return `<div class="step-item" onclick="pickStep('${sk.id}',${i})">
      <div class="step-num ${cls}">${i+1}</div>
      <div class="step-info"><h4>${st.t}</h4><p>${st.d}</p></div></div>`;
  }).join('');
  const prereqNames=sk.prereqs.map(pid=>{const ps=skillById(pid);return ps?ps.name:'?'}).join(', ');
  s.innerHTML=`<button class="sheet-close" onclick="closeSheet()">x</button>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
      <div class="si si-${sk.phase} ${status==='mastered'?'si-mastered':''}">${sk.abbr}</div>
      <div><h2 style="margin:0;font-size:1rem">${sk.name}</h2>
        <div style="font-size:0.75rem;color:var(--txt2)">Circle ${sk.phase} ${status==='mastered'?'— Ward Sealed':''}</div>
        ${sk.prereqs.length?`<div class="sk-prereq">Requires: ${prereqNames}</div>`:''}</div>
    </div>
    <p class="cd-sub" style="margin-bottom:12px">${sk.desc}</p>
    ${p.step<sk.steps.length?renderGuidance(sk.steps[p.step]):''}
    <div class="sec-h">Steps (${p.step}/${sk.steps.length})</div>
    <div class="pbar pbar-pri"><div class="pbar-fill" style="width:${p.step/sk.steps.length*100}%"></div></div>
    <div class="step-list">${stepsHtml}</div>
    <div style="display:flex;gap:10px;margin-top:16px">
      ${status!=='locked'?`<button class="btn-p" onclick="closeSheet();startTraining('${sk.id}')">Begin Ritual</button>`:''}
      <a href="${sk.video}" target="_blank" class="btn-s" style="text-decoration:none;text-align:center">Video</a>
    </div>`;
  s.classList.remove('hide');bg.classList.remove('hide');
}

function closeSheet(){$('sheet').classList.add('hide');$('sheetBg').classList.add('hide')}

function renderGuidance(step){
  if(!step.guidance)return '';
  const g=step.guidance;
  let rows='';
  if(g.vocal)rows+=`<div class="guide-row"><span class="guide-icon">V</span><span>${g.vocal}</span></div>`;
  if(g.hand)rows+=`<div class="guide-row"><span class="guide-icon">H</span><span>${g.hand}</span></div>`;
  if(g.position)rows+=`<div class="guide-row"><span class="guide-icon">P</span><span>${g.position}</span></div>`;
  return `<div class="guide-box">${rows}</div>`;
}

async function pickStep(skillId,stepIdx){
  const sk=skillById(skillId);
  const p=D.progress[sk.id];
  if(stepIdx===p.step)return;
  const dir=stepIdx>p.step?'skip ahead':'go back';
  const ok=await confirm2('Change Step',`${dir} to Step ${stepIdx+1}: "${sk.steps[stepIdx].t}"?`,'Confirm');
  if(!ok)return;
  p.step=stepIdx;
  if(!p.startedAt)p.startedAt=new Date().toISOString();
  p.masteredAt=null;
  save();updateUnlocks();openSheet(skillId);
}

/* ============================================================
   WHERE IS ZUZU? — First-time flow
   ============================================================ */
function showWhereIsZuzu(skillId,cb){
  const sk=skillById(skillId);
  let html=`<p class="cd-sub" style="margin-bottom:12px">Where is Zuzu with "${sk.name}"? Pick the step that matches her current ability.</p>
    <div class="step-list">`;
  sk.steps.forEach((st,i)=>{
    html+=`<div class="step-item" onclick="window._wizStep=${i};document.querySelectorAll('#modal .step-num').forEach((n,j)=>{n.className='step-num'+(j===${i}?' current':'')})">
      <div class="step-num${i===0?' current':''}">${i+1}</div>
      <div class="step-info"><h4>${st.t}</h4><p>${st.d}</p></div></div>`;
  });
  html+=`</div>`;
  window._wizStep=0;
  showModal('Where is Zuzu?',html,
    `<button class="btn-s" onclick="closeModal()">Cancel</button>
     <button class="btn-p" onclick="closeModal();window._wizCb(window._wizStep)">Start Here</button>`);
  window._wizCb=cb;
}

/* ============================================================
   RENDERERS
   ============================================================ */

// ── SHRINE (Home) ──
function rShrine(){
  const el=$('pShrine');
  const streak=calcStreak();
  const totalSess=D.sessions.length;
  const activeWards=SKILLS.filter(sk=>D.progress[sk.id].unlocked&&!D.progress[sk.id].masteredAt).length;
  const sealedWards=SKILLS.filter(sk=>D.progress[sk.id].masteredAt).length;
  const todayPotty=D.pottyLogs.filter(p=>p.dt.slice(0,10)===new Date().toISOString().slice(0,10)).length;
  const plan=dailyPlan();

  el.innerHTML=`
    <div class="cd cd-glow" style="text-align:center;padding:20px">
      <div style="width:64px;height:64px;border-radius:50%;border:3px solid var(--pri);margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-size:1.8rem;color:var(--pri);background:var(--pri-glow)">Z</div>
      <h3 style="font-size:1.1rem;margin-bottom:4px">${D.profile.name}</h3>
      <div class="cd-sub">${D.profile.breed||''} ${D.profile.weight?'- '+D.profile.weight+'kg':''}</div>
      ${D.profile.rescueDate?`<div style="font-size:0.7rem;color:var(--txt3);margin-top:4px">${Math.floor((Date.now()-new Date(D.profile.rescueDate).getTime())/86400000)} days since rescue</div>`:''}
    </div>

    <div class="vigil">${ICONS.flame} <span>${streak}-Day Vigil</span></div>

    <div class="stats">
      <div class="stat"><div class="stat-val">${totalSess}</div><div class="stat-lbl">Rituals</div></div>
      <div class="stat"><div class="stat-val">${activeWards}</div><div class="stat-lbl">Active</div></div>
      <div class="stat"><div class="stat-val">${sealedWards}</div><div class="stat-lbl">Sealed</div></div>
    </div>

    ${plan.length?`<div class="sec-h">The Daily Rite</div>
    ${plan.map(sk=>{
      const p=D.progress[sk.id];
      const pct=p.step/sk.steps.length*100;
      return `<div class="sk-row" onclick="openSheet('${sk.id}')">
        <div class="si si-${sk.phase}">${sk.abbr}</div>
        <div class="sk-info"><h4>${sk.name}</h4>
          <div class="pbar pbar-pri" style="width:80px"><div class="pbar-fill" style="width:${pct}%"></div></div>
          <p>Step ${p.step+1}/${sk.steps.length}</p></div>
        <button class="btn-s btn-sm" onclick="event.stopPropagation();startTraining('${sk.id}')">Train</button>
      </div>`;
    }).join('')}`:'<div class="cd"><p class="cd-sub">All wards sealed. Pazuzu\'s Shield is complete.</p></div>'}

    <div class="sec-h">Quick Actions</div>
    <div class="qa-grid">
      <button class="qa-btn" onclick="go('chron');setTimeout(showPottyForm,100)">
        ${ICONS.potty}<span>Log Potty${todayPotty?' ('+todayPotty+')':''}</span></button>
      <button class="qa-btn" onclick="${D.aloneTimerState.running?'showAloneForm()':'startAloneTimer()'}">
        ${ICONS.clock}<span>${D.aloneTimerState.running?'Alone Timer':'Start Alone'}</span></button>
      <button class="qa-btn" onclick="go('chron');setTimeout(showEnrichForm,100)">
        ${ICONS.bone}<span>Enrichment</span></button>
      <button class="qa-btn" onclick="go('chron');setTimeout(showBehaviorForm,100)">
        ${ICONS.note}<span>Behavior Note</span></button>
    </div>

    ${renderRecentActivity()}`;
}

function renderRecentActivity(){
  const items=[];
  D.sessions.slice(-3).forEach(s=>{const sk=skillById(s.sid);items.push({dt:s.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:var(--pri-glow);color:var(--pri)">${sk?sk.abbr:'??'}</div>
    <div class="log-body"><h4>${sk?sk.name:'Unknown'} Ritual</h4><p>${s.ok}/${s.ok+s.no} success${s.notes?' — '+s.notes.slice(0,40):''}</p></div>
    <div class="log-time">${fmtDateTime(s.dt)}</div></div>`})});
  D.pottyLogs.slice(-2).forEach(p=>{items.push({dt:p.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:var(--acc-glow);color:var(--acc)">PT</div>
    <div class="log-body"><h4>Potty — ${p.type}</h4><p>${p.loc} ${p.ctx?'('+p.ctx+')':''}</p></div>
    <div class="log-time">${fmtDateTime(p.dt)}</div></div>`})});
  items.sort((a,b)=>new Date(b.dt)-new Date(a.dt));
  if(!items.length)return '';
  return `<div class="sec-h">Recent</div>${items.slice(0,5).map(i=>i.html).join('')}`;
}

// ── WARD TREE ──
function rTree(){
  const el=$('pTree');
  const W=Math.min(380,window.innerWidth-32);
  const scale=W/380;
  let svgLines='';
  TREE_EDGES.forEach(([from,to])=>{
    const a=TREE_POS[from],b=TREE_POS[to];
    if(!a||!b)return;
    const fromSk=skillById(from),toSk=skillById(to);
    const fromS=nodeStatus(fromSk),toS=nodeStatus(toSk);
    const color=toS==='locked'?'var(--txt3)':fromS==='mastered'?'var(--pri)':'var(--brd)';
    svgLines+=`<line x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}" stroke="${color}" stroke-width="2" stroke-dasharray="${toS==='locked'?'4,4':'none'}"/>`;
  });
  let nodes='';
  SKILLS.forEach(sk=>{
    const pos=TREE_POS[sk.id];if(!pos)return;
    const st=nodeStatus(sk);
    const shortName=sk.name.replace('Capturing ','').replace(' Yields','').replace(' Ward','').replace('Positive ','').replace('Impulse ','').replace('Name ','').replace(' Cue','').split(' ')[0];
    nodes+=`<div class="tree-node ${st}" style="left:${pos.x-24}px;top:${pos.y-24}px" onclick="openSheet('${sk.id}')">
      ${sk.abbr}<div class="tree-label">${shortName}</div></div>`;
  });

  el.innerHTML=`
    <div class="sec-h">Circle I — Foundation</div>
    <div class="sec-h" style="margin-top:140px">Circle II — Core</div>
    <div class="sec-h" style="margin-top:140px">Circle III — Life</div>
    <div class="tree-wrap" style="min-height:480px;transform:scale(${scale});transform-origin:top left;width:${380}px">
      <svg class="tree-svg" width="380" height="480" viewBox="0 0 380 480">${svgLines}</svg>
      ${nodes}
    </div>`;
}

// ── RITUAL (Training Session) ──
let sess={active:false,skillId:null,timer:null,timeLeft:0,ok:0,no:0,paused:false,startedAt:null};

function rRitual(){
  const el=$('pRitual');
  if(sess.active)return renderActiveSession();

  const available=SKILLS.filter(sk=>D.progress[sk.id].unlocked&&!D.progress[sk.id].masteredAt);
  el.innerHTML=`
    <div class="sec-h">Begin a Ritual</div>
    <p class="cd-sub" style="margin-bottom:12px">Choose a Ward to train:</p>
    ${available.map(sk=>{
      const p=D.progress[sk.id];
      return `<div class="sk-row" onclick="startTraining('${sk.id}')">
        <div class="si si-${sk.phase}">${sk.abbr}</div>
        <div class="sk-info"><h4>${sk.name}</h4><p>Step ${p.step+1}/${sk.steps.length}: ${sk.steps[Math.min(p.step,sk.steps.length-1)].t}</p></div>
      </div>`;
    }).join('')}
    ${available.length===0?'<div class="cd"><p class="cd-sub">All wards sealed. You have completed Pazuzu\'s Shield.</p></div>':''}`;
}

function startTraining(skillId){
  const sk=skillById(skillId);
  const p=D.progress[sk.id];
  if(!p.unlocked){toast('Ward is locked — complete prerequisites first');return}
  if(p.masteredAt){toast('This Ward is already sealed');return}

  // First time? Show Where is Zuzu?
  const hasSession=D.sessions.some(s=>s.sid===skillId);
  if(!hasSession&&!p.startedAt){
    showWhereIsZuzu(skillId,(stepIdx)=>{
      p.step=stepIdx;p.startedAt=new Date().toISOString();save();
      go('ritual');showPreSession(skillId);
    });
    return;
  }
  go('ritual');showPreSession(skillId);
}

function showPreSession(skillId){
  const sk=skillById(skillId);
  const p=D.progress[sk.id];
  const step=sk.steps[Math.min(p.step,sk.steps.length-1)];
  const el=$('pRitual');

  el.innerHTML=`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
      <div class="si si-${sk.phase}">${sk.abbr}</div>
      <div><h3 style="margin:0">${sk.name}</h3><div class="cd-sub">Step ${p.step+1}: ${step.t}</div></div>
    </div>
    <div class="cd"><p class="cd-sub">${step.d}</p></div>
    ${renderGuidance(step)}
    <div class="lbl">Session Duration</div>
    <div class="tog-row" id="durToggle">
      ${[60,120,180,300].map(d=>`<button class="tog${d===D.settings.duration?' on':''}" onclick="setDur(${d})">${d/60} min</button>`).join('')}
    </div>
    <div style="margin-top:20px">
      <button class="btn-p" onclick="beginRitual('${skillId}')">Begin Ritual</button>
    </div>`;
}

function setDur(d){
  D.settings.duration=d;save();
  document.querySelectorAll('#durToggle .tog').forEach(b=>b.classList.toggle('on',parseInt(b.textContent)*60===d));
}

function beginRitual(skillId){
  sess={active:true,skillId,timer:null,timeLeft:D.settings.duration,ok:0,no:0,paused:false,startedAt:new Date().toISOString()};
  // Countdown 3-2-1
  const cd=$('countdown');cd.classList.remove('hide');
  let count=3;
  cd.innerHTML=`<div class="countdown-num">${count}</div>`;
  const ci=setInterval(()=>{
    count--;
    if(count>0){cd.innerHTML=`<div class="countdown-num">${count}</div>`}
    else{
      cd.innerHTML=`<div class="countdown-num" style="font-size:3rem">Begin!</div>`;
      setTimeout(()=>{cd.classList.add('hide');runSession()},500);
      clearInterval(ci);
    }
  },600);
}

function runSession(){
  const sk=skillById(sess.skillId);
  const p=D.progress[sk.id];
  const step=sk.steps[Math.min(p.step,sk.steps.length-1)];
  const cap=step.capture||{type:'reps',successLabel:'Success',missLabel:'Miss'};

  sess.timer=setInterval(()=>{
    if(!sess.paused){
      sess.timeLeft--;
      renderSessionTimer();
      if(sess.timeLeft<=0){endTimer()}
    }
  },1000);
  renderActiveSession();
}

function renderActiveSession(){
  const el=$('pRitual');
  const sk=skillById(sess.skillId);
  const p=D.progress[sk.id];
  const step=sk.steps[Math.min(p.step,sk.steps.length-1)];
  const cap=step.capture||{type:'reps',successLabel:'Success',missLabel:'Miss'};
  const total=sess.ok+sess.no;
  const rate=total>0?Math.round(sess.ok/total*100):0;

  let btns='';
  if(cap.type==='observe'){
    btns=`<button class="btn-ok" onclick="sessOk()" style="width:100%">${cap.successLabel}</button>`;
  }else if(cap.type==='duration'){
    btns=`<button class="btn-ok" onclick="sessOk()">${cap.successLabel}</button>
           <button class="btn-no" onclick="sessNo()">${cap.missLabel||'Broke'}</button>`;
  }else{
    btns=`<button class="btn-ok" onclick="sessOk()">${cap.successLabel}</button>
           ${cap.missLabel?`<button class="btn-no" onclick="sessNo()">${cap.missLabel}</button>`:''}`;
  }

  el.innerHTML=`
    <div style="text-align:center;margin-bottom:8px">
      <div class="cd-sub">${sk.name} — Step ${p.step+1}</div>
      <div class="sess-timer" id="sessTimerDisp">${fmtTime(sess.timeLeft)}</div>
    </div>
    <details style="margin-bottom:12px"><summary style="font-size:0.8rem;color:var(--txt2);cursor:pointer">Instructions</summary>
      <p class="cd-sub" style="margin-top:6px">${step.d}</p>
      ${renderGuidance(step)}
    </details>
    <div class="sess-btns">${btns}</div>
    <div class="sess-count">${sess.ok} success${cap.missLabel?' / '+sess.no+' miss':''} ${total>0?'('+rate+'%)':''}</div>
    <div style="display:flex;gap:10px;margin-top:20px">
      <button class="btn-s" style="flex:1" onclick="sess.paused=!sess.paused;renderActiveSession()">${sess.paused?'Resume':'Pause'}</button>
      <button class="btn-s btn-danger" style="flex:1" onclick="endSession()">End Ritual</button>
    </div>`;
}

function renderSessionTimer(){
  const d=document.getElementById('sessTimerDisp');
  if(d)d.textContent=fmtTime(sess.timeLeft);
}

function sessOk(){sess.ok++;vibrate(50);renderActiveSession()}
function sessNo(){sess.no++;vibrate([50,30,50]);renderActiveSession()}

function endTimer(){
  clearInterval(sess.timer);sess.timer=null;
  playDing();vibrate(200);
  endSession();
}

async function endSession(){
  if(sess.timer){clearInterval(sess.timer);sess.timer=null}
  const sk=skillById(sess.skillId);
  const p=D.progress[sk.id];
  const step=sk.steps[Math.min(p.step,sk.steps.length-1)];
  const dur=D.settings.duration-sess.timeLeft;

  // Show notes modal
  showModal('Ritual Complete',`
    <div class="sess-count" style="font-size:1rem;margin-bottom:12px">${sess.ok} success${step.capture?.missLabel?' / '+sess.no+' miss':''}</div>
    <div class="lbl">Notes</div>
    <textarea id="sessNotes" placeholder="${step.capture?.notes_prompt||'How did it go?'}" rows="3"></textarea>
  `,`<button class="btn-p" onclick="saveSession()">Save</button>`);
}

function saveSession(){
  const sk=skillById(sess.skillId);
  const p=D.progress[sk.id];
  const step=sk.steps[Math.min(p.step,sk.steps.length-1)];
  const notes=document.getElementById('sessNotes')?.value||'';
  const dur=D.settings.duration-sess.timeLeft;

  D.sessions.push({
    id:uid(),sid:sess.skillId,dt:sess.startedAt||new Date().toISOString(),
    step:p.step,ok:sess.ok,no:sess.no,dur,notes,
    captureType:step.capture?.type||'reps'
  });
  if(!p.startedAt)p.startedAt=new Date().toISOString();
  save();
  closeModal();
  checkAdvancement(sess.skillId);
  checkMilestones();
  sess={active:false,skillId:null,timer:null,timeLeft:0,ok:0,no:0,paused:false,startedAt:null};
  go('ritual');
}

function checkAdvancement(skillId){
  const sk=skillById(skillId);
  const p=D.progress[sk.id];
  if(p.masteredAt)return;
  const avg=rollingAvg(skillId,p.step);
  if(avg<0)return;

  if(avg>=D.settings.threshold){
    if(p.step>=sk.steps.length-1){
      // Ward sealed!
      p.masteredAt=new Date().toISOString();
      p.step=sk.steps.length;
      save();updateUnlocks();
      toast('Ward Sealed! '+sk.name+' mastered!');
      // Check if new wards unlocked
      SKILLS.forEach(s=>{
        if(s.prereqs.includes(skillId)&&D.progress[s.id].unlocked){
          toast(s.name+' is now available!');
        }
      });
    }else{
      confirm2('Advance Step',`Rolling average: ${Math.round(avg)}%. Ready to advance to Step ${p.step+2}: "${sk.steps[p.step+1].t}"?`,'Advance').then(ok=>{
        if(ok){p.step++;save();toast('Advanced to step '+(p.step+1))}
      });
    }
  }else if(avg<50&&p.step>0){
    confirm2('Consider Going Back',`Rolling average: ${Math.round(avg)}%. Consider reinforcing Step ${p.step}: "${sk.steps[p.step-1].t}"? Regression is normal and always good practice.`,'Go Back','btn-s').then(ok=>{
      if(ok){p.step--;save();toast('Moved back to step '+(p.step+1))}
    });
  }
}

function checkMilestones(){
  let newMilestones=[];
  INSCRIPTIONS.forEach(ins=>{
    if(D.milestones.some(m=>m.id===ins.id))return;
    if(ins.check(D)){
      D.milestones.push({id:ins.id,t:ins.t,ic:ins.ic,dt:new Date().toISOString()});
      newMilestones.push(ins.t);
    }
  });
  // Per-skill mastery inscriptions
  SKILLS.forEach(sk=>{
    const mid='ward_'+sk.id;
    if(D.milestones.some(m=>m.id===mid))return;
    if(D.progress[sk.id].masteredAt){
      D.milestones.push({id:mid,t:'Ward of '+sk.name+' Sealed',ic:'shield',dt:D.progress[sk.id].masteredAt});
      newMilestones.push('Ward of '+sk.name+' Sealed');
    }
  });
  if(newMilestones.length){save();toast('Inscription revealed: '+newMilestones[0])}
}

// ── CHRONICLE (Log) ──
function rChron(){
  const el=$('pChron');
  el.innerHTML=`
    <div class="sec-h">Log</div>
    <div class="qa-grid" style="margin-bottom:16px">
      <button class="qa-btn" onclick="showPottyForm()">${ICONS.potty}<span>Potty</span></button>
      <button class="qa-btn" onclick="${D.aloneTimerState.running?'showAloneForm()':'startAloneTimer()'}">
        ${ICONS.clock}<span>${D.aloneTimerState.running?'Stop Alone':'Start Alone'}</span></button>
      <button class="qa-btn" onclick="showEnrichForm()">${ICONS.bone}<span>Enrichment</span></button>
      <button class="qa-btn" onclick="showBehaviorForm()">${ICONS.note}<span>Behavior</span></button>
    </div>
    <div class="sec-h">History</div>
    <div id="chronHistory">${renderChronHistory()}</div>`;
}

function renderChronHistory(){
  const items=[];
  D.sessions.forEach(s=>{const sk=skillById(s.sid);items.push({dt:s.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:var(--pri-glow);color:var(--pri)">${sk?sk.abbr:'??'}</div>
    <div class="log-body"><h4>${sk?sk.name:''} Ritual</h4><p>Step ${s.step+1}: ${s.ok}/${s.ok+s.no} ${s.notes?'— '+s.notes.slice(0,50):''}</p></div>
    <div class="log-time">${fmtDateTime(s.dt)}</div></div>`})});
  D.pottyLogs.forEach(p=>{items.push({dt:p.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:var(--acc-glow);color:var(--acc)">PT</div>
    <div class="log-body"><h4>Potty — ${p.type||'?'}</h4><p>${p.loc||''} ${p.ctx?'('+p.ctx+')':''} ${p.surface?'on '+p.surface:''}</p></div>
    <div class="log-time">${fmtDateTime(p.dt)}</div></div>`})});
  D.aloneLogs.forEach(a=>{items.push({dt:a.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:rgba(199,91,91,0.15);color:var(--bad)">AL</div>
    <div class="log-body"><h4>Alone — ${fmtTime(a.dur)}</h4><p>${a.loc||''} ${a.calm?'Calm: '+a.calm:''}</p></div>
    <div class="log-time">${fmtDateTime(a.dt)}</div></div>`})});
  D.enrichmentLogs.forEach(e=>{items.push({dt:e.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:var(--pri-glow);color:var(--warn)">EN</div>
    <div class="log-body"><h4>Enrichment — ${e.type||'?'}</h4><p>${e.engagement?'Engagement: '+e.engagement:''} ${e.duration?e.duration+' min':''}</p></div>
    <div class="log-time">${fmtDateTime(e.dt)}</div></div>`})});
  D.behaviorNotes.forEach(b=>{items.push({dt:b.dt,html:`<div class="log-entry">
    <div class="log-icon" style="background:rgba(78,205,196,0.1);color:var(--acc)">BN</div>
    <div class="log-body"><h4>${b.category||'Behavior'}</h4><p>${b.trigger||''} — ${b.intensity||''}</p></div>
    <div class="log-time">${fmtDateTime(b.dt)}</div></div>`})});
  items.sort((a,b)=>new Date(b.dt)-new Date(a.dt));
  return items.length?items.slice(0,30).map(i=>i.html).join(''):'<p class="cd-sub">No entries yet. Start logging!</p>';
}

// ── LOG FORMS ──
function showPottyForm(){
  showModal('Log Potty',`
    <div class="lbl">Type</div>
    <div class="tog-row" id="ptType">${['Pee','Poop','Both'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Location</div>
    <div class="tog-row" id="ptLoc">${['Outside','Inside'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Context</div>
    <div class="tog-row" id="ptCtx">${['Morning','After meal','After nap','After play','Bedtime'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Surface</div>
    <div class="tog-row" id="ptSurf">${['Grass','Concrete','Gravel','Pad','Floor'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Signal Given</div>
    <div class="tog-row" id="ptSig">${['None','Sniffing','Circling','Door','Whining'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Photo</div>
    <input type="file" accept="image/*" capture="environment" id="ptPhoto" style="font-size:0.8rem">
    <div class="lbl">Notes</div>
    <textarea id="ptNotes" placeholder="Anything notable?" rows="2"></textarea>
  `,`<button class="btn-s" onclick="closeModal()">Cancel</button>
     <button class="btn-p" onclick="savePotty()">Save</button>`);
}

function savePotty(){
  const getTogVal=(id)=>{const el=document.querySelector(`#${id} .tog.on`);return el?el.textContent.toLowerCase():''};
  const entry={
    id:uid(),dt:new Date().toISOString(),
    type:getTogVal('ptType'),loc:getTogVal('ptLoc'),ctx:getTogVal('ptCtx'),
    surface:getTogVal('ptSurf'),signalGiven:getTogVal('ptSig'),
    notes:document.getElementById('ptNotes')?.value||'',photo:''
  };
  const fileInput=document.getElementById('ptPhoto');
  if(fileInput?.files?.[0]){
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const c=document.createElement('canvas');
        const max=600;let w=img.width,h=img.height;
        if(w>max||h>max){const r=Math.min(max/w,max/h);w*=r;h*=r}
        c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
        entry.photo=c.toDataURL('image/jpeg',0.7);
        D.pottyLogs.push(entry);save();closeModal();toast('Potty logged');
        if(curTab==='chron')rChron();
      };img.src=e.target.result;
    };reader.readAsDataURL(fileInput.files[0]);
  }else{
    D.pottyLogs.push(entry);save();closeModal();toast('Potty logged');
    if(curTab==='chron')rChron();
  }
}

function showAloneForm(){
  if(D.aloneTimerState.running){
    const elapsed=stopAloneTimer();
    showModal('Log Alone Time',`
      <div style="text-align:center;margin-bottom:12px"><div class="stat-val">${fmtTime(elapsed)}</div><div class="cd-sub">Duration</div></div>
      <div class="lbl">Location</div>
      <div class="tog-row" id="alLoc">${['Crate','Room','House','Yard'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Your Distance</div>
      <div class="tog-row" id="alDist">${['Door','Room','Floor','Out'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Departure Reaction</div>
      <div class="tog-row" id="alDepart">${['Calm','Noticed','Whined','Barked','Panicked'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Arrival Reaction</div>
      <div class="tog-row" id="alArrive">${['Calm','Excited','Frantic','Ignored'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Vocalization</div>
      <div class="tog-row" id="alVocal">${['None','Whining','Barking','Howling','Crying'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Body Language Signals</div>
      <div class="tog-row" id="alBody">${BODY_SIGNALS.map(s=>`<button class="tog tog-acc" onclick="togMulti(this)">${s}</button>`).join('')}</div>
      <div class="lbl">Enrichment Used</div>
      <div class="tog-row" id="alEnrich">${['None','Kong','Puzzle','Chew','Lick mat'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Ate Enrichment?</div>
      <div class="tog-row" id="alAte">${['Yes','Partially','No'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Overall Calm?</div>
      <div class="tog-row" id="alCalm">${['Yes','Mostly','No'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
      <div class="lbl">Notes</div>
      <textarea id="alNotes" placeholder="Any observations?" rows="2"></textarea>
    `,`<button class="btn-s" onclick="closeModal()">Cancel</button>
       <button class="btn-p" onclick="saveAlone(${elapsed})">Save</button>`);
  }else{
    startAloneTimer();
  }
}

function saveAlone(elapsed){
  const gv=(id)=>{const el=document.querySelector(`#${id} .tog.on`);return el?el.textContent.toLowerCase():''};
  const bodyLangs=Array.from(document.querySelectorAll('#alBody .tog.on')).map(b=>b.textContent);
  D.aloneLogs.push({
    id:uid(),dt:new Date().toISOString(),dur:elapsed,
    loc:gv('alLoc'),dist:gv('alDist'),
    departureReaction:gv('alDepart'),arrivalReaction:gv('alArrive'),
    vocalization:gv('alVocal'),bodyLanguage:bodyLangs,
    enrichmentUsed:gv('alEnrich'),ate:gv('alAte'),calm:gv('alCalm'),
    destructive:false,eliminatedInside:false,departureCuesPracticed:false,
    notes:document.getElementById('alNotes')?.value||''
  });
  save();closeModal();toast('Alone time logged');
  if(curTab==='chron')rChron();
}

function showEnrichForm(){
  showModal('Log Enrichment',`
    <div class="lbl">Type</div>
    <div class="tog-row" id="enType">${ENRICHMENT_TYPES.map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Duration (minutes)</div>
    <input type="number" id="enDur" placeholder="Minutes engaged" min="0">
    <div class="lbl">Engagement</div>
    <div class="tog-row" id="enEng">${['High','Medium','Low','Refused'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Notes</div>
    <textarea id="enNotes" placeholder="How did she interact with it?" rows="2"></textarea>
  `,`<button class="btn-s" onclick="closeModal()">Cancel</button>
     <button class="btn-p" onclick="saveEnrich()">Save</button>`);
}

function saveEnrich(){
  const gv=(id)=>{const el=document.querySelector(`#${id} .tog.on`);return el?el.textContent:''};
  D.enrichmentLogs.push({
    id:uid(),dt:new Date().toISOString(),
    type:gv('enType'),duration:parseInt(document.getElementById('enDur')?.value)||0,
    engagement:gv('enEng').toLowerCase(),notes:document.getElementById('enNotes')?.value||''
  });
  save();closeModal();toast('Enrichment logged');
  if(curTab==='chron')rChron();
}

function showBehaviorForm(){
  showModal('Log Behavior',`
    <div class="lbl">Category</div>
    <div class="tog-row" id="bhCat">${['Reactivity','Fear','Excitement','Resource guarding','Aggression','Positive social','Other'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Trigger</div>
    <input type="text" id="bhTrigger" placeholder="What caused it?">
    <div class="lbl">Intensity</div>
    <div class="tog-row" id="bhInt">${['Mild','Moderate','Severe'].map(t=>`<button class="tog" onclick="togSingle(this)">${t}</button>`).join('')}</div>
    <div class="lbl">Body Language Signals</div>
    <div class="tog-row" id="bhBody">${BODY_SIGNALS.map(s=>`<button class="tog tog-acc" onclick="togMulti(this)">${s}</button>`).join('')}</div>
    <div class="lbl">Your Response</div>
    <textarea id="bhResp" placeholder="What did you do?" rows="2"></textarea>
    <div class="lbl">Outcome</div>
    <textarea id="bhOut" placeholder="How did it resolve?" rows="2"></textarea>
  `,`<button class="btn-s" onclick="closeModal()">Cancel</button>
     <button class="btn-p" onclick="saveBehavior()">Save</button>`);
}

function saveBehavior(){
  const gv=(id)=>{const el=document.querySelector(`#${id} .tog.on`);return el?el.textContent:''};
  const bodyLangs=Array.from(document.querySelectorAll('#bhBody .tog.on')).map(b=>b.textContent);
  D.behaviorNotes.push({
    id:uid(),dt:new Date().toISOString(),
    category:gv('bhCat'),trigger:document.getElementById('bhTrigger')?.value||'',
    intensity:gv('bhInt').toLowerCase(),bodyLanguage:bodyLangs,
    response:document.getElementById('bhResp')?.value||'',
    outcome:document.getElementById('bhOut')?.value||'',notes:''
  });
  save();closeModal();toast('Behavior logged');
  if(curTab==='chron')rChron();
}

// Toggle helpers
function togSingle(el){
  el.parentElement.querySelectorAll('.tog').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
}
function togMulti(el){el.classList.toggle('on')}

// ── PROGRESS ──
function rProg(){
  const el=$('pProg');
  const streak=calcStreak();

  el.innerHTML=`
    <div class="sec-h">Activity</div>
    ${renderHeatmap()}

    <div class="sec-h">Inscriptions</div>
    ${D.milestones.length?D.milestones.slice().reverse().map(m=>`<div class="log-entry">
      <div class="log-icon" style="background:var(--pri-glow);color:var(--pri)">${ICONS[m.ic]||ICONS.shield}</div>
      <div class="log-body"><h4>${m.t}</h4></div>
      <div class="log-time">${fmtDate(m.dt)}</div></div>`).join('')
    :'<p class="cd-sub">No inscriptions yet. Complete rituals to reveal them.</p>'}

    ${D.aloneLogs.length?`<div class="sec-h">Separation Progress</div>${renderSepChart()}`:''}

    <div class="sec-h">Ward Progress</div>
    ${SKILLS.map(sk=>{
      const p=D.progress[sk.id];
      const pct=p.masteredAt?100:p.step/sk.steps.length*100;
      return `<div style="display:flex;align-items:center;gap:10px;margin:6px 0">
        <div class="si si-${sk.phase}" style="width:32px;height:32px;font-size:0.6rem">${sk.abbr}</div>
        <div style="flex:1"><div style="font-size:0.78rem;margin-bottom:2px">${sk.name}</div>
          <div class="pbar pbar-${p.masteredAt?'ok':'pri'}"><div class="pbar-fill" style="width:${pct}%"></div></div></div>
        <div style="font-size:0.7rem;color:var(--txt3)">${p.masteredAt?'Sealed':p.step+'/'+sk.steps.length}</div></div>`;
    }).join('')}`;
}

function renderHeatmap(){
  const today=new Date();
  const days=56; // 8 weeks
  const sessMap={};
  D.sessions.forEach(s=>{const k=s.dt.slice(0,10);sessMap[k]=(sessMap[k]||0)+1});
  D.pottyLogs.forEach(p=>{const k=p.dt.slice(0,10);sessMap[k]=(sessMap[k]||0)+0.3});
  D.aloneLogs.forEach(a=>{const k=a.dt.slice(0,10);sessMap[k]=(sessMap[k]||0)+0.5});

  let cols='';
  for(let w=7;w>=0;w--){
    let cells='';
    for(let d=0;d<7;d++){
      const dt=new Date(today);dt.setDate(dt.getDate()-(w*7+(6-d)));
      const k=dt.toISOString().slice(0,10);
      const v=sessMap[k]||0;
      const cls=v>=4?'hm-4':v>=2?'hm-3':v>=1?'hm-2':v>0?'hm-1':'';
      cells+=`<div class="hm-cell ${cls}" title="${k}: ${Math.round(v)} activities"></div>`;
    }
    cols+=`<div class="hm-col">${cells}</div>`;
  }
  return `<div class="hm-wrap"><div class="hm-grid">${cols}</div></div>`;
}

function renderSepChart(){
  const logs=D.aloneLogs.slice(-20);
  if(!logs.length)return '';
  const maxDur=Math.max(...logs.map(l=>l.dur),1);
  const barW=Math.max(8,Math.floor(300/logs.length)-2);
  let bars=logs.map(l=>{
    const h=Math.max(2,Math.round(l.dur/maxDur*80));
    const color=l.calm==='yes'?'var(--ok)':l.calm==='mostly'?'var(--warn)':'var(--bad)';
    return `<div style="width:${barW}px;display:flex;flex-direction:column;align-items:center;gap:2px">
      <div style="height:80px;display:flex;align-items:flex-end"><div style="width:${barW}px;height:${h}px;background:${color};border-radius:2px"></div></div>
      <div style="font-size:0.5rem;color:var(--txt3)">${fmtTime(l.dur)}</div></div>`;
  }).join('');
  return `<div style="display:flex;gap:2px;overflow-x:auto;padding:8px 0">${bars}</div>`;
}

// ── SETTINGS ──
function toggleSettings(){
  const p=$('settingsPanel');
  if(!p.classList.contains('hide')){p.classList.add('hide');return}
  p.innerHTML=`
    <div class="hdr" style="margin-bottom:8px">
      <h2 style="font-size:1rem;color:var(--pri)">Settings</h2>
      <button class="btn-icon" onclick="toggleSettings()">x</button>
    </div>

    <div class="sec-h">Zuzu's Profile</div>
    <div class="lbl">Name</div><input id="sName" value="${D.profile.name}">
    <div class="lbl">Weight (kg)</div><input id="sWeight" type="number" value="${D.profile.weight}">
    <div class="lbl">Breed</div><input id="sBreed" value="${D.profile.breed||''}">
    <div class="lbl">Rescue Date</div><input id="sRescue" type="date" value="${D.profile.rescueDate||''}">

    <div class="sec-h">Training</div>
    <div class="lbl">Default Duration</div>
    <div class="tog-row">${[60,120,180,300].map(d=>`<button class="tog${d===D.settings.duration?' on':''}" onclick="togSingle(this);D.settings.duration=${d};save()">${d/60} min</button>`).join('')}</div>
    <div class="lbl">Advancement Threshold (%)</div><input id="sThresh" type="number" value="${D.settings.threshold}" min="50" max="100">
    <div class="lbl">Evaluation Sessions</div><input id="sEval" type="number" value="${D.settings.evalSessions}" min="1" max="10">
    <div class="lbl">Sound</div>
    <div class="tog-row"><button class="tog${D.settings.soundEnabled?' on':''}" onclick="D.settings.soundEnabled=!D.settings.soundEnabled;save();togSingle(this)">Enabled</button></div>

    <div class="sec-h">Zuzu's Palate</div>
    <div class="lbl">High-Value Treats</div><input id="sHigh" value="${(D.foodNotes.highValueTreats||[]).join(', ')}" placeholder="Chicken, cheese, liver...">
    <div class="lbl">Medium-Value Treats</div><input id="sMed" value="${(D.foodNotes.medValueTreats||[]).join(', ')}" placeholder="Training treats, dried meat...">
    <div class="lbl">Low-Value Treats</div><input id="sLow" value="${(D.foodNotes.lowValueTreats||[]).join(', ')}" placeholder="Kibble, biscuits...">
    <div class="lbl">Dislikes</div><input id="sDislike" value="${(D.foodNotes.dislikes||[]).join(', ')}" placeholder="Foods she refuses...">
    <div class="lbl">Current Kibble</div><input id="sKibble" value="${D.foodNotes.kibble||''}">

    <div class="sec-h">Data</div>
    <div style="display:flex;gap:10px;margin:12px 0">
      <button class="btn-s" style="flex:1" onclick="exportData()">Export JSON</button>
      <label class="btn-s" style="flex:1;text-align:center;cursor:pointer">Import<input type="file" accept=".json" style="display:none" onchange="importData(this)"></label>
    </div>
    <button class="btn-s btn-danger" style="width:100%;margin-top:8px" onclick="resetData()">Reset All Data</button>

    <div style="margin-top:24px">
      <button class="btn-p" onclick="saveSettings()">Save Settings</button>
    </div>`;
  p.classList.remove('hide');
}

function saveSettings(){
  D.profile.name=document.getElementById('sName')?.value||'Zuzu';
  D.profile.weight=parseFloat(document.getElementById('sWeight')?.value)||8.5;
  D.profile.breed=document.getElementById('sBreed')?.value||'';
  D.profile.rescueDate=document.getElementById('sRescue')?.value||'';
  D.settings.threshold=parseInt(document.getElementById('sThresh')?.value)||80;
  D.settings.evalSessions=parseInt(document.getElementById('sEval')?.value)||3;
  // Food
  const split=v=>(v||'').split(',').map(s=>s.trim()).filter(Boolean);
  D.foodNotes.highValueTreats=split(document.getElementById('sHigh')?.value);
  D.foodNotes.medValueTreats=split(document.getElementById('sMed')?.value);
  D.foodNotes.lowValueTreats=split(document.getElementById('sLow')?.value);
  D.foodNotes.dislikes=split(document.getElementById('sDislike')?.value);
  D.foodNotes.kibble=document.getElementById('sKibble')?.value||'';
  save();toggleSettings();toast('Settings saved');go(curTab);
}

function exportData(){
  const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='pazuzu-backup-'+new Date().toISOString().slice(0,10)+'.json';
  a.click();toast('Data exported');
}

function importData(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const imported=JSON.parse(e.target.result);
      if(imported.sessions||imported.progress){
        D=Object.assign(D,imported);save();load();
        toast('Data imported');go(curTab);
      }else{toast('Invalid backup file')}
    }catch(err){toast('Error reading file')}
  };reader.readAsText(file);
}

async function resetData(){
  const ok=await confirm2('Reset All Data','This will permanently delete all training data, logs, and settings. This cannot be undone.','Reset Everything','btn-s btn-danger');
  if(!ok)return;
  localStorage.removeItem(STORE_KEY);load();
  toggleSettings();go('shrine');toast('All data reset');
}

/* ============================================================
   INIT
   ============================================================ */
load();
resumeAloneTimer();
go('shrine');

// Auto-export reminder (every 7 days)
(function(){
  const lastExport=localStorage.getItem('pazuzu_lastExportReminder');
  const now=Date.now();
  if(!lastExport||now-parseInt(lastExport)>7*86400000){
    if(D.sessions.length>0){
      setTimeout(()=>toast('Reminder: Export your data backup (Settings > Export)'),3000);
      localStorage.setItem('pazuzu_lastExportReminder',now.toString());
    }
  }
})();
</script>
</body>
</html>
